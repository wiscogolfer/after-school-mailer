<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After-School Program Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .column {
            min-height: calc(100vh - 60px); /* Full height minus header */
            max-height: calc(100vh - 60px);
            overflow-y: auto;
        }
        .header-sticky {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
        }
        /* Mobile nav */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
    </style>
</head>
<body class="h-full flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-sm p-3 flex justify-between items-center z-20">
        <h1 class="text-xl font-bold text-gray-800">After-School Manager</h1>
        <div class="flex items-center space-x-2">
            <input type="text" id="render-url" placeholder="Render Server URL" class="border rounded-md px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            <button id="save-server-config" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-medium hover:bg-blue-700">Save</button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Main container for columns -->
        <div class="flex-1 w-full flex flex-col md:flex-row md:overflow-hidden">

            <!-- Column 1: Classes -->
            <section id="classes-col" class="column w-full md:w-1/3 border-r border-gray-200 bg-white flex flex-col">
                <div class="header-sticky p-4 border-b border-gray-200">
                    <div class="flex flex-wrap justify-between items-center gap-2">
                        <h2 class="text-lg font-semibold text-gray-900">Classes</h2>
                        <button id="add-class-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm">
                            Add Class
                        </button>
                    </div>
                </div>
                <div id="class-list" class="flex-grow p-4 space-y-3">
                    <!-- Class items will be dynamically inserted here -->
                </div>
            </section>

            <!-- Column 2: Students -->
            <section id="students-col" class="column w-full md:w-1/3 border-r border-gray-200 bg-gray-50 flex-col hidden md:flex">
                <div class="header-sticky p-4 border-b border-gray-200">
                    <div class="flex flex-wrap justify-between items-center gap-2">
                        <h2 id="student-col-title" class="text-lg font-semibold text-gray-900">Students</h2>
                        <div class="flex gap-2">
                            <button id="add-new-student-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 shadow-sm disabled:bg-gray-400" disabled>
                                Add New
                            </button>
                            <button id="add-existing-student-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-700 shadow-sm disabled:bg-gray-400" disabled>
                                Add Existing
                            </button>
                        </div>
                    </div>
                </div>
                <div id="student-list" class="flex-grow p-4 space-y-3">
                    <p id="student-list-placeholder" class="text-gray-500">Select a class to see its students.</p>
                    <!-- Student items will be dynamically inserted here -->
                </div>
            </section>

            <!-- Column 3: Parents/Contacts -->
            <section id="contacts-col" class="column w-full md:w-1/3 bg-white flex-col hidden md:flex">
                <div class="header-sticky p-4 border-b border-gray-200">
                    <div class="flex flex-wrap justify-between items-center gap-2">
                        <h2 id="contact-col-title" class="text-lg font-semibold text-gray-900">Parents/Contacts</h2>
                        <button id="add-contact-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm disabled:bg-gray-400" disabled>
                            Add Contact
                        </button>
                    </div>
                </div>
                <div id="contact-list" class="flex-grow p-4 space-y-3">
                    <p id="contact-list-placeholder" class="text-gray-500">Select a student to see their contacts.</p>
                    <!-- Contact items will be dynamically inserted here -->
                </div>
            </section>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav bg-white border-t border-gray-200 flex justify-around md:hidden">
        <button id="nav-classes" class="flex-1 p-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600">Classes</button>
        <button id="nav-students" class="flex-1 p-4 text-sm font-medium text-gray-500">Students</button>
        <button id="nav-contacts" class="flex-1 p-4 text-sm font-medium text-gray-500">Contacts</button>
    </nav>

    <!-- Modal: Add Class -->
    <div id="add-class-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Class</h3>
            <form id="add-class-form">
                <div class="space-y-4">
                    <div>
                        <label for="class-name" class="block text-sm font-medium text-gray-700">Class Name</label>
                        <input type="text" id="class-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="teacher-name" class="block text-sm font-medium text-gray-700">Teacher Name</label>
                        <input type="text" id="teacher-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-add-class" class="bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="bg-blue-600 border border-transparent rounded-md shadow-sm px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">Save Class</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Add New Student -->
    <div id="add-new-student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-1">Add New Student</h3>
            <p id="add-new-student-class-name" class="text-sm text-gray-500 mb-4"></p>
            <form id="add-new-student-form">
                <div class="space-y-4">
                    <div>
                        <label for="new-student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                        <input type="text" id="new-student-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-add-new-student" class="bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="bg-blue-600 border border-transparent rounded-md shadow-sm px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">Save Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Add Existing Student -->
    <div id="add-existing-student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-1">Add Existing Student to Class</h3>
            <p id="add-existing-student-class-name" class="text-sm text-gray-500 mb-4"></p>
            <form id="add-existing-student-form">
                <div>
                    <label for="existing-student-select" class="block text-sm font-medium text-gray-700">Select Student</label>
                    <select id="existing-student-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-add-existing-student" class="bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="bg-blue-600 border border-transparent rounded-md shadow-sm px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">Add to Class</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Add Parent/Contact -->
    <div id="add-contact-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-1">Add New Contact</h3>
            <p id="add-contact-student-name" class="text-sm text-gray-500 mb-4"></p>
            <form id="add-contact-form">
                <div class="space-y-4">
                    <div>
                        <label for="contact-name" class="block text-sm font-medium text-gray-700">Contact Name</label>
                        <input type="text" id="contact-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="contact-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="contact-email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="contact-phone" class="block text-sm font-medium text-gray-700">Phone (Optional)</label>
                        <input type="tel" id="contact-phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-add-contact" class="bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="bg-blue-600 border border-transparent rounded-md shadow-sm px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">Save Contact</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Compose Email -->
    <div id="compose-email-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Compose Email</h3>
            <form id="compose-email-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">To:</label>
                        <input type="email" id="email-to" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="email-subject" class="block text-sm font-medium text-gray-700">Subject:</label>
                        <input type="text" id="email-subject" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="email-body" class="block text-sm font-medium text-gray-700">Message:</label>
                        <textarea id="email-body" rows="6" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <span id="email-status" class="text-sm text-gray-500"></span>
                    <div class="flex space-x-3">
                        <button type="button" id="cancel-compose-email" class="bg-white border border-gray-300 rounded-md shadow-sm px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" id="send-email-btn" class="bg-blue-600 border border-transparent rounded-md shadow-sm px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">Send Email</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Firebase Config -->
    <div id="firebase-config-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-[100] hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Firebase Configuration Required</h3>
            <p class="text-sm text-gray-600 mb-4">
                To use this app on a live site, please enter your Firebase project credentials.
                You can find these in your Firebase project settings (Project Overview > Project settings > General).
            </p>
            <form id="firebase-config-form">
                <div class="space-y-4">
                    <div>
                        <label for="firebase-api-key" class="block text-sm font-medium text-gray-700">API Key</label>
                        <input type="text" id="firebase-api-key" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="firebase-auth-domain" class="block text-sm font-medium text-gray-700">Auth Domain</label>
                        <input type="text" id="firebase-auth-domain" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="my-project.firebaseapp.com" required>
                    </div>
                    <div>
                        <label for="firebase-project-id" class="block text-sm font-medium text-gray-700">Project ID</label>
                        <input type="text" id="firebase-project-id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-blue-600 border border-transparent rounded-md shadow-sm px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">Save Configuration</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Global Toast Notification -->
    <div id="toast" class="fixed bottom-20 md:bottom-5 right-5 p-4 rounded-lg shadow-lg text-white z-[200] hidden">
        <span id="toast-message"></span>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center p-4 z-[999]">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-lg font-medium text-gray-700 mt-2">Connecting to database...</span>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            addDoc,
            getDocs,
            writeBatch,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State ---
        let db;
        let auth;
        let userId = null;
        let currentClassId = null;
        let currentStudentId = null;
        let allStudentsCache = []; // Cache of all students { id, name }
        let unsubscribeStudents = null; // Listener for students in a class

        // --- Collections ---
        const getClassesCol = () => collection(db, 'artifacts', appId, 'users', userId, 'classes');
        const getStudentsCol = () => collection(db, 'artifacts', appId, 'users', userId, 'students');
        const getParentsCol = () => collection(db, 'artifacts', appId, 'users', userId, 'parents');

        // --- App ID ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Toast Notification ---
        const toast = (message, type = 'success', duration = 3000) => {
            const toastEl = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');

            toastMsg.textContent = message;
            toastEl.classList.remove('hidden', 'bg-green-500', 'bg-red-500');

            if (type === 'success') {
                toastEl.classList.add('bg-green-500');
            } else {
                toastEl.classList.add('bg-red-500');
            }

            setTimeout(() => {
                toastEl.classList.add('hidden');
            }, duration);
        }

        // --- Modal Handling ---
        const openModal = (modalId) => {
            document.getElementById(modalId).classList.remove('hidden');
        }
        const closeModal = (modalId) => {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- UI Rendering ---
        const renderClassList = (classes) => {
            const listEl = document.getElementById('class-list');
            listEl.innerHTML = ''; // Clear list
            if (classes.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500">No classes added yet. Click "Add Class" to get started.</p>';
                return;
            }
            classes.forEach(cls => {
                const isSelected = cls.id === currentClassId;
                const item = document.createElement('div');
                item.className = `p-4 rounded-lg cursor-pointer flex justify-between items-center ${isSelected ? 'bg-blue-100 border border-blue-500' : 'bg-white shadow-sm border border-gray-200 hover:bg-gray-50'}`;
                item.dataset.id = cls.id;
                item.innerHTML = `
                    <div>
                        <h4 class="font-semibold text-gray-800">${cls.name}</h4>
                        <p class="text-sm text-gray-600">${cls.teacher}</p>
                    </div>
                    <button class="delete-class-btn text-red-500 hover:text-red-700 text-sm font-medium" data-id="${cls.id}" data-name="${cls.name}">Delete</button>
                `;
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-class-btn')) return;
                    selectClass(cls.id);
                });
                item.querySelector('.delete-class-btn').addEventListener('click', () => deleteClass(cls.id, cls.name));
                listEl.appendChild(item);
            });
        }

        const renderStudentList = (students) => {
            const listEl = document.getElementById('student-list');
            const placeholder = document.getElementById('student-list-placeholder');
            listEl.innerHTML = '';
            if (students.length === 0) {
                placeholder.classList.remove('hidden');
                placeholder.textContent = 'No students in this class.';
            } else {
                placeholder.classList.add('hidden');
            }

            students.forEach(student => {
                const isSelected = student.id === currentStudentId;
                const item = document.createElement('div');
                item.className = `p-4 rounded-lg cursor-pointer flex justify-between items-center ${isSelected ? 'bg-blue-100 border border-blue-500' : 'bg-white shadow-sm border border-gray-200 hover:bg-gray-50'}`;
                item.dataset.id = student.id;
                item.innerHTML = `
                    <h4 class="font-semibold text-gray-800">${student.name}</h4>
                    <button class="remove-student-btn text-red-500 hover:text-red-700 text-sm font-medium" data-id="${student.id}" data-name="${student.name}">Remove</button>
                `;
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-student-btn')) return;
                    selectStudent(student.id);
                });
                item.querySelector('.remove-student-btn').addEventListener('click', () => removeStudentFromClass(student.id, student.name));
                listEl.appendChild(item);
            });
        }

        const renderContactList = (contacts) => {
            const listEl = document.getElementById('contact-list');
            const placeholder = document.getElementById('contact-list-placeholder');
            listEl.innerHTML = '';
            if (contacts.length === 0) {
                placeholder.classList.remove('hidden');
                placeholder.textContent = 'No contacts for this student.';
            } else {
                placeholder.classList.add('hidden');
            }

            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'p-4 rounded-lg bg-white shadow-sm border border-gray-200';
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold text-gray-800">${contact.name}</h4>
                        <button class="delete-contact-btn text-red-500 hover:text-red-700 text-sm font-medium" data-id="${contact.id}" data-name="${contact.name}">Delete</button>
                    </div>
                    <p class="text-sm text-gray-600">${contact.email}</p>
                    <p class="text-sm text-gray-600">${contact.phone || 'No phone'}</p>
                    <button class="email-contact-btn mt-3 w-full bg-green-100 text-green-800 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-green-200" data-email="${contact.email}" data-name="${contact.name}">
                        Email Contact
                    </button>
                `;
                item.querySelector('.delete-contact-btn').addEventListener('click', () => deleteContact(contact.id, contact.name));
                item.querySelector('.email-contact-btn').addEventListener('click', () => openEmailModal(contact.email, contact.name));
                listEl.appendChild(item);
            });
        }

        // --- State Management ---
        const selectClass = (classId) => {
            // Unsubscribe from previous class's student listener
            if (unsubscribeStudents) {
                unsubscribeStudents();
                unsubscribeStudents = null;
            }

            currentClassId = classId;
            currentStudentId = null; // Reset student selection
            
            // Update UI
            document.querySelectorAll('#class-list > div').forEach(el => {
                el.classList.toggle('bg-blue-100', el.dataset.id === classId);
                el.classList.toggle('border-blue-500', el.dataset.id === classId);
                el.classList.toggle('bg-white', el.dataset.id !== classId);
                el.classList.toggle('border-gray-200', el.dataset.id !== classId);
            });

            document.getElementById('add-new-student-btn').disabled = false;
            document.getElementById('add-existing-student-btn').disabled = false;
            document.getElementById('add-contact-btn').disabled = true;

            document.getElementById('student-list-placeholder').textContent = 'Loading students...';
            document.getElementById('contact-list-placeholder').textContent = 'Select a student to see their contacts.';
            document.getElementById('contact-list').innerHTML = ''; // Clear contacts
            document.getElementById('student-list').innerHTML = ''; // Clear students

            // Mobile view: switch to students
            if (window.innerWidth < 768) {
                showColumn('students-col');
            }

            // Listen for students in this class
            listenForStudentsInClass(classId);
        }

        const selectStudent = (studentId) => {
            currentStudentId = studentId;

            // Update UI
            document.querySelectorAll('#student-list > div').forEach(el => {
                el.classList.toggle('bg-blue-100', el.dataset.id === studentId);
                el.classList.toggle('border-blue-500', el.dataset.id === studentId);
                el.classList.toggle('bg-white', el.dataset.id !== studentId);
                el.classList.toggle('border-gray-200', el.dataset.id !== studentId);
            });

            document.getElementById('add-contact-btn').disabled = false;
            document.getElementById('contact-list-placeholder').textContent = 'Loading contacts...';

            // Mobile view: switch to contacts
            if (window.innerWidth < 768) {
                showColumn('contacts-col');
            }

            // Fetch contacts for this student
            fetchContactsForStudent(studentId);
        }

        // --- Data Fetching (Firestore) ---

        // Listen for all classes
        const listenForClasses = () => {
            const q = query(getClassesCol());
            onSnapshot(q, (snapshot) => {
                const classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClassList(classes);
            }, (error) => {
                console.error("Error listening for classes: ", error);
                toast('Failed to load classes.', 'error');
            });
        }

        // Listen for all students (for the cache)
        const listenForAllStudents = () => {
            const q = query(getStudentsCol());
            onSnapshot(q, (snapshot) => {
                allStudentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }, (error) => {
                console.error("Error listening for all students: ", error);
            });
        }

        // Listen for students in a specific class
        const listenForStudentsInClass = (classId) => {
            if (!classId) {
                renderStudentList([]);
                return;
            }
            
            const classRef = doc(getClassesCol(), classId);
            // Listen to the class document for changes to its `students` array
            unsubscribeStudents = onSnapshot(classRef, async (classDoc) => {
                if (!classDoc.exists()) {
                    renderStudentList([]);
                    return;
                }
                const classData = classDoc.data();
                const studentIds = classData.students || []; // `students` is an array of IDs

                if (studentIds.length === 0) {
                    renderStudentList([]);
                    return;
                }
                
                try {
                    // We have IDs, now fetch the student documents
                    // Firestore 'in' query is limited to 30 items
                    const studentDocsPromises = [];
                    // Chunk the array into pieces of 30
                    for (let i = 0; i < studentIds.length; i += 30) {
                        const chunk = studentIds.slice(i, i + 30);
                        const q = query(getStudentsCol(), where('__name__', 'in', chunk));
                        studentDocsPromises.push(getDocs(q));
                    }
                    
                    const snapshots = await Promise.all(studentDocsPromises);
                    const students = [];
                    snapshots.forEach(snapshot => {
                        snapshot.docs.forEach(doc => {
                            students.push({ id: doc.id, ...doc.data() });
                        });
                    });

                    renderStudentList(students);
                } catch (error) {
                    console.error("Error fetching students for class: ", error);
                    toast('Failed to load students.', 'error');
                    renderStudentList([]); // Render empty list on error
                }
            }, (error) => {
                console.error("Error listening for class students: ", error);
                toast('Failed to load students.', 'error');
                renderStudentList([]);
            });
        }

        // Fetch contacts for a specific student
        const fetchContactsForStudent = async (studentId) => {
            if (!studentId) return;

            try {
                const studentDoc = await getDoc(doc(getStudentsCol(), studentId));
                if (!studentDoc.exists()) {
                    renderContactList([]);
                    return;
                }
                const studentData = studentDoc.data();
                const parentIds = studentData.parents || []; // `parents` is an array of IDs

                if (parentIds.length === 0) {
                    renderContactList([]);
                    return;
                }

                // We have IDs, now fetch the parent documents
                const parentDocsPromises = [];
                for (let i = 0; i < parentIds.length; i += 30) {
                    const chunk = parentIds.slice(i, i + 30);
                    const q = query(getParentsCol(), where('__name__', 'in', chunk));
                    parentDocsPromises.push(getDocs(q));
                }

                const snapshots = await Promise.all(parentDocsPromises);
                const parents = [];
                snapshots.forEach(snapshot => {
                    snapshot.docs.forEach(doc => {
                        parents.push({ id: doc.id, ...doc.data() });
                    });
                });

                renderContactList(parents);

            } catch (error) {
                console.error("Error fetching contacts for student: ", error);
                toast('Failed to load contacts.', 'error');
                renderContactList([]);
            }
        }


        // --- Data Writing (Firestore) ---

        // Add a new class
        const handleAddClass = async (e) => {
            e.preventDefault();
            const name = document.getElementById('class-name').value;
            const teacher = document.getElementById('teacher-name').value;
            if (!name || !teacher) return;

            try {
                await addDoc(getClassesCol(), {
                    name,
                    teacher,
                    students: [] // Initialize with an empty array of student IDs
                });
                toast('Class added successfully!', 'success');
                closeModal('add-class-modal');
                document.getElementById('add-class-form').reset();
            } catch (error) {
                console.error("Error adding class: ", error);
                toast('Failed to add class.', 'error');
            }
        }

        // Delete a class
        const deleteClass = async (classId, className) => {
            if (!confirm(`Are you sure you want to delete the class "${className}"? This will not delete students, but will remove them from this class.`)) return;

            try {
                // Just delete the class doc. The student references will just point to nothing.
                await deleteDoc(doc(getClassesCol(), classId));
                toast('Class deleted.', 'success');
                if (currentClassId === classId) {
                    currentClassId = null;
                    currentStudentId = null;
                    document.getElementById('student-list').innerHTML = '';
                    document.getElementById('contact-list').innerHTML = '';
                    document.getElementById('add-new-student-btn').disabled = true;
                    document.getElementById('add-existing-student-btn').disabled = true;
                    document.getElementById('add-contact-btn').disabled = true;
                }
            } catch (error) {
                console.error("Error deleting class: ", error);
                toast('Failed to delete class.', 'error');
            }
        }

        // Add a brand new student and enroll them in the current class
        const handleAddNewStudent = async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-student-name').value;
            if (!name || !currentClassId) return;

            try {
                // 1. Create the new student
                const studentRef = await addDoc(getStudentsCol(), {
                    name,
                    parents: [] // Initialize with empty array of parent IDs
                });

                // 2. Add the student's ID to the class's `students` array
                const classRef = doc(getClassesCol(), currentClassId);
                await updateDoc(classRef, {
                    students: arrayUnion(studentRef.id)
                });

                toast('Student added and enrolled!', 'success');
                closeModal('add-new-student-modal');
                document.getElementById('add-new-student-form').reset();
                // The onSnapshot listener for the class will automatically update the list
            } catch (error) {
                console.error("Error adding new student: ", error);
                toast('Failed to add new student.', 'error');
            }
        }

        // Add an existing student to the current class
        const handleAddExistingStudent = async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('existing-student-select').value;
            if (!studentId || !currentClassId) return;

            try {
                // Add the student's ID to the class's `students` array
                const classRef = doc(getClassesCol(), currentClassId);
                await updateDoc(classRef, {
                    students: arrayUnion(studentId)
                });

                toast('Student added to class!', 'success');
                closeModal('add-existing-student-modal');
                document.getElementById('add-existing-student-form').reset();
                // The onSnapshot listener for the class will automatically update the list
            } catch (error) {
                console.error("Error adding existing student to class: ", error);
                toast('Failed to add student to class.', 'error');
            }
        }

        // Remove a student from a class (does not delete the student)
        const removeStudentFromClass = async (studentId, studentName) => {
            if (!currentClassId || !studentId) return;
            if (!confirm(`Are you sure you want to remove "${studentName}" from this class? This will not delete the student.`)) return;

            try {
                const classRef = doc(getClassesCol(), currentClassId);
                await updateDoc(classRef, {
                    students: arrayRemove(studentId)
                });

                toast('Student removed from class.', 'success');
                if (currentStudentId === studentId) {
                    currentStudentId = null;
                    document.getElementById('contact-list').innerHTML = '';
                    document.getElementById('add-contact-btn').disabled = true;
                }
                // The onSnapshot listener for the class will automatically update the list
            } catch (error) {
                console.error("Error removing student from class: ", error);
                toast('Failed to remove student.', 'error');
            }
        }

        // Add a new contact and link them to the current student
        const handleAddContact = async (e) => {
            e.preventDefault();
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const phone = document.getElementById('contact-phone').value;
            if (!name || !email || !currentStudentId) return;

            try {
                // 1. Create the new parent/contact
                const parentRef = await addDoc(getParentsCol(), {
                    name,
                    email,
                    phone
                });

                // 2. Add the parent's ID to the student's `parents` array
                const studentRef = doc(getStudentsCol(), currentStudentId);
                await updateDoc(studentRef, {
                    parents: arrayUnion(parentRef.id)
                });

                toast('Contact added!', 'success');
                closeModal('add-contact-modal');
                document.getElementById('add-contact-form').reset();
                // Re-fetch contacts for this student
                fetchContactsForStudent(currentStudentId);
            } catch (error) {
                console.error("Error adding contact: ", error);
                toast('Failed to add contact.', 'error');
            }
        }

        // Delete a contact and remove them from the student
        const deleteContact = async (contactId, contactName) => {
            if (!currentStudentId || !contactId) return;
            if (!confirm(`Are you sure you want to delete "${contactName}"? This will also remove them from this student.`)) return;
            
            try {
                const batch = writeBatch(db);

                // 1. Remove parent ID from student's `parents` array
                const studentRef = doc(getStudentsCol(), currentStudentId);
                batch.update(studentRef, {
                    parents: arrayRemove(contactId)
                });

                // 2. Delete the parent document
                const parentRef = doc(getParentsCol(), contactId);
                batch.delete(parentRef);
                
                await batch.commit();
                
                toast('Contact deleted.', 'success');
                // Re-fetch contacts for this student
                fetchContactsForStudent(currentStudentId);
            } catch (error) {
                console.error("Error deleting contact: ", error);
                toast('Failed to delete contact.', 'error');
            }
        }


        // --- Email Functionality ---
        const openEmailModal = (email, name) => {
            document.getElementById('email-to').value = email;
            document.getElementById('email-subject').value = '';
            document.getElementById('email-body').value = `Hi ${name.split(' ')[0]},\n\n`;
            document.getElementById('email-status').textContent = '';
            document.getElementById('send-email-btn').disabled = false;
            openModal('compose-email-modal');
        }

        const handleSendEmail = async (e) => {
            e.preventDefault();
            const serverUrl = localStorage.getItem('render-url');
            if (!serverUrl) {
                toast('Please set the Render Server URL first.', 'error');
                return;
            }

            const to = document.getElementById('email-to').value;
            const subject = document.getElementById('email-subject').value;
            const text = document.getElementById('email-body').value;
            const sendBtn = document.getElementById('send-email-btn');
            const status = document.getElementById('email-status');

            sendBtn.disabled = true;
            status.textContent = 'Sending...';

            try {
                const response = await fetch(`${serverUrl}/send-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, subject, text })
                });

                if (response.ok) {
                    toast('Email sent successfully!', 'success');
                    closeModal('compose-email-modal');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server responded with ${response.status}`);
                }
            } catch (error) {
                console.error("Error sending email: ", error);
                toast(`Failed to send email: ${error.message}`, 'error');
                sendBtn.disabled = false;
                status.textContent = 'Failed. Try again.';
            }
        }

        // --- Server Config ---
        const saveServerConfig = () => {
            const url = document.getElementById('render-url').value;
            if (url) {
                localStorage.setItem('render-url', url);
                toast('Server URL saved!', 'success');
                document.getElementById('render-url').classList.add('border-green-500');
            } else {
                toast('Please enter a valid URL.', 'error');
                document.getElementById('render-url').classList.add('border-red-500');
            }
        }

        const loadServerConfig = () => {
            const url = localStorage.getItem('render-url');
            if (url) {
                document.getElementById('render-url').value = url;
                document.getElementById('render-url').classList.add('border-green-500');
            }
        }

        // --- Mobile Navigation ---
        const showColumn = (colId) => {
            // Hide all columns
            document.getElementById('classes-col').classList.add('hidden');
            document.getElementById('students-col').classList.add('hidden');
            document.getElementById('contacts-col').classList.add('hidden');
            // Show the target column
            document.getElementById(colId).classList.remove('hidden');

            // Update nav button styles
            document.getElementById('nav-classes').classList.remove('text-blue-600', 'border-blue-600');
            document.getElementById('nav-students').classList.remove('text-blue-600', 'border-blue-600');
            document.getElementById('nav-contacts').classList.remove('text-blue-600', 'border-blue-600');
            
            const navBtnId = `nav-${colId.split('-')[0]}`;
            document.getElementById(navBtnId).classList.add('text-blue-600', 'border-blue-600');
        }

        // --- Event Listeners ---
        const setupEventListeners = () => {
            // Modals
            document.getElementById('add-class-btn').addEventListener('click', () => openModal('add-class-modal'));
            document.getElementById('cancel-add-class').addEventListener('click', () => closeModal('add-class-modal'));
            document.getElementById('add-class-form').addEventListener('submit', handleAddClass);

            document.getElementById('add-new-student-btn').addEventListener('click', () => {
                const className = document.querySelector(`#class-list div[data-id="${currentClassId}"] h4`).textContent;
                document.getElementById('add-new-student-class-name').textContent = `Adding to: ${className}`;
                openModal('add-new-student-modal');
            });
            document.getElementById('cancel-add-new-student').addEventListener('click', () => closeModal('add-new-student-modal'));
            document.getElementById('add-new-student-form').addEventListener('submit', handleAddNewStudent);

            document.getElementById('add-existing-student-btn').addEventListener('click', () => {
                const className = document.querySelector(`#class-list div[data-id="${currentClassId}"] h4`).textContent;
                document.getElementById('add-existing-student-class-name').textContent = `Adding to: ${className}`;
                
                // Populate select dropdown
                const selectEl = document.getElementById('existing-student-select');
                selectEl.innerHTML = '<option value="">Select a student...</option>';
                allStudentsCache.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    selectEl.appendChild(option);
                });

                openModal('add-existing-student-modal');
            });
            document.getElementById('cancel-add-existing-student').addEventListener('click', () => closeModal('add-existing-student-modal'));
            document.getElementById('add-existing-student-form').addEventListener('submit', handleAddExistingStudent);

            document.getElementById('add-contact-btn').addEventListener('click', () => {
                const studentName = document.querySelector(`#student-list div[data-id="${currentStudentId}"] h4`).textContent;
                document.getElementById('add-contact-student-name').textContent = `Contact for: ${studentName}`;
                openModal('add-contact-modal');
            });
            document.getElementById('cancel-add-contact').addEventListener('click', () => closeModal('add-contact-modal'));
            document.getElementById('add-contact-form').addEventListener('submit', handleAddContact);

            document.getElementById('cancel-compose-email').addEventListener('click', () => closeModal('compose-email-modal'));
            document.getElementById('compose-email-form').addEventListener('submit', handleSendEmail);

            // Server Config
            document.getElementById('save-server-config').addEventListener('click', saveServerConfig);

            // Mobile Nav
            document.getElementById('nav-classes').addEventListener('click', () => showColumn('classes-col'));
            document.getElementById('nav-students').addEventListener('click', () => showColumn('students-col'));
            document.getElementById('nav-contacts').addEventListener('click', () => showColumn('contacts-col'));

            // Firebase Config Modal
            document.getElementById('firebase-config-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const config = {
                    apiKey: document.getElementById('firebase-api-key').value,
                    authDomain: document.getElementById('firebase-auth-domain').value,
                    projectId: document.getElementById('firebase-project-id').value,
                };
                if (config.apiKey && config.authDomain && config.projectId) {
                    localStorage.setItem('firebaseConfig', JSON.stringify(config));
                    closeModal('firebase-config-modal');
                    initializeAppAndAuth(config); // Re-initialize with new config
                } else {
                    toast('Please fill in all fields.', 'error');
                }
            });
        }
        
        // --- Firebase Initialization ---
        const initializeAppAndAuth = (firebaseConfig) => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // User is signed in. Load their data.
                        listenForClasses();
                        listenForAllStudents();
                        document.getElementById('loading-overlay').classList.add('hidden'); // Hide overlay
                    } else {
                        // User is signed out. Attempt anonymous sign-in.
                        try {
                            await signInAnonymously(auth);
                            // This will trigger onAuthStateChanged again
                        } catch (error) {
                            console.error("Anonymous sign-in failed: ", error);
                            toast('Authentication failed. Please check Firebase rules.', 'error');
                            document.getElementById('loading-overlay').classList.add('hidden'); // Hide overlay on fail
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed: ", error);
                toast('Firebase config is invalid.', 'error');
                // Clear bad config
                localStorage.removeItem('firebaseConfig');
                // Re-show the modal
                openModal('firebase-config-modal');
                document.getElementById('loading-overlay').classList.add('hidden'); // Hide overlay
            }
        }

        // --- App Entry Point ---
        const startApp = async () => {
            setupEventListeners();
            loadServerConfig();

            // Check if we are in the special preview environment
            if (typeof __firebase_config !== 'undefined' && typeof __initial_auth_token !== 'undefined') {
                // We are in the preview environment
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    userId = auth.currentUser.uid;
                    // User is signed in. Load their data.
                    listenForClasses();
                    listenForAllStudents();
                    document.getElementById('loading-overlay').classList.add('hidden'); // Hide overlay
                } catch (error) {
                    console.error("Preview auth failed: ", error);
                    toast('Preview environment auth failed.', 'error');
                    document.getElementById('loading-overlay').classList.add('hidden'); // Hide overlay on fail
                }
            } else {
                // We are on a live site. Check for saved config.
                const savedConfig = localStorage.getItem('firebaseConfig');
                if (savedConfig) {
                    initializeAppAndAuth(JSON.parse(savedConfig));
                } else {
                    // No config saved. Show the modal.
                    openModal('firebase-config-modal');
                    document.getElementById('loading-overlay').classList.add('hidden'); // Hide overlay
                }
            }

            // Set initial mobile view
            if (window.innerWidth < 768) {
                showColumn('classes-col');
            }
        };

        // Run the app
        startApp();
    </script>
</body>
</html>

