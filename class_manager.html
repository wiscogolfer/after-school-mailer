<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After-School Class Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> <!-- Example, better to use Tailwind icons -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .app-container {
            display: grid;
            grid-template-columns: 1fr;
            height: calc(100vh - 120px); /* Adjusted for header */
        }
        @media (min-width: 768px) {
            .app-container {
                grid-template-columns: 300px 1fr;
            }
        }
        @media (min-width: 1024px) {
            .app-container {
                grid-template-columns: 300px 1fr 1fr;
            }
            .column-students, .column-parents {
                display: block !important;
            }
        }
        .column {
            display: none; /* Mobile-first: hide columns */
            border-left: 1px solid #e2e8f0;
            overflow-y: auto;
            height: 100%;
        }
        .column.active {
            display: block; /* Show active column on mobile */
        }
        .column-classes {
            display: block; /* Always show classes */
        }
        .list-item {
            transition: background-color 0.15s ease-in-out;
        }
        .list-item.selected {
            background-color: #dbeafe; /* blue-100 */
            color: #1d4ed8; /* blue-700 */
            font-weight: 600;
        }
        .btn-icon {
            opacity: 0.5;
            transition: opacity 0.15s ease-in-out, color 0.15s ease-in-out;
        }
        .list-item:hover .btn-icon {
            opacity: 1;
        }
        .btn-icon:hover {
            color: #ef4444; /* red-500 */
        }
        /* Mobile Nav */
        .mobile-nav {
            display: flex;
            justify-content: space-around;
            border-top: 1px solid #e2e8f0;
        }
        @media (min-width: 768px) {
            .mobile-nav {
                display: none;
            }
        }
        /* Modal */
        .modal {
            transition: opacity 0.25s ease, visibility 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Loading */
        #loading-spinner {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div id="loading-spinner" class="w-12 h-12 border-4 border-gray-200 rounded-full"></div>
    </div>

    <!-- Top Header -->
    <header class="bg-white shadow-md p-4 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0">
        <h1 class="text-2xl font-bold text-gray-700">After-School Program Manager</h1>
        <div class="flex items-center space-x-2">
            <input type="text" id="render-url" placeholder="Render Server URL" class="border rounded-lg px-3 py-2 text-sm w-48 transition-all duration-150 ease-in-out">
            <button id="save-render-url" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-150 ease-in-out">
                Save
            </button>
            <span id="connection-status" class="text-sm font-medium"></span>
        </div>
    </header>

    <!-- Main Content Grid -->
    <div class="app-container bg-white shadow-lg rounded-lg m-4 overflow-hidden">

        <!-- Column 1: Classes -->
        <div class="column column-classes active" id="col-classes">
            <div class="p-4 border-b sticky top-0 bg-white z-10">
                <div class="flex flex-wrap justify-between items-center gap-2">
                    <h2 class="text-xl font-semibold">Classes</h2>
                    <button id="add-class-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg text-sm shadow transition-all duration-150 ease-in-out">
                        Add Class
                    </button>
                </div>
            </div>
            <div id="class-list" class="p-2 space-y-1">
                <!-- Class items will be injected here -->
            </div>
        </div>

        <!-- Column 2: Students -->
        <div class="column column-students" id="col-students">
            <div class="p-4 border-b sticky top-0 bg-white z-10">
                <div class="flex flex-wrap justify-between items-center gap-2">
                    <h2 class="text-xl font-semibold">Students</h2>
                    <div class="flex gap-2">
                        <button id="add-new-student-btn" disabled class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg text-sm shadow transition-all duration-150 ease-in-out opacity-50 cursor-not-allowed">
                            Add New
                        </button>
                        <button id="add-existing-student-btn" disabled class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-lg text-sm shadow transition-all duration-150 ease-in-out opacity-50 cursor-not-allowed">
                            Add Existing
                        </button>
                    </div>
                </div>
                <p id="student-class-header" class="text-sm text-gray-500 mt-1">Select a class to see students.</p>
            </div>
            <div id="student-list" class="p-2 space-y-1">
                <!-- Student items will be injected here -->
            </div>
        </div>

        <!-- Column 3: Parents/Contacts -->
        <div class="column column-parents" id="col-parents">
            <div class="p-4 border-b sticky top-0 bg-white z-10">
                <div class="flex flex-wrap justify-between items-center gap-2">
                    <h2 class="text-xl font-semibold">Parents/Contacts</h2>
                    <button id="add-parent-btn" disabled class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg text-sm shadow transition-all duration-150 ease-in-out opacity-50 cursor-not-allowed">
                        Add Contact
                    </button>
                </div>
                <p id="parent-student-header" class="text-sm text-gray-500 mt-1">Select a student to see contacts.</p>
            </div>
            <div id="parent-list" class="p-2 space-y-1">
                <!-- Parent items will be injected here -->
            </div>
        </div>

    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav bg-white p-2 fixed bottom-0 left-0 right-0 shadow-inner md:hidden">
        <button data-col="col-classes" class="mobile-nav-btn flex-1 text-center p-2 rounded-lg font-semibold text-blue-600 bg-blue-50">
            Classes
        </button>
        <button data-col="col-students" class="mobile-nav-btn flex-1 text-center p-2 rounded-lg font-semibold text-gray-600">
            Students
        </button>
        <button data-col="col-parents" class="mobile-nav-btn flex-1 text-center p-2 rounded-lg font-semibold text-gray-600">
            Contacts
        </button>
    </nav>

    <!-- Modal: Add Class -->
    <div id="modal-add-class" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 invisible opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform -translate-y-10">
            <h3 class="text-lg font-semibold mb-4">Add New Class</h3>
            <div class="space-y-4">
                <input type="text" id="new-class-name" placeholder="Class Name (e.g., Karate)" class="border rounded-lg w-full px-3 py-2">
                <input type="text" id="new-class-teacher" placeholder="Teacher Name" class="border rounded-lg w-full px-3 py-2">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="modal-add-class-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-150 ease-in-out">Cancel</button>
                <button id="modal-add-class-save" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-150 ease-in-out">Save Class</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Add New Student -->
    <div id="modal-add-new-student" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 invisible opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform -translate-y-10">
            <h3 class="text-lg font-semibold mb-2">Add New Student</h3>
            <p id="modal-new-student-header" class="text-sm text-gray-600 mb-4"></p>
            <div class="space-y-4">
                <input type="text" id="new-student-name" placeholder="Student's Full Name" class="border rounded-lg w-full px-3 py-2">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="modal-add-new-student-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-150 ease-in-out">Cancel</button>
                <button id="modal-add-new-student-save" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-150 ease-in-out">Save Student</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Existing Student -->
    <div id="modal-add-existing-student" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 invisible opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform -translate-y-10">
            <h3 class="text-lg font-semibold mb-2">Add Existing Student</h3>
            <p id="modal-existing-student-header" class="text-sm text-gray-600 mb-4"></p>
            <div class="space-y-4">
                <select id="existing-student-select" class="border rounded-lg w-full px-3 py-2">
                    <option value="">Select a student to add...</option>
                    <!-- Options populated by JS -->
                </select>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="modal-add-existing-student-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-150 ease-in-out">Cancel</button>
                <button id="modal-add-existing-student-save" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-150 ease-in-out">Add to Class</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Parent -->
    <div id="modal-add-parent" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 invisible opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform -translate-y-10">
            <h3 class="text-lg font-semibold mb-2">Add New Contact</h3>
            <p id="modal-parent-header" class="text-sm text-gray-600 mb-4"></p>
            <div class="space-y-4">
                <input type="text" id="new-parent-name" placeholder="Contact's Full Name" class="border rounded-lg w-full px-3 py-2">
                <input type="email" id="new-parent-email" placeholder="Email Address" class="border rounded-lg w-full px-3 py-2">
                <input type="tel" id="new-parent-phone" placeholder="Phone Number" class="border rounded-lg w-full px-3 py-2">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="modal-add-parent-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-150 ease-in-out">Cancel</button>
                <button id="modal-add-parent-save" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-150 ease-in-out">Save Contact</button>
            </div>
        </div>
    </div>

    <!-- Modal: Compose Email -->
    <div id="modal-compose-email" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-40 invisible opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl transform -translate-y-10">
            <h3 class="text-lg font-semibold mb-4">Compose Email</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">To:</label>
                    <input type="email" id="email-to" readonly class="border rounded-lg w-full px-3 py-2 bg-gray-100">
                </div>
                <div>
                    <label for="email-subject" class="block text-sm font-medium text-gray-700">Subject:</label>
                    <input type="text" id="email-subject" class="border rounded-lg w-full px-3 py-2">
                </div>
                <div>
                    <label for="email-body" class="block text-sm font-medium text-gray-700">Message:</label>
                    <textarea id="email-body" rows="10" class="border rounded-lg w-full px-3 py-2"></textarea>
                </div>
            </div>
            <div class="flex justify-between items-center mt-6">
                <span id="email-status" class="text-sm text-gray-500"></span>
                <div class="flex space-x-3">
                    <button id="modal-compose-email-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-150 ease-in-out">Cancel</button>
                    <button id="modal-compose-email-send" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-150 ease-in-out">
                        <span id="send-btn-text">Send Email</span>
                        <span id="send-btn-spinner" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-5 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full opacity-0">
        <span id="toast-message"></span>
    </div>
    <div id="toast-error" class="fixed bottom-4 right-4 bg-red-600 text-white px-5 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full opacity-0">
        <span id="toast-error-message"></span>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            writeBatch,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State ---
        const state = {
            selectedClassId: null,
            selectedStudentId: null,
            selectedClassName: null,
            selectedStudentName: null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            userId: null,
            db: null,
            auth: null,
            allStudents: [], // Local cache of all students
            unsubscribers: [], // To clean up listeners
        };

        // --- DOM Elements ---
        const dom = {
            loadingOverlay: document.getElementById('loading-overlay'),
            classList: document.getElementById('class-list'),
            studentList: document.getElementById('student-list'),
            parentList: document.getElementById('parent-list'),
            addClassBtn: document.getElementById('add-class-btn'),
            addNewStudentBtn: document.getElementById('add-new-student-btn'),
            addExistingStudentBtn: document.getElementById('add-existing-student-btn'),
            addParentBtn: document.getElementById('add-parent-btn'),
            studentClassHeader: document.getElementById('student-class-header'),
            parentStudentHeader: document.getElementById('parent-student-header'),
            renderUrlInput: document.getElementById('render-url'),
            saveRenderUrlBtn: document.getElementById('save-render-url'),
            connectionStatus: document.getElementById('connection-status'),
            // Modals
            modalAddClass: document.getElementById('modal-add-class'),
            newClassName: document.getElementById('new-class-name'),
            newClassTeacher: document.getElementById('new-class-teacher'),
            modalAddClassCancel: document.getElementById('modal-add-class-cancel'),
            modalAddClassSave: document.getElementById('modal-add-class-save'),
            
            modalAddNewStudent: document.getElementById('modal-add-new-student'),
            modalNewStudentHeader: document.getElementById('modal-new-student-header'),
            newStudentName: document.getElementById('new-student-name'),
            modalAddNewStudentCancel: document.getElementById('modal-add-new-student-cancel'),
            modalAddNewStudentSave: document.getElementById('modal-add-new-student-save'),

            modalAddExistingStudent: document.getElementById('modal-add-existing-student'),
            modalExistingStudentHeader: document.getElementById('modal-existing-student-header'),
            existingStudentSelect: document.getElementById('existing-student-select'),
            modalAddExistingStudentCancel: document.getElementById('modal-add-existing-student-cancel'),
            modalAddExistingStudentSave: document.getElementById('modal-add-existing-student-save'),

            modalAddParent: document.getElementById('modal-add-parent'),
            modalParentHeader: document.getElementById('modal-parent-header'),
            newParentName: document.getElementById('new-parent-name'),
            newParentEmail: document.getElementById('new-parent-email'),
            newParentPhone: document.getElementById('new-parent-phone'),
            modalAddParentCancel: document.getElementById('modal-add-parent-cancel'),
            modalAddParentSave: document.getElementById('modal-add-parent-save'),

            modalComposeEmail: document.getElementById('modal-compose-email'),
            emailTo: document.getElementById('email-to'),
            emailSubject: document.getElementById('email-subject'),
            emailBody: document.getElementById('email-body'),
            emailStatus: document.getElementById('email-status'),
            modalComposeEmailCancel: document.getElementById('modal-compose-email-cancel'),
            modalComposeEmailSend: document.getElementById('modal-compose-email-send'),
            sendBtnText: document.getElementById('send-btn-text'),
            sendBtnSpinner: document.getElementById('send-btn-spinner'),

            // Toasts
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            toastError: document.getElementById('toast-error'),
            toastErrorMessage: document.getElementById('toast-error-message'),
        };

        // --- Firebase Config ---
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Firebase config not found or invalid. Using defaults.", e);
            showErrorToast("Firebase config is missing. App will not work.");
            firebaseConfig = { apiKey: "MOCK_KEY", authDomain: "MOCK_DOMAIN", projectId: "MOCK_PROJECT" };
        }

        // --- Firebase Refs ---
        // These are functions because db and userId aren't available at load time
        const refs = {
            classes: () => collection(state.db, `/artifacts/${state.appId}/users/${state.userId}/classes`),
            classDoc: (id) => doc(state.db, `/artifacts/${state.appId}/users/${state.userId}/classes`, id),
            
            students: () => collection(state.db, `/artifacts/${state.appId}/users/${state.userId}/students`),
            studentDoc: (id) => doc(state.db, `/artifacts/${state.appId}/users/${state.userId}/students`, id),
            
            parents: () => collection(state.db, `/artifacts/${state.appId}/users/${state.userId}/parents`),
            parentDoc: (id) => doc(state.db, `/artifacts/${state.appId}/users/${state.userId}/parents`, id),

            // Queries
            studentsInClass: (classId) => query(refs.students(), where("classIds", "array-contains", classId)),
            parentsOfStudent: (studentId) => query(refs.parents(), where("studentId", "==", studentId))
        };

        // --- Utility Functions ---

        function openModal(modal) {
            modal.classList.remove('invisible', 'opacity-0');
            modal.classList.add('visible', 'opacity-100');
            modal.querySelector('.modal-content').classList.remove('-translate-y-10');
            modal.querySelector('.modal-content').classList.add('translate-y-0');

            // Set dynamic headers
            if (modal === dom.modalAddNewStudent) {
                dom.modalNewStudentHeader.textContent = `Adding to class: ${state.selectedClassName || ''}`;
            } else if (modal === dom.modalAddExistingStudent) {
                dom.modalExistingStudentHeader.textContent = `Adding to class: ${state.selectedClassName || ''}`;
            } else if (modal === dom.modalAddParent) {
                dom.modalParentHeader.textContent = `Adding contact for: ${state.selectedStudentName || ''}`;
            }
        }

        function closeModal(modal) {
            modal.classList.add('invisible', 'opacity-0');
            modal.classList.remove('visible', 'opacity-100');
            modal.querySelector('.modal-content').classList.add('-translate-y-10');
            modal.querySelector('.modal-content').classList.remove('translate-y-0');

            // Clear inputs
            const inputs = modal.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                } else {
                    input.value = '';
                }
            });

            // Clear email status
            if (modal === dom.modalComposeEmail) {
                dom.emailStatus.textContent = '';
                dom.modalComposeEmailSend.disabled = false;
                dom.sendBtnText.classList.remove('hidden');
                dom.sendBtnSpinner.classList.add('hidden');
            }
        }

        function showToast(message) {
            dom.toastMessage.textContent = message;
            dom.toast.classList.remove('translate-x-full', 'opacity-0');
            dom.toast.classList.add('translate-x-0', 'opacity-100');
            setTimeout(() => {
                dom.toast.classList.add('translate-x-full', 'opacity-0');
                dom.toast.classList.remove('translate-x-0', 'opacity-100');
            }, 3000);
        }
        
        function showErrorToast(message) {
            dom.toastErrorMessage.textContent = message;
            dom.toastError.classList.remove('translate-x-full', 'opacity-0');
            dom.toastError.classList.add('translate-x-0', 'opacity-100');
            setTimeout(() => {
                dom.toastError.classList.add('translate-x-full', 'opacity-0');
                dom.toastError.classList.remove('translate-x-0', 'opacity-100');
            }, 3000);
        }

        function cleanupListeners() {
            state.unsubscribers.forEach(unsub => unsub());
            state.unsubscribers = [];
        }

        // --- Render Functions ---

        function renderClasses(querySnapshot) {
            dom.classList.innerHTML = '';
            if (querySnapshot.empty) {
                dom.classList.innerHTML = `<p class="p-4 text-gray-500 text-sm">No classes added yet. Click "Add Class" to start.</p>`;
                return;
            }
            querySnapshot.forEach(doc => {
                const classData = doc.data();
                const el = document.createElement('div');
                el.className = `list-item flex justify-between items-center p-3 rounded-lg cursor-pointer hover:bg-gray-50 ${state.selectedClassId === doc.id ? 'selected' : ''}`;
                el.dataset.id = doc.id;
                el.dataset.name = classData.name;
                el.innerHTML = `
                    <div>
                        <div class="font-medium">${classData.name}</div>
                        <div class="text-sm text-gray-600">${classData.teacher}</div>
                    </div>
                    <button class="btn-icon p-1 rounded-full hover:bg-red-100" data-id="${doc.id}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                // Click to select class
                el.addEventListener('click', (e) => {
                    if (e.target.closest('.btn-icon')) return; // Ignore delete button click
                    handleSelectClass(doc.id, classData.name);
                });
                // Click to delete class
                el.querySelector('.btn-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Are you sure you want to delete the class "${classData.name}"? This will not delete students, but will remove them from this class.`)) {
                        handleDeleteClass(doc.id);
                    }
                });
                dom.classList.appendChild(el);
            });
        }

        function renderStudents(querySnapshot) {
            dom.studentList.innerHTML = '';
            if (querySnapshot.empty) {
                dom.studentList.innerHTML = `<p class="p-4 text-gray-500 text-sm">No students in this class.</p>`;
                return;
            }
            querySnapshot.forEach(doc => {
                const student = doc.data();
                const el = document.createElement('div');
                el.className = `list-item flex justify-between items-center p-3 rounded-lg cursor-pointer hover:bg-gray-50 ${state.selectedStudentId === doc.id ? 'selected' : ''}`;
                el.dataset.id = doc.id;
                el.dataset.name = student.name;
                el.innerHTML = `
                    <div class="font-medium">${student.name}</div>
                    <button class="btn-icon p-1 rounded-full hover:bg-red-100" data-id="${doc.id}" title="Remove from class">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path></svg>
                    </button>
                `;
                // Click to select student
                el.addEventListener('click', (e) => {
                    if (e.target.closest('.btn-icon')) return;
                    handleSelectStudent(doc.id, student.name);
                });
                // Click to remove student from class
                el.querySelector('.btn-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Remove "${student.name}" from "${state.selectedClassName}"? This will not delete the student from the system.`)) {
                        handleRemoveStudentFromClass(doc.id);
                    }
                });
                dom.studentList.appendChild(el);
            });
        }

        function renderParents(querySnapshot) {
            dom.parentList.innerHTML = '';
            if (querySnapshot.empty) {
                dom.parentList.innerHTML = `<p class="p-4 text-gray-500 text-sm">No contacts for this student.</p>`;
                return;
            }
            querySnapshot.forEach(doc => {
                const parent = doc.data();
                const el = document.createElement('div');
                el.className = `list-item p-3 rounded-lg space-y-2`;
                el.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="font-medium">${parent.name}</div>
                        <button class="btn-icon p-1 rounded-full hover:bg-red-100" data-id="${doc.id}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <div class="text-sm text-gray-700">
                        <p>${parent.email}</p>
                        <p>${parent.phone}</p>
                    </div>
                    <button class="email-contact-btn text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-1 px-3 rounded-lg" data-email="${parent.email}">
                        Email Contact
                    </button>
                `;
                // Click to delete parent
                el.querySelector('.btn-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Are you sure you want to delete the contact "${parent.name}"?`)) {
                        handleDeleteParent(doc.id);
                    }
                });
                // Click to email parent
                el.querySelector('.email-contact-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const email = e.target.dataset.email;
                    if (!dom.renderUrlInput.value) {
                        showErrorToast("Please save a Render Server URL first.");
                        return;
                    }
                    dom.emailTo.value = email;
                    dom.emailSubject.value = '';
                    dom.emailBody.value = '';
                    openModal(dom.modalComposeEmail);
                });
                dom.parentList.appendChild(el);
            });
        }
        
        function updateAllStudentsCache(querySnapshot) {
            state.allStudents = [];
            querySnapshot.forEach(doc => {
                state.allStudents.push({ id: doc.id, ...doc.data() });
            });
            // Sort alphabetically
            state.allStudents.sort((a, b) => a.name.localeCompare(b.name));
        }

        // --- Event Handlers ---

        function handleSelectClass(classId, className) {
            state.selectedClassId = classId;
            state.selectedClassName = className;
            state.selectedStudentId = null; // Clear student selection
            state.selectedStudentName = null;

            // Update UI
            document.querySelectorAll('#class-list .list-item').forEach(el => {
                el.classList.toggle('selected', el.dataset.id === classId);
            });
            dom.studentClassHeader.textContent = `Students in: ${className}`;
            dom.parentStudentHeader.textContent = 'Select a student to see contacts.';
            dom.studentList.innerHTML = `<p class="p-4 text-gray-500 text-sm">Loading students...</p>`; // Loading state
            dom.parentList.innerHTML = `<p class="p-4 text-gray-500 text-sm">Select a student to see contacts.</p>`;
            
            // Enable student buttons
            dom.addNewStudentBtn.disabled = false;
            dom.addExistingStudentBtn.disabled = false;
            dom.addNewStudentBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            dom.addExistingStudentBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            // Disable parent button
            dom.addParentBtn.disabled = true;
            dom.addParentBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // Clean up old listeners
            cleanupListeners();

            // Listen for all students (for "Add Existing" modal)
            const unsubAllStudents = onSnapshot(refs.students(), updateAllStudentsCache, (err) => {
                console.error("Error fetching all students: ", err);
                showErrorToast("Failed to load student list.");
            });
            state.unsubscribers.push(unsubAllStudents);

            // Listen for students in this class
            const q = refs.studentsInClass(classId);
            const unsubStudents = onSnapshot(q, renderStudents, (err) => {
                console.error("Error fetching students: ", err);
                showErrorToast("Failed to load students for this class.");
            });
            state.unsubscribers.push(unsubStudents);

            // Show column on mobile
            showColumn('col-students');
        }

        function handleSelectStudent(studentId, studentName) {
            state.selectedStudentId = studentId;
            state.selectedStudentName = studentName;

            // Update UI
            document.querySelectorAll('#student-list .list-item').forEach(el => {
                el.classList.toggle('selected', el.dataset.id === studentId);
            });
            dom.parentStudentHeader.textContent = `Contacts for: ${studentName}`;
            dom.parentList.innerHTML = `<p class="p-4 text-gray-500 text-sm">Loading contacts...</p>`; // Loading state

            // Enable parent button
            dom.addParentBtn.disabled = false;
            dom.addParentBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Listen for parents of this student
            const q = refs.parentsOfStudent(studentId);
            const unsubParents = onSnapshot(q, renderParents, (err) => {
                console.error("Error fetching parents: ", err);
                showErrorToast("Failed to load contacts for this student.");
            });
            state.unsubscribers.push(unsubParents);

            // Show column on mobile
            showColumn('col-parents');
        }

        // --- Data Functions (Firestore) ---

        async function handleAddClass() {
            const name = dom.newClassName.value.trim();
            const teacher = dom.newClassTeacher.value.trim();
            if (!name) {
                showErrorToast("Class name is required.");
                return;
            }

            try {
                await addDoc(refs.classes(), { name, teacher });
                showToast("Class added successfully!");
                closeModal(dom.modalAddClass);
            } catch (e) {
                console.error("Error adding class: ", e);
                showErrorToast("Failed to add class.");
            }
        }

        async function handleDeleteClass(classId) {
            if (!classId) return;
            try {
                // This is a complex operation. We need to:
                // 1. Get all students in this class.
                // 2. Remove the classId from each of those students' `classIds` array.
                // 3. Delete the class document itself.
                // We use a batch write to make this atomic.

                const batch = writeBatch(state.db);

                // 1. Get students
                const q = refs.studentsInClass(classId);
                const studentsSnapshot = await getDocs(q);

                // 2. Prep student updates
                studentsSnapshot.forEach(studentDoc => {
                    const studentRef = refs.studentDoc(studentDoc.id);
                    batch.update(studentRef, {
                        classIds: arrayRemove(classId)
                    });
                });

                // 3. Prep class delete
                const classRef = refs.classDoc(classId);
                batch.delete(classRef);

                // Commit the batch
                await batch.commit();

                // Clear selection if the deleted class was selected
                if (state.selectedClassId === classId) {
                    state.selectedClassId = null;
                    state.selectedClassName = null;
                    dom.studentList.innerHTML = `<p class="p-4 text-gray-500 text-sm">Select a class to see students.</p>`;
                    dom.parentList.innerHTML = `<p class="p-4 text-gray-500 text-sm">Select a student to see contacts.</p>`;
                    dom.studentClassHeader.textContent = 'Select a class to see students.';
                }

                showToast("Class deleted successfully.");
            } catch (e) {
                console.error("Error deleting class: ", e);
                showErrorToast("Failed to delete class.");
            }
        }

        async function handleAddNewStudent() {
            const name = dom.newStudentName.value.trim();
            if (!name) {
                showErrorToast("Student name is required.");
                return;
            }
            if (!state.selectedClassId) {
                showErrorToast("No class selected.");
                return;
            }

            try {
                // Add new student to 'students' collection and include the current classId
                await addDoc(refs.students(), {
                    name: name,
                    classIds: [state.selectedClassId] // Add to current class
                });
                showToast("Student added successfully!");
                closeModal(dom.modalAddNewStudent);
            } catch (e) {
                console.error("Error adding student: ", e);
                showErrorToast("Failed to add student.");
            }
        }
        
        async function handleAddExistingStudent() {
            const studentId = dom.existingStudentSelect.value;
            if (!studentId) {
                showErrorToast("Please select a student.");
                return;
            }
            if (!state.selectedClassId) {
                showErrorToast("No class selected.");
                return;
            }

            try {
                // Just add the classId to the student's `classIds` array
                const studentRef = refs.studentDoc(studentId);
                await updateDoc(studentRef, {
                    classIds: arrayUnion(state.selectedClassId)
                });
                showToast("Student added to class!");
                closeModal(dom.modalAddExistingStudent);
            } catch (e) {
                console.error("Error adding student to class: ", e);
                showErrorToast("Failed to add student to class.");
            }
        }

        async function handleRemoveStudentFromClass(studentId) {
            if (!studentId || !state.selectedClassId) return;

            try {
                const studentRef = refs.studentDoc(studentId);
                await updateDoc(studentRef, {
                    classIds: arrayRemove(state.selectedClassId)
                });
                
                // Clear parent list if this student was selected
                if (state.selectedStudentId === studentId) {
                    state.selectedStudentId = null;
                    state.selectedStudentName = null;
                    dom.parentList.innerHTML = `<p class="p-4 text-gray-500 text-sm">Select a student to see contacts.</p>`;
                    dom.parentStudentHeader.textContent = 'Select a student to see contacts.';
                    dom.addParentBtn.disabled = true;
                    dom.addParentBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                showToast("Student removed from class.");
            } catch (e) {
                console.error("Error removing student from class: ", e);
                showErrorToast("Failed to remove student.");
            }
        }

        async function handleAddParent() {
            const name = dom.newParentName.value.trim();
            const email = dom.newParentEmail.value.trim();
            const phone = dom.newParentPhone.value.trim();

            if (!name || !email) {
                showErrorToast("Contact name and email are required.");
                return;
            }
            if (!state.selectedStudentId) {
                showErrorToast("No student selected.");
                return;
            }

            try {
                await addDoc(refs.parents(), {
                    name,
                    email,
                    phone,
                    studentId: state.selectedStudentId // Link to the selected student
                });
                showToast("Contact added successfully!");
                closeModal(dom.modalAddParent);
            } catch (e) {
                console.error("Error adding parent: ", e);
                showErrorToast("Failed to add contact.");
            }
        }

        async function handleDeleteParent(parentId) {
            if (!parentId) return;
            try {
                await deleteDoc(refs.parentDoc(parentId));
                showToast("Contact deleted successfully.");
            } catch (e) {
                console.error("Error deleting parent: ", e);
                showErrorToast("Failed to delete contact.");
            }
        }
        
        // --- Email Sending ---
        async function handleSendEmail() {
            const url = dom.renderUrlInput.value.trim();
            if (!url) {
                showErrorToast("Please save a Render Server URL first.");
                return;
            }

            const to = dom.emailTo.value;
            const subject = dom.emailSubject.value;
            const text = dom.emailBody.value;

            if (!to || !subject || !text) {
                dom.emailStatus.textContent = "Please fill out all fields.";
                dom.emailStatus.classList.add('text-red-500');
                return;
            }

            // Show spinner
            dom.modalComposeEmailSend.disabled = true;
            dom.sendBtnText.classList.add('hidden');
            dom.sendBtnSpinner.classList.remove('hidden');
            dom.emailStatus.textContent = "Sending...";
            dom.emailStatus.classList.remove('text-red-500', 'text-green-500');

            try {
                const fullUrl = url.endsWith('/') ? `${url}send-email` : `${url}/send-email`;
                const response = await fetch(fullUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, subject, text })
                });

                if (!response.ok) {
                    const res = await response.json();
                    throw new Error(res.message || `Server responded with ${response.status}`);
                }

                const result = await response.json();
                dom.emailStatus.textContent = "Email sent successfully!";
                dom.emailStatus.classList.add('text-green-500');
                showToast("Email sent!");
                setTimeout(() => closeModal(dom.modalComposeEmail), 1500);

            } catch (err) {
                console.error("Email send error:", err);
                dom.emailStatus.textContent = `Error: ${err.message}`;
                dom.emailStatus.classList.add('text-red-500');
                showErrorToast(`Email failed: ${err.message}`);
                // Hide spinner, re-enable button
                dom.modalComposeEmailSend.disabled = false;
                dom.sendBtnText.classList.remove('hidden');
                dom.sendBtnSpinner.classList.add('hidden');
            }
        }

        // --- Server URL Management ---
        function saveRenderUrl() {
            const url = dom.renderUrlInput.value.trim();
            if (url) {
                localStorage.setItem('renderUrl', url);
                dom.connectionStatus.textContent = "Saved!";
                dom.connectionStatus.classList.add('text-green-600');
                dom.connectionStatus.classList.remove('text-red-600');
                dom.renderUrlInput.classList.add('border-green-500');
                dom.renderUrlInput.classList.remove('border-red-500');
                
                setTimeout(() => {
                    dom.connectionStatus.textContent = "";
                }, 2000);
            }
        }
        
        function loadRenderUrl() {
            const url = localStorage.getItem('renderUrl');
            if (url) {
                dom.renderUrlInput.value = url;
                dom.renderUrlInput.classList.add('border-green-500');
            }
        }

        // --- Mobile Navigation ---
        function showColumn(colId) {
            document.querySelectorAll('.column').forEach(col => {
                col.classList.remove('active');
            });
            document.getElementById(colId).classList.add('active');

            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                btn.classList.toggle('text-blue-600', btn.dataset.col === colId);
                btn.classList.toggle('bg-blue-50', btn.dataset.col === colId);
                btn.classList.toggle('text-gray-600', btn.dataset.col !== colId);
            });
        }

        // --- Init Function ---
        function init() {
            console.log("App initializing...");

            // --- Server URL ---
            loadRenderUrl();
            dom.saveRenderUrlBtn.addEventListener('click', saveRenderUrl);

            // --- Modal Triggers ---
            dom.addClassBtn.addEventListener('click', () => openModal(dom.modalAddClass));
            dom.addNewStudentBtn.addEventListener('click', () => openModal(dom.modalAddNewStudent));
            dom.addExistingStudentBtn.addEventListener('click', () => {
                // Populate the dropdown
                dom.existingStudentSelect.innerHTML = '<option value="">Select a student to add...</option>';
                const studentsInClass = Array.from(dom.studentList.querySelectorAll('.list-item')).map(el => el.dataset.id);
                state.allStudents.forEach(student => {
                    if (!studentsInClass.includes(student.id)) {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = student.name;
                        dom.existingStudentSelect.appendChild(option);
                    }
                });
                openModal(dom.modalAddExistingStudent);
            });
            dom.addParentBtn.addEventListener('click', () => openModal(dom.modalAddParent));

            // --- Modal Actions ---
            dom.modalAddClassCancel.addEventListener('click', () => closeModal(dom.modalAddClass));
            dom.modalAddClassSave.addEventListener('click', handleAddClass);
            
            dom.modalAddNewStudentCancel.addEventListener('click', () => closeModal(dom.modalAddNewStudent));
            dom.modalAddNewStudentSave.addEventListener('click', handleAddNewStudent);

            dom.modalAddExistingStudentCancel.addEventListener('click', () => closeModal(dom.modalAddExistingStudent));
            dom.modalAddExistingStudentSave.addEventListener('click', handleAddExistingStudent);
            
            dom.modalAddParentCancel.addEventListener('click', () => closeModal(dom.modalAddParent));
            dom.modalAddParentSave.addEventListener('click', handleAddParent);
            
            dom.modalComposeEmailCancel.addEventListener('click', () => closeModal(dom.modalComposeEmail));
            dom.modalComposeEmailSend.addEventListener('click', handleSendEmail);

            // --- Mobile Nav ---
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => showColumn(btn.dataset.col));
            });

            // --- Firebase Auth ---
            try {
                const app = initializeApp(firebaseConfig);
                state.db = getFirestore(app);
                state.auth = getAuth(app);

                onAuthStateChanged(state.auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        state.userId = user.uid;
                        // User is authenticated, attach listeners
                        attachListeners();
                    } else {
                        console.log("User not signed in. Authenticating...");
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(state.auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(state.auth);
                            }
                        } catch (authError) {
                            console.error("Anonymous sign-in failed: ", authError);
                            showErrorToast("Authentication failed. Please refresh.");
                            dom.loadingOverlay.style.display = 'none';
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed: ", e);
                showErrorToast("App failed to initialize. Please refresh.");
                dom.loadingOverlay.style.display = 'none';
            }
        }

        // --- Attach Listeners (post-auth) ---
        function attachListeners() {
            if (!state.userId || !state.db) {
                console.error("Cannot attach listeners: userId or db is missing.");
                return;
            }

            console.log("Attaching Firestore listeners...");
            // Clean up any existing listeners first
            cleanupListeners();

            // Attach listener for Classes
            try {
                const q = refs.classes();
                const unsubClasses = onSnapshot(q, (snapshot) => {
                    console.log("Received class snapshot");
                    renderClasses(snapshot);
                    dom.loadingOverlay.style.display = 'none'; // Hide loading
                }, (error) => {
                    console.error("Error fetching classes: ", error);
                    showErrorToast("Failed to load classes.");
                    dom.loadingOverlay.style.display = 'none'; // Hide loading
                });
                state.unsubscribers.push(unsubClasses);
            } catch (e) {
                console.error("Failed to attach class listener: ", e);
                showErrorToast("A critical error occurred. Please refresh.");
                dom.loadingOverlay.style.display = 'none';
            }
        }

        // --- Start the App ---
        init();

    </script>
</body>
</html>

