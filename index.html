<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>After-School Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .modal { display:none; }
    .modal.flex { display:flex; }
    .scrolling-list { max-height:60vh; }
    .scrolling-list::-webkit-scrollbar { width:6px; }
    .scrolling-list::-webkit-scrollbar-thumb { background:#c5c5c5; border-radius:10px; }
    /* Mobile horizontal slider */
    .slider { overflow: hidden; position: relative; width: 100%; }
    .slides { display: flex; width: 300%; transition: transform 240ms ease-in-out; touch-action: pan-y; }
    .slide { width: 100%; flex: 0 0 100%; }
    .with-bottom-nav { padding-bottom: 5.5rem; }
    .tab-active { color:#1d4ed8; font-weight:600; }
    .badge { font-size: 11px; line-height: 1; }
    .fab {
      position: fixed; right: 1rem; bottom: 5.5rem;
      width: 56px; height: 56px; border-radius: 9999px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 10px 20px rgba(0,0,0,.15);
    }
    .fab-label { position: fixed; right: 5rem; bottom: 5.9rem; }
    @media (min-width:768px){
      .slider, .slides, .slide { width:auto; overflow:visible; display:block; transform:none !important; }
      .with-bottom-nav { padding-bottom: 0; }
      .fab, .fab-label, nav.mobile-tabs { display:none; }
    }
    .sticky-subheader { position: sticky; top: -1rem; background: white; z-index: 10; padding-top:.25rem; padding-bottom:.25rem; }
  </style>
</head>
<body class="bg-gray-100">

<!-- Toast -->
<div id="toast" class="fixed top-4 right-4 hidden items-center w-full max-w-xs p-4 text-gray-700 bg-white rounded-lg shadow z-50">
  <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"></div>
  <div id="toast-message" class="ml-3 text-sm font-normal"></div>
</div>

<!-- Auth -->
<div id="auth" class="min-h-screen flex items-center justify-center">
  <div class="bg-white rounded-xl shadow p-6 w-full max-w-sm">
    <h1 class="text-xl font-bold text-gray-900 mb-4">Sign in</h1>
    <form id="login-form" class="space-y-3">
      <div>
        <label class="block text-sm text-gray-600">Email</label>
        <input id="email" type="email" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Password</label>
        <input id="password" type="password" class="w-full border rounded p-2" required>
      </div>
      <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Sign in</button>
      <p id="login-error" class="text-xs text-red-600 h-4"></p>
    </form>
  </div>
</div>

<!-- App -->
<div id="app" class="hidden min-h-screen flex flex-col with-bottom-nav md:pb-0">
  <header class="bg-gray-900 text-white">
    <div class="container mx-auto p-3 flex items-center justify-between">
      <h2 class="font-semibold">After-School Manager</h2>
      <div class="flex items-center gap-3">
        <span id="user-email" class="text-sm text-gray-300"></span>
        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm">Sign out</button>
      </div>
    </div>
  </header>

  <!-- DESKTOP: 3 columns; MOBILE: horizontal slider with 3 slides -->
  <main class="container mx-auto p-4 flex-1">
    <!-- Desktop grid -->
    <div class="hidden md:grid md:grid-cols-3 gap-4">
      <!-- Classes -->
      <section class="bg-white p-4 rounded-lg shadow">
        <div class="flex justify-between items-center mb-3">
          <div class="flex p-1 bg-gray-200 rounded-lg">
            <button id="view-by-class" class="px-3 py-1.5 text-sm font-medium bg-white text-blue-700 rounded-md shadow-sm">By Class</button>
            <button id="view-by-student" class="px-3 py-1.5 text-sm font-medium text-gray-700">By Student</button>
          </div>
          <button id="add-class-desktop" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm">Add Class</button>
        </div>
        <div class="mb-2">
          <input id="search-classes" type="text" placeholder="Search classes..." class="w-full border rounded p-2">
        </div>
        <div id="col1-title" class="text-lg font-semibold mb-2">Classes</div>
        <div id="col1-list" class="scrolling-list overflow-y-auto space-y-2"></div>
      </section>

      <!-- Students -->
      <section class="bg-white p-4 rounded-lg shadow">
        <div class="flex justify-between items-center mb-3">
          <div>
            <div id="col2-title" class="text-lg font-semibold">Students</div>
            <div id="col2-subtitle" class="text-sm text-gray-500">Select a class</div>
          </div>
          <div id="col2-btns" class="flex items-center gap-2">
            <button id="add-existing-student-btn" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded text-sm" disabled>Add Existing</button>
            <button id="add-new-student-btn" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm" disabled>Add New</button>
            <button id="email-class-btn" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-sm" disabled>Email Class</button>
          </div>
        </div>
        <div class="mb-2">
          <input id="search-students" type="text" placeholder="Search students..." class="w-full border rounded p-2">
        </div>
        <div id="col2-list" class="scrolling-list overflow-y-auto space-y-2"></div>
      </section>

      <!-- Contacts -->
      <section class="bg-white p-4 rounded-lg shadow">
        <div class="flex justify-between items-center mb-3">
          <div>
            <div class="text-lg font-semibold">Parents / Contacts</div>
            <div id="col3-subtitle" class="text-sm text-gray-500">Select a student</div>
          </div>
          <button id="add-contact-btn" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm" disabled>Add Contact</button>
        </div>
        <div class="mb-2">
          <input id="search-contacts" type="text" placeholder="Search contacts..." class="w-full border rounded p-2">
        </div>
        <div id="col3-list" class="scrolling-list overflow-y-auto space-y-2"></div>
      </section>
    </div>

    <!-- MOBILE SLIDER -->
    <div class="md:hidden slider">
      <div id="slides" class="slides">
        <!-- Slide 1: Classes -->
        <section class="slide bg-white p-4 rounded-lg shadow mr-4">
          <div class="flex justify-between items-center mb-3">
            <div class="flex p-1 bg-gray-200 rounded-lg">
              <button id="view-by-class-m" class="px-3 py-1.5 text-sm font-medium bg-white text-blue-700 rounded-md shadow-sm">By Class</button>
              <button id="view-by-student-m" class="px-3 py-1.5 text-sm font-medium text-gray-700">By Student</button>
            </div>
          </div>
          <div class="mb-2">
            <input id="search-classes-m" type="text" placeholder="Search classes..." class="w-full border rounded p-2">
          </div>
          <div id="mini-class-sticky" class="sticky-subheader text-sm text-gray-500"></div>
          <div id="col1-title-m" class="text-lg font-semibold mb-2">Classes</div>
          <div id="col1-list-m" class="scrolling-list overflow-y-auto space-y-2"></div>
        </section>

        <!-- Slide 2: Students -->
        <section class="slide bg-white p-4 rounded-lg shadow mx-4">
          <div id="stud-sticky" class="sticky-subheader">
            <div id="stud-sticky-text" class="text-sm text-gray-600">Select a class</div>
          </div>
          <div class="mb-2 flex gap-2">
            <button id="email-class-btn-m" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-sm" disabled>Email Class</button>
          </div>
          <div class="mb-2">
            <input id="search-students-m" type="text" placeholder="Search students..." class="w-full border rounded p-2">
          </div>
          <div id="col2-title-m" class="text-lg font-semibold">Students</div>
          <div id="col2-subtitle-m" class="text-sm text-gray-500 mb-2">Select a class</div>
          <div id="col2-list-m" class="scrolling-list overflow-y-auto space-y-2"></div>
        </section>

        <!-- Slide 3: Contacts -->
        <section class="slide bg-white p-4 rounded-lg shadow ml-4">
          <div id="cont-sticky" class="sticky-subheader">
            <div id="cont-sticky-text" class="text-sm text-gray-600">Select a student</div>
          </div>
          <div class="mb-2">
            <input id="search-contacts-m" type="text" placeholder="Search contacts..." class="w-full border rounded p-2">
          </div>
          <div class="text-lg font-semibold">Parents / Contacts</div>
          <div id="col3-subtitle-m" class="text-sm text-gray-500 mb-2">Select a student</div>
          <div id="col3-list-m" class="scrolling-list overflow-y-auto space-y-2"></div>
        </section>
      </div>
    </div>
  </main>

  <!-- Bottom Mobile 3-tab menu -->
  <nav class="mobile-tabs md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow z-40">
    <div class="max-w-xl mx-auto grid grid-cols-3 text-center">
      <button id="tab-classes" class="py-3 text-sm font-medium tab-active">
        Classes <span id="badge-classes" class="badge ml-1 inline-block px-2 py-1 rounded bg-gray-100 text-gray-600">0</span>
      </button>
      <button id="tab-students" class="py-3 text-sm font-medium">
        Students <span id="badge-students" class="badge ml-1 inline-block px-2 py-1 rounded bg-gray-100 text-gray-600">0</span>
      </button>
      <button id="tab-contacts" class="py-3 text-sm font-medium">
        Contacts <span id="badge-contacts" class="badge ml-1 inline-block px-2 py-1 rounded bg-gray-100 text-gray-600">0</span>
      </button>
    </div>
  </nav>

  <!-- Context-aware FAB (mobile) -->
  <button id="fab" class="fab md:hidden bg-blue-600 text-white">
    <span class="text-2xl leading-none">+</span>
  </button>
  <div id="fab-label" class="fab-label md:hidden bg-gray-900 text-white text-xs px-2 py-1 rounded shadow">Add Class</div>
</div>

<!-- Modals -->
<div id="add-class-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Add Class</h3>
      <button class="close-modal text-gray-500" data-modal="add-class-modal">&times;</button>
    </div>
    <form id="add-class-form" class="space-y-3">
      <div>
        <label class="block text-sm text-gray-600">Class Name</label>
        <input id="class-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Teacher</label>
        <input id="teacher-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="add-class-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<div id="edit-class-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Edit Class</h3>
      <button class="close-modal text-gray-500" data-modal="edit-class-modal">&times;</button>
    </div>
    <form id="edit-class-form" class="space-y-3">
      <input type="hidden" id="edit-class-id">
      <div>
        <label class="block text-sm text-gray-600">Class Name</label>
        <input id="edit-class-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Teacher</label>
        <input id="edit-teacher-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="edit-class-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Update</button>
      </div>
    </form>
  </div>
</div>

<div id="add-student-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Add New Student</h3>
      <button class="close-modal text-gray-500" data-modal="add-student-modal">&times;</button>
    </div>
    <form id="add-student-form" class="space-y-3">
      <div>
        <label class="block text-sm text-gray-600">Student Name</label>
        <input id="student-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="add-student-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<div id="edit-student-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
   <div class="flex justify-between items-center mb-3">
     <h3 class="text-lg font-semibold">Edit Student</h3>
     <button class="close-modal text-gray-500" data-modal="edit-student-modal">&times;</button>
   </div>
   <form id="edit-student-form" class="space-y-3">
     <input type="hidden" id="edit-student-id">
     <div>
       <label class="block text-sm text-gray-600">Student Name</label>
       <input id="edit-student-name" type="text" class="w-full border rounded p-2" required>
     </div>
     <div class="flex justify-end gap-2">
       <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="edit-student-modal">Cancel</button>
       <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Update</button>
     </div>
   </form>
  </div>
</div>

<div id="add-existing-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Add Existing Student</h3>
      <button class="close-modal text-gray-500" data-modal="add-existing-modal">&times;</button>
    </div>
    <form id="add-existing-form" class="space-y-3">
      <div>
        <label class="block text-sm text-gray-600">Select Student</label>
        <select id="existing-student-select" class="w-full border rounded p-2" required></select>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="add-existing-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Add</button>
      </div>
    </form>
  </div>
</div>

<div id="add-contact-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Add Contact</h3>
      <button class="close-modal text-gray-500" data-modal="add-contact-modal">&times;</button>
    </div>
    <form id="add-contact-form" class="space-y-3">
      <div>
        <label class="block text-sm text-gray-600">Name</label>
        <input id="contact-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Email</label>
        <input id="contact-email" type="email" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Phone</label>
        <input id="contact-phone" type="tel" class="w-full border rounded p-2">
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="add-contact-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<div id="edit-contact-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Edit Contact</h3>
      <button class="close-modal text-gray-500" data-modal="edit-contact-modal">&times;</button>
    </div>
    <form id="edit-contact-form" class="space-y-3">
      <input type="hidden" id="edit-contact-id">
      <div>
        <label class="block text-sm text-gray-600">Name</label>
        <input id="edit-contact-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Email</label>
        <input id="edit-contact-email" type="email" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Phone</label>
        <input id="edit-contact-phone" type="tel" class="w-full border rounded p-2">
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="edit-contact-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Update</button>
      </div>
    </form>
  </div>
</div>

<!-- Email Modal -->
<div id="email-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-16 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Compose Email</h3>
      <button class="close-modal text-gray-500" data-modal="email-modal">&times;</button>
    </div>

    <form id="email-form" class="space-y-3">
      <p class="text-xs text-gray-500">
        Replies will go to: <span id="reply-to-display" class="font-medium"></span>
      </p>

      <div id="email-to-wrap">
        <label class="block text-sm text-gray-600">To</label>
        <input id="email-to" type="email" class="w-full border rounded p-2 bg-gray-50" readonly>
      </div>

      <div id="email-bcc-wrap" class="hidden">
        <label class="block text-sm text-gray-600">BCC</label>
        <textarea id="email-bcc" rows="3" class="w-full border rounded p-2 bg-gray-50" readonly></textarea>
      </div>

      <div>
        <label class="block text-sm text-gray-600">Subject</label>
        <input id="email-subject" type="text" class="w-full border rounded p-2" required>
      </div>

      <div>
        <label class="block text-sm text-gray-600">Message</label>
        <textarea id="email-body" rows="8" class="w-full border rounded p-2" required></textarea>
      </div>

      <div class="flex justify-between items-center">
        <span id="email-status" class="text-sm text-gray-500"></span>
        <div class="flex gap-2">
          <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="email-modal">Cancel</button>
          <button id="email-send-btn" class="bg-indigo-600 text-white px-3 py-1.5 rounded">Send</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script type="module">
/* ------------- Firebase ------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
  initializeAuth, browserLocalPersistence, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc,
  onSnapshot, query, where, writeBatch, arrayUnion, arrayRemove
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ---- Keep your working keys here ---- */
const firebaseConfig = {
  apiKey: "AIzaSyAYDMyMAw7wf3i28C-hQ_iRZRVdMiXmaLk",
  authDomain: "dance-classes-97ad7.firebaseapp.com",
  projectId: "dance-classes-97ad7",
  storageBucket: "dance-classes-97ad7.appspot.com",
  messagingSenderId: "1041555303856",
  appId: "1:1041555303856:web:5b80e0497eacaf161b7a75",
};
const ORG = "State-48-Dance";

/* ---- Your Render mailer ---- */
const SERVER_URL = "https://after-school-mailer.onrender.com";

/* ------------- Init ------------- */
const app = initializeApp(firebaseConfig);
const auth = initializeAuth(app, { persistence: browserLocalPersistence });
const db = getFirestore(app);

/* ------------- Helpers ------------- */
const $ = (id) => document.getElementById(id);
const openModal = (id) => $(id)?.classList.add("flex");
const closeModal = (id) => $(id)?.classList.remove("flex");
const toast = (msg, type="success", ms=2100) => {
  const t=$("toast"), i=$("toast-icon"), m=$("toast-message");
  i.className='inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg';
  i.classList.add(type==="error"?"text-red-600 bg-red-100":"text-green-600 bg-green-100");
  m.textContent=msg; t.classList.remove("hidden"); t.classList.add("flex");
  setTimeout(()=>{ t.classList.add("hidden"); t.classList.remove("flex"); },ms);
};
const isMobile = () => window.matchMedia("(max-width: 767px)").matches;

/* ------------- Slider / Tabs / FAB (mobile) ------------- */
const slides = $("slides");
const tabs = { classes:$("tab-classes"), students:$("tab-students"), contacts:$("tab-contacts") };
const badges = { classes:$("badge-classes"), students:$("badge-students"), contacts:$("badge-contacts") };
const fab = $("fab");
const fabLabel = $("fab-label");

let currentTab = "classes";
function setActiveTab(which){
  currentTab = which;
  Object.values(tabs).forEach(b=>b.classList.remove("tab-active"));
  tabs[which].classList.add("tab-active");
  updateFabForTab(which);
  if (isMobile()){
    const idx = which==="classes"?0:(which==="students"?1:2);
    slides.style.transform = `translateX(-${idx*100}%)`;
  }
}
function updateFabForTab(which){
  const map = { classes:"Add Class", students:"Add Student", contacts:"Add Contact" };
  fabLabel.textContent = map[which];
}
tabs.classes.addEventListener("click", ()=>setActiveTab("classes"));
tabs.students.addEventListener("click", ()=>setActiveTab("students"));
tabs.contacts.addEventListener("click", ()=>setActiveTab("contacts"));
window.addEventListener("resize", ()=>{ if (!isMobile()) slides.style.transform = "none"; });

/* Swipe gestures */
let startX=0, curX=0, dragging=false;
slides.addEventListener("touchstart",(e)=>{ if (!isMobile()) return; dragging=true; startX=e.touches[0].clientX; },{passive:true});
slides.addEventListener("touchmove",(e)=>{ if (!dragging) return; curX=e.touches[0].clientX; },{passive:true});
slides.addEventListener("touchend",()=>{ if (!dragging) return; const dx=curX-startX; dragging=false;
  if (Math.abs(dx) > 50){
    const order=["classes","students","contacts"];
    let i=order.indexOf(currentTab);
    if (dx<0 && i<2) setActiveTab(order[i+1]);
    if (dx>0 && i>0) setActiveTab(order[i-1]);
  }
});

/* FAB click behavior */
fab.addEventListener("click", ()=>{
  if (currentTab==="classes") openModal("add-class-modal");
  else if (currentTab==="students") openModal("add-student-modal");
  else if (currentTab==="contacts") {
    if (!currentStudentId) { toast("Select a student first","error"); return; }
    openModal("add-contact-modal");
  }
});

/* ------------- Paths ------------- */
const classesCol = () => collection(db, `organizations/${ORG}/classes`);
const studentsCol = () => collection(db, `organizations/${ORG}/students`);
const parentsCol  = () => collection(db, `organizations/${ORG}/parents`);

/* ------------- State ------------- */
let currentView = "class"; // "class" | "student"
let currentClassId = null;
let currentStudentId = null;
let allClasses = [];
let allStudents = [];
let unsubC = null, unsubS = null;

/* Search terms */
let qClasses = "", qStudents = "", qContacts = "";

/* ------------- Auth ------------- */
onAuthStateChanged(auth, (user)=>{
  if (user){
    $("user-email").textContent = user.email || "";
    $("auth").classList.add("hidden");
    $("app").classList.remove("hidden");
    startListeners();
    renderPrimary();
    setActiveTab("classes");
  } else {
    $("app").classList.add("hidden");
    $("auth").classList.remove("hidden");
    stopListeners(); allClasses=[]; allStudents=[]; currentClassId=null; currentStudentId=null;
  }
});
$("login-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const btn=$("login-btn"), err=$("login-error");
  btn.disabled=true; err.textContent="";
  try {
    await signInWithEmailAndPassword(auth, $("email").value, $("password").value);
    if (location.search) history.replaceState({}, "", location.pathname);
    toast("Signed in");
  } catch(ex){ err.textContent = ex.message || "Login failed"; toast("Login failed","error"); }
  finally { btn.disabled=false; }
});
$("logout-btn").addEventListener("click", async()=>{ await signOut(auth); toast("Signed out"); });

/* ------------- Listeners ------------- */
function startListeners(){
  if (!unsubC){
    unsubC = onSnapshot(classesCol(), snap=>{
      allClasses = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderPrimary();
      if (currentClassId) renderStudentsForClass(currentClassId);
      if (currentStudentId) { renderEnrolledClasses(currentStudentId); renderContacts(currentStudentId); }
      updateBadges();
    });
  }
  if (!unsubS){
    unsubS = onSnapshot(studentsCol(), snap=>{
      allStudents = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderPrimary();
      if (currentClassId) renderStudentsForClass(currentClassId);
      if (currentStudentId){ renderEnrolledClasses(currentStudentId); renderContacts(currentStudentId); }
      updateBadges();
    });
  }
}
function stopListeners(){ if (unsubC){unsubC();unsubC=null;} if (unsubS){unsubS();unsubS=null;} }

/* ------------- Rendering (desktop & mobile) ------------- */
function renderPrimary(){
  const classMode = currentView==="class";
  // Titles
  $("col1-title").textContent = classMode? "Classes":"All Students";
  $("col1-title-m").textContent = classMode? "Classes":"All Students";
  $("col2-title").textContent = classMode? "Students":"Enrolled In";
  $("col2-title-m").textContent = classMode? "Students":"Enrolled In";
  $("col2-subtitle").textContent = classMode? "Select a class":"Select a student";
  $("col2-subtitle-m").textContent = classMode? "Select a class":"Select a student";
  // Buttons (desktop)
  $("col2-btns").classList.toggle("hidden", !classMode);

  // Render first column per mode
  if (classMode){ renderClassLists(); clearStudentsPane(); clearContactsPane(); }
  else { renderStudentLists(); clearEnrolledPane(); clearContactsPane(); }

  // mini sticky headers (mobile)
  $("mini-class-sticky").textContent = currentClassId ? `Selected class: ${getClassName(currentClassId)}` : "";
  $("stud-sticky-text").textContent  = currentClassId ? `For: ${getClassName(currentClassId)}` : "Select a class";
  $("cont-sticky-text").textContent  = currentStudentId ? `For: ${getStudentName(currentStudentId)}` : "Select a student";
}

function filterByQuery(items, key, q){
  const s = (q||"").trim().toLowerCase();
  if (!s) return items;
  return items.filter(x => (x[key]||"").toLowerCase().includes(s));
}

function renderClassLists(){
  const data = filterByQuery([...allClasses].sort((a,b)=>a.name.localeCompare(b.name)), "name", qClasses);
  const lists = [ $("col1-list"), $("col1-list-m") ];
  lists.forEach(list=>{
    list.innerHTML="";
    if (data.length===0){ list.innerHTML=`<p class="text-gray-500 text-center">No classes found.</p>`; return; }
    data.forEach(c=>{
      const el = document.createElement("div");
      el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentClassId===c.id?"bg-blue-50 border-blue-300":""}`;
      el.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="font-medium text-gray-800">${c.name}</span>
          <div class="flex gap-2">
            <button class="edit-class px-2 py-1 text-sm bg-gray-200 rounded">Edit</button>
            <button class="del-class px-2 py-1 text-sm bg-red-600 text-white rounded">Del</button>
          </div>
        </div>
        <p class="text-sm text-gray-600">${c.teacher||""}</p>`;
      el.addEventListener("click", ()=>selectClass(c.id, c.name));
      el.querySelector(".edit-class").addEventListener("click", e=>{e.stopPropagation(); openEditClass(c.id);});
      el.querySelector(".del-class").addEventListener("click", e=>{e.stopPropagation(); deleteClass(c.id, c.name);});
      list.appendChild(el);
    });
  });
  updateBadges(); // classes total
}

function renderStudentLists(){
  const data = filterByQuery([...allStudents].sort((a,b)=>a.name.localeCompare(b.name)), "name", qStudents);
  const lists = [ $("col1-list"), $("col1-list-m") ];
  lists.forEach(list=>{
    list.innerHTML="";
    if (data.length===0){ list.innerHTML=`<p class="text-gray-500 text-center">No students found.</p>`; return; }
    data.forEach(s=>{
      const el = document.createElement("div");
      el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentStudentId===s.id?"bg-blue-50 border-blue-300":""}`;
      el.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="font-medium text-gray-800">${s.name}</span>
          <div class="flex gap-2">
            <button class="edit-student px-2 py-1 text-sm bg-gray-200 rounded">Edit</button>
            <button class="del-student px-2 py-1 text-sm bg-red-600 text-white rounded">Del</button>
          </div>
        </div>`;
      el.addEventListener("click", ()=>selectStudent(s.id, s.name));
      el.querySelector(".edit-student").addEventListener("click", e=>{e.stopPropagation(); openEditStudent(s.id);});
      el.querySelector(".del-student").addEventListener("click", e=>{e.stopPropagation(); deleteStudent(s.id, s.name);});
      list.appendChild(el);
    });
  });
}

function clearStudentsPane(){
  $("col2-subtitle").textContent = "Select a class";
  $("col2-subtitle-m").textContent = "Select a class";
  $("col2-list").innerHTML = "";
  $("col2-list-m").innerHTML = "";
  $("add-new-student-btn").disabled = true;
  $("add-existing-student-btn").disabled = true;
  $("email-class-btn").disabled = true;
  $("email-class-btn-m").disabled = true;
}
function clearEnrolledPane(){
  $("col2-subtitle").textContent = "Select a student";
  $("col2-subtitle-m").textContent = "Select a student";
  $("col2-list").innerHTML = "";
  $("col2-list-m").innerHTML = "";
}
function clearContactsPane(){
  $("col3-subtitle").textContent = "Select a student";
  $("col3-subtitle-m").textContent = "Select a student";
  $("col3-list").innerHTML = "";
  $("col3-list-m").innerHTML = "";
  $("add-contact-btn").disabled = true;
}

function renderStudentsForClass(classId){
  const c = allClasses.find(x=>x.id===classId);
  const inClass = allStudents.filter(s => (c?.students||[]).includes(s.id));
  const data = filterByQuery([...inClass].sort((a,b)=>a.name.localeCompare(b.name)), "name", qStudents);

  const renderInto = [$("col2-list"), $("col2-list-m")];
  renderInto.forEach(list=>{
    list.innerHTML = "";
    if (data.length===0) { list.innerHTML = `<p class="text-gray-500 text-center">No students in this class.</p>`; return; }
    data.forEach(s=>{
      const el = document.createElement("div");
      el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentStudentId===s.id?"bg-blue-50 border-blue-300":""}`;
      el.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="font-medium text-gray-800">${s.name}</span>
          <div class="flex gap-2">
            <button class="edit-student px-2 py-1 text-sm bg-gray-200 rounded">Edit</button>
            <button class="remove-student px-2 py-1 text-sm bg-yellow-600 text-white rounded">Remove</button>
          </div>
        </div>`;
      el.addEventListener("click", ()=>selectStudent(s.id, s.name));
      el.querySelector(".edit-student").addEventListener("click",(e)=>{ e.stopPropagation(); openEditStudent(s.id); });
      el.querySelector(".remove-student").addEventListener("click",(e)=>{ e.stopPropagation(); removeStudentFromClass(s.id, s.name); });
      list.appendChild(el);
    });
  });

  // enable desktop buttons
  $("add-new-student-btn").disabled = false;
  $("add-existing-student-btn").disabled = false;
  $("email-class-btn").disabled = false;
  $("email-class-btn-m").disabled = false;

  // mobile sticky
  $("stud-sticky-text").textContent = c ? `For: ${c.name}` : "Select a class";

  updateBadges();
}

function renderEnrolledClasses(studentId){
  const classes = allClasses.filter(c => (c.students||[]).includes(studentId)).sort((a,b)=>a.name.localeCompare(b.name));
  const renderInto = [$("col2-list"), $("col2-list-m")];
  renderInto.forEach(list=>{
    list.innerHTML = "";
    if (classes.length===0){ list.innerHTML = `<p class="text-gray-500 text-center">Not enrolled in any classes.</p>`; return; }
    classes.forEach(c => {
      const el = document.createElement("div");
      el.className = `p-3 rounded-lg border border-gray-200`;
      el.textContent = `${c.name} — ${c.teacher||""}`;
      list.appendChild(el);
    });
  });
}

async function renderContacts(studentId){
  const s = allStudents.find(x=>x.id===studentId);
  $("col3-subtitle").textContent = s ? `For: ${s.name}` : "Select a student";
  $("col3-subtitle-m").textContent = s ? `For: ${s.name}` : "Select a student";
  $("cont-sticky-text").textContent  = s ? `For: ${s.name}` : "Select a student";
  $("add-contact-btn").disabled = !studentId;

  const targets = [ $("col3-list"), $("col3-list-m") ];
  targets.forEach(l=>l.innerHTML="");

  if (!s || !s.parents || s.parents.length===0){
    targets.forEach(l=>l.innerHTML=`<p class="text-gray-500 text-center">No contacts for this student.</p>`);
    updateBadges(0);
    return;
  }
  try {
    let contacts = [];
    for (let i=0;i<s.parents.length;i+=30){
      const chunk = s.parents.slice(i,i+30);
      const qy = query(parentsCol(), where("__name__", "in", chunk));
      const qs = await getDocs(qy);
      qs.forEach(d => contacts.push({ id: d.id, ...d.data() }));
    }
    contacts.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    const filtered = filterByQuery(contacts, "name", qContacts);

    targets.forEach(list=>{
      list.innerHTML = "";
      if (filtered.length===0){
        list.innerHTML=`<p class="text-gray-500 text-center">No matching contacts.</p>`;
        return;
      }
      filtered.forEach(c=>{
        const el = document.createElement("div");
        el.className = "p-3 rounded-lg border border-gray-200";
        el.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="font-medium text-gray-800">${c.name||""}</div>
              <div class="text-sm text-gray-600">${c.email||""}</div>
              <div class="text-sm text-gray-600">${c.phone||""}</div>
            </div>
            <div class="flex gap-2">
              <button class="email-contact px-2 py-1 text-sm bg-indigo-600 text-white rounded">Email</button>
              <button class="edit-contact px-2 py-1 text-sm bg-gray-200 rounded">Edit</button>
              <button class="del-contact px-2 py-1 text-sm bg-red-600 text-white rounded">Del</button>
            </div>
          </div>`;
        // wire buttons
        const emailBtn = el.querySelector(".email-contact");
        if (c.email) {
          emailBtn.addEventListener("click", ()=> openEmailModal({ to: c.email }));
        } else {
          emailBtn.disabled = true;
          emailBtn.classList.add("opacity-50","cursor-not-allowed");
        }
        el.querySelector(".edit-contact").addEventListener("click", ()=>openEditContact(c));
        el.querySelector(".del-contact").addEventListener("click", ()=>deleteContact(c.id));
        list.appendChild(el);
      });
    });
    updateBadges();
  } catch(err){ console.error(err); toast("Failed to load contacts","error"); }
}

/* ------------- Selections ------------- */
function getClassName(id){ return allClasses.find(c=>c.id===id)?.name || ""; }
function getStudentName(id){ return allStudents.find(s=>s.id===id)?.name || ""; }

function selectClass(id, name){
  currentClassId = id; currentStudentId = null;
  $("col2-subtitle").textContent = `For: ${name}`;
  $("col2-subtitle-m").textContent = `For: ${name}`;
  renderStudentsForClass(id);
  clearContactsPane();
  $("mini-class-sticky").textContent = `Selected class: ${name}`;
  if (isMobile()) setActiveTab("students");
}

function selectStudent(id, name){
  currentStudentId = id;
  $("col3-subtitle").textContent = `For: ${name}`;
  $("col3-subtitle-m").textContent = `For: ${name}`;
  if (currentView==="student") renderEnrolledClasses(id);
  renderContacts(id);
  if (isMobile()) setActiveTab("contacts");
}

/* ------------- View toggle (desktop & mobile headers) ------------- */
$("view-by-class").addEventListener("click", ()=>{ currentView="class"; renderPrimary(); });
$("view-by-student").addEventListener("click", ()=>{ currentView="student"; renderPrimary(); });
$("view-by-class-m").addEventListener("click", ()=>{ currentView="class"; renderPrimary(); });
$("view-by-student-m").addEventListener("click", ()=>{ currentView="student"; renderPrimary(); });

/* ------------- Desktop add buttons ------------- */
$("add-class-desktop").addEventListener("click", ()=> openModal("add-class-modal"));
$("add-new-student-btn").addEventListener("click", ()=> openModal("add-student-modal"));
$("add-existing-student-btn").addEventListener("click", async ()=>{ if (!currentClassId) return; await populateExistingSelect(); openModal("add-existing-modal"); });
$("add-contact-btn").addEventListener("click", ()=>{ if (!currentStudentId) return; openModal("add-contact-modal"); });

/* ------------- Search inputs ------------- */
$("search-classes").addEventListener("input", e=>{ qClasses=e.target.value; renderPrimary(); });
$("search-classes-m").addEventListener("input", e=>{ qClasses=e.target.value; renderPrimary(); });
$("search-students").addEventListener("input", e=>{
  qStudents=e.target.value;
  currentView==="class" && currentClassId ? renderStudentsForClass(currentClassId) : renderStudentLists();
});
$("search-students-m").addEventListener("input", e=>{
  qStudents=e.target.value;
  currentView==="class" && currentClassId ? renderStudentsForClass(currentClassId) : renderStudentLists();
});
$("search-contacts").addEventListener("input", e=>{ qContacts=e.target.value; if (currentStudentId) renderContacts(currentStudentId); });
$("search-contacts-m").addEventListener("input", e=>{ qContacts=e.target.value; if (currentStudentId) renderContacts(currentStudentId); });

/* ------------- CRUD: Classes ------------- */
$("add-class-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = $("class-name").value.trim();
  const teacher = $("teacher-name").value.trim();
  try {
    await addDoc(classesCol(), { name, teacher, students: [] });
    closeModal("add-class-modal"); e.target.reset(); toast("Class added");
  } catch(err){ console.error(err); toast("Failed to add class","error"); }
});
function openEditClass(id){
  const c = allClasses.find(x=>x.id===id); if(!c) return;
  $("edit-class-id").value = id;
  $("edit-class-name").value = c.name || "";
  $("edit-teacher-name").value = c.teacher || "";
  openModal("edit-class-modal");
}
$("edit-class-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const id = $("edit-class-id").value;
  const name = $("edit-class-name").value.trim();
  const teacher = $("edit-teacher-name").value.trim();
  try {
    await updateDoc(doc(classesCol(), id), { name, teacher });
    closeModal("edit-class-modal"); toast("Class updated");
  } catch(err){ console.error(err); toast("Failed to update","error"); }
});
async function deleteClass(id, name){
  if (!confirm(`Delete class "${name}"?`)) return;
  try {
    const batch = writeBatch(db);
    // remove class ref from students.classes
    const sDocs = await getDocs(studentsCol());
    sDocs.forEach(d => {
      const data = d.data();
      if ((data.classes||[]).includes(id)) batch.update(d.ref, { classes: arrayRemove(id) });
    });
    batch.delete(doc(classesCol(), id));
    await batch.commit();
    if (currentClassId===id) { currentClassId=null; clearStudentsPane(); }
    toast("Class deleted");
    updateBadges();
  } catch(err){ console.error(err); toast("Delete failed","error"); }
}

/* ------------- CRUD: Students ------------- */
$("add-student-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = $("student-name").value.trim();
  try {
    const studentRef = await addDoc(studentsCol(), { name, parents: [], classes: [] });
    if (currentView==="class" && currentClassId) {
      const batch = writeBatch(db);
      batch.update(doc(classesCol(), currentClassId), { students: arrayUnion(studentRef.id) });
      batch.update(studentRef, { classes: arrayUnion(currentClassId) });
      await batch.commit();
    }
    closeModal("add-student-modal"); e.target.reset(); toast("Student added");
    updateBadges();
  } catch(err){ console.error(err); toast("Failed to add student","error"); }
});
function openEditStudent(id){
  const s = allStudents.find(x=>x.id===id); if(!s) return;
  $("edit-student-id").value = id;
  $("edit-student-name").value = s.name || "";
  openModal("edit-student-modal");
}
$("edit-student-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const id = $("edit-student-id").value;
  const name = $("edit-student-name").value.trim();
  try {
    await updateDoc(doc(studentsCol(), id), { name });
    closeModal("edit-student-modal"); toast("Student updated");
  } catch(err){ console.error(err); toast("Failed to update student","error"); }
});
async function removeStudentFromClass(studentId, studentName){
  if (!currentClassId) return;
  if (!confirm(`Remove ${studentName} from this class?`)) return;
  try {
    const batch = writeBatch(db);
    batch.update(doc(classesCol(), currentClassId), { students: arrayRemove(studentId) });
    batch.update(doc(studentsCol(), studentId), { classes: arrayRemove(currentClassId) });
    await batch.commit();
    if (currentStudentId===studentId) clearContactsPane();
    toast("Removed from class");
    updateBadges();
  } catch(err){ console.error(err); toast("Failed to remove","error"); }
}
async function deleteStudent(id, name){
  if (!confirm(`Delete ${name}? This removes enrollments and contacts.`)) return;
  try {
    const batch = writeBatch(db);
    // remove from classes
    const cDocs = await getDocs(classesCol());
    cDocs.forEach(d => {
      const c = d.data();
      if ((c.students||[]).includes(id)) batch.update(d.ref, { students: arrayRemove(id) });
    });
    // delete contacts and student
    const sRef = doc(studentsCol(), id);
    const sSnap = (await getDocs(query(studentsCol(), where("__name__", "==", id)))).docs?.[0];
    if (sSnap?.exists()){
      const s = sSnap.data();
      (s.parents||[]).forEach(pid => batch.delete(doc(parentsCol(), pid)));
    }
    batch.delete(sRef);
    await batch.commit();
    if (currentStudentId===id) { currentStudentId=null; clearEnrolledPane(); clearContactsPane(); }
    toast("Student deleted");
    updateBadges();
  } catch(err){ console.error(err); toast("Delete failed","error"); }
}

/* ------------- Add existing student to class ------------- */
async function populateExistingSelect(){
  const select = $("existing-student-select");
  select.innerHTML = "";
  const c = allClasses.find(x=>x.id===currentClassId);
  const enrolled = new Set(c?.students||[]);
  const options = allStudents.filter(s=>!enrolled.has(s.id)).sort((a,b)=>a.name.localeCompare(b.name));
  if (options.length===0){ select.innerHTML = `<option value="">No available students</option>`; return; }
  options.forEach(s=>{ const opt=document.createElement("option"); opt.value=s.id; opt.textContent=s.name; select.appendChild(opt); });
}
$("add-existing-student-btn").addEventListener("click", async ()=>{ if (!currentClassId) return; await populateExistingSelect(); openModal("add-existing-modal"); });
$("add-existing-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const sid = $("existing-student-select").value;
  if (!sid || !currentClassId) return;
  try {
    const batch = writeBatch(db);
    batch.update(doc(classesCol(), currentClassId), { students: arrayUnion(sid) });
    batch.update(doc(studentsCol(), sid), { classes: arrayUnion(currentClassId) });
    await batch.commit();
    closeModal("add-existing-modal");
    toast("Student added to class");
    updateBadges();
  } catch(err){ console.error(err); toast("Failed to add to class","error"); }
});

/* ------------- Contacts ------------- */
$("add-contact-btn").addEventListener("click", ()=>{ if (!currentStudentId) return; openModal("add-contact-modal"); });
$("add-contact-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if (!currentStudentId) return;
  const name = $("contact-name").value.trim();
  const email = $("contact-email").value.trim();
  const phone = $("contact-phone").value.trim();
  try {
    const parentRef = await addDoc(parentsCol(), { name, email, phone });
    await updateDoc(doc(studentsCol(), currentStudentId), { parents: arrayUnion(parentRef.id) });
    closeModal("add-contact-modal"); e.target.reset(); toast("Contact added");
    updateBadges();
  } catch(err){ console.error(err); toast("Failed to add contact","error"); }
});
function openEditContact(contact){
  $("edit-contact-id").value = contact.id;
  $("edit-contact-name").value = contact.name || "";
  $("edit-contact-email").value = contact.email || "";
  $("edit-contact-phone").value = contact.phone || "";
  openModal("edit-contact-modal");
}
$("edit-contact-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const id = $("edit-contact-id").value;
  const name = $("edit-contact-name").value.trim();
  const email = $("edit-contact-email").value.trim();
  const phone = $("edit-contact-phone").value.trim();
  try {
    await updateDoc(doc(parentsCol(), id), { name, email, phone });
    closeModal("edit-contact-modal"); toast("Contact updated");
  } catch(err){ console.error(err); toast("Failed to update contact","error"); }
});
async function deleteContact(id){
  if (!currentStudentId) return;
  if (!confirm("Delete this contact?")) return;
  try {
    const batch = writeBatch(db);
    batch.update(doc(studentsCol(), currentStudentId), { parents: arrayRemove(id) });
    batch.delete(doc(parentsCol(), id));
    await batch.commit();
    toast("Contact deleted");
    updateBadges();
    renderContacts(currentStudentId);
  } catch(err){ console.error(err); toast("Failed to delete contact","error"); }
}

/* ------------- Email: individual + whole class ------------- */
function openEmailModal({ to=null, bccList=null } = {}){
  const rtName = auth?.currentUser?.displayName || null;
  const rtEmail = auth?.currentUser?.email || null;
  $("reply-to-display").textContent = rtName ? `${rtName} <${rtEmail}>` : (rtEmail || "Unknown");

  if (to){
    $("email-to-wrap").classList.remove("hidden");
    $("email-bcc-wrap").classList.add("hidden");
    $("email-to").value = to;
    $("email-bcc").value = "";
  } else if (bccList && bccList.length){
    $("email-to-wrap").classList.add("hidden");
    $("email-bcc-wrap").classList.remove("hidden");
    $("email-to").value = "";
    $("email-bcc").value = bccList.join(", ");
  } else {
    toast("No recipients selected","error");
    return;
  }

  $("email-subject").value = "";
  $("email-body").value = "";
  $("email-status").textContent = "";
  $("email-send-btn").disabled = false;

  openModal("email-modal");
}

async function handleSendEmail(e){
  e.preventDefault();
  const sendBtn = $("email-send-btn");
  const status = $("email-status");
  sendBtn.disabled = true;
  status.textContent = "Sending…";

  try {
    const user = auth.currentUser;
    if (!user) throw new Error("Not authenticated");
    const replyToEmail = user.email || null;
    const replyToName  = user.displayName || user.email || "Program Staff";

    const to = $("email-to").value.trim() || null;
    const bccRaw = $("email-bcc").value.trim();
    const bcc = bccRaw
      ? bccRaw.split(",").map(s => s.trim()).filter(Boolean)
      : null;

    const payload = {
      to,
      bcc,
      replyTo: { email: replyToEmail, name: replyToName },
      subject: $("email-subject").value.trim(),
      text: $("email-body").value
    };

    const res = await fetch(`${SERVER_URL}/send-email`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      let msg = `Server error ${res.status}`;
      try { const j = await res.json(); if (j?.error) msg = j.error; } catch {}
      throw new Error(msg);
    }

    toast("Email sent");
    status.textContent = "Sent!";
    setTimeout(()=> closeModal("email-modal"), 700);
  } catch (err){
    console.error(err);
    toast(err.message || "Failed to send email","error");
    $("email-status").textContent = "Failed.";
    $("email-send-btn").disabled = false;
  }
}
$("email-form").addEventListener("submit", handleSendEmail);

async function emailWholeClass(){
  if (!currentClassId){ toast("Select a class first","error"); return; }
  const c = allClasses.find(x=>x.id===currentClassId);
  const studentIds = c?.students || [];
  if (studentIds.length === 0){ toast("This class has no students","error"); return; }

  const parentIds = new Set();
  allStudents.forEach(s=>{
    if (studentIds.includes(s.id)) (s.parents||[]).forEach(pid => parentIds.add(pid));
  });
  if (parentIds.size === 0){ toast("No parent contacts found","error"); return; }

  const bccEmails = [];
  try {
    const ids = Array.from(parentIds);
    for (let i=0; i<ids.length; i+=30){
      const chunk = ids.slice(i, i+30);
      const qs = await getDocs(query(parentsCol(), where("__name__", "in", chunk)));
      qs.forEach(d => {
        const email = d.data()?.email;
        if (email) bccEmails.push(email);
      });
    }
  } catch (e){
    console.error(e);
    toast("Failed to build recipient list","error");
    return;
  }

  if (bccEmails.length === 0){ toast("No valid emails found","error"); return; }

  openEmailModal({ bccList: [...new Set(bccEmails)] });
}
$("email-class-btn")?.addEventListener("click", emailWholeClass);
$("email-class-btn-m")?.addEventListener("click", emailWholeClass);

/* ------------- Desktop “By” toggle & Add buttons ------------- */
$("view-by-class").addEventListener("click", ()=>{ currentView="class"; renderPrimary(); });
$("view-by-student").addEventListener("click", ()=>{ currentView="student"; renderPrimary(); });

/* ------------- Badges ------------- */
function updateBadges(){
  badges.classes.textContent = allClasses.length;
  let studCount = 0;
  if (currentClassId){
    const c = allClasses.find(x=>x.id===currentClassId);
    studCount = c?.students?.length || 0;
  }
  badges.students.textContent = studCount;
  let contCount = 0;
  if (currentStudentId){
    const s = allStudents.find(x=>x.id===currentStudentId);
    contCount = s?.parents?.length || 0;
  }
  badges.contacts.textContent = contCount;
}

/* ------------- Close modals ------------- */
document.querySelectorAll(".close-modal").forEach(btn=>{
  btn.addEventListener("click", ()=> closeModal(btn.dataset.modal));
});

/* ------------- Initial ------------- */
setActiveTab("classes");
</script>

</body>
</html>
