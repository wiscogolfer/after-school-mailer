<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>After-School Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .modal { display:none; }
    .modal.flex { display:flex; }
    .scrolling-list { max-height:60vh; }
    .scrolling-list::-webkit-scrollbar { width:6px; }
    .scrolling-list::-webkit-scrollbar-thumb { background:#c5c5c5; border-radius:10px; }
    /* Mobile horizontal slider */
    .slider { overflow: hidden; position: relative; width: 100%; }
    .slides { display: flex; width: 300%; transition: transform 260ms ease-in-out; }
    .slide { width: 100%; flex: 0 0 100%; }
    .with-bottom-nav { padding-bottom: 4.5rem; }
    .tab-active { color:#1d4ed8; font-weight:600; }
    @media (min-width:768px){
      .slider, .slides, .slide { width:auto; overflow:visible; display:block; transform:none !important; }
      .with-bottom-nav { padding-bottom: 0; }
    }
  </style>
</head>
<body class="bg-gray-100">

<!-- Toast -->
<div id="toast" class="fixed top-4 right-4 hidden items-center w-full max-w-xs p-4 text-gray-700 bg-white rounded-lg shadow z-50">
  <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"></div>
  <div id="toast-message" class="ml-3 text-sm font-normal"></div>
</div>

<!-- Auth -->
<div id="auth" class="min-h-screen flex items-center justify-center">
  <div class="bg-white rounded-xl shadow p-6 w-full max-w-sm">
    <h1 class="text-xl font-bold text-gray-900 mb-4">Sign in</h1>
    <form id="login-form" class="space-y-3">
      <div>
        <label class="block text-sm text-gray-600">Email</label>
        <input id="email" type="email" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Password</label>
        <input id="password" type="password" class="w-full border rounded p-2" required>
      </div>
      <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Sign in</button>
      <p id="login-error" class="text-xs text-red-600 h-4"></p>
    </form>
  </div>
</div>

<!-- App -->
<div id="app" class="hidden min-h-screen flex flex-col with-bottom-nav md:pb-0">
  <header class="bg-gray-900 text-white">
    <div class="container mx-auto p-3 flex items-center justify-between">
      <h2 class="font-semibold">After-School Manager</h2>
      <div class="flex items-center gap-3">
        <span id="user-email" class="text-sm text-gray-300"></span>
        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm">Sign out</button>
      </div>
    </div>
  </header>

  <!-- DESKTOP: 3 columns; MOBILE: horizontal slider with 3 slides -->
  <main class="container mx-auto p-4 flex-1">
    <!-- Desktop grid wrapper -->
    <div class="hidden md:grid md:grid-cols-3 gap-4">
      <!-- Classes -->
      <section class="bg-white p-4 rounded-lg shadow">
        <div class="flex justify-between items-center mb-3">
          <div class="flex p-1 bg-gray-200 rounded-lg">
            <button id="view-by-class" class="px-3 py-1.5 text-sm font-medium bg-white text-blue-700 rounded-md shadow-sm">By Class</button>
            <button id="view-by-student" class="px-3 py-1.5 text-sm font-medium text-gray-700">By Student</button>
          </div>
          <button id="primary-add-btn" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm">Add Class</button>
        </div>
        <div id="col1-title" class="text-lg font-semibold mb-2">Classes</div>
        <div id="col1-list" class="scrolling-list overflow-y-auto space-y-2"></div>
      </section>

      <!-- Students -->
      <section class="bg-white p-4 rounded-lg shadow">
        <div class="flex justify-between items-center mb-3">
          <div>
            <div id="col2-title" class="text-lg font-semibold">Students</div>
            <div id="col2-subtitle" class="text-sm text-gray-500">Select a class</div>
          </div>
          <div id="col2-btns" class="flex items-center gap-2">
            <button id="add-existing-student-btn" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded text-sm" disabled>Add Existing</button>
            <button id="add-new-student-btn" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm" disabled>Add New</button>
          </div>
        </div>
        <div id="col2-list" class="scrolling-list overflow-y-auto space-y-2"></div>
      </section>

      <!-- Contacts -->
      <section class="bg-white p-4 rounded-lg shadow">
        <div class="flex justify-between items-center mb-3">
          <div>
            <div class="text-lg font-semibold">Parents / Contacts</div>
            <div id="col3-subtitle" class="text-sm text-gray-500">Select a student</div>
          </div>
          <button id="add-contact-btn" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm" disabled>Add Contact</button>
        </div>
        <div id="col3-list" class="scrolling-list overflow-y-auto space-y-2"></div>
      </section>
    </div>

    <!-- MOBILE SLIDER -->
    <div class="md:hidden slider">
      <div id="slides" class="slides">
        <!-- Slide 1: Classes -->
        <section class="slide bg-white p-4 rounded-lg shadow mr-4">
          <div class="flex justify-between items-center mb-3">
            <div class="flex p-1 bg-gray-200 rounded-lg">
              <button id="view-by-class-m" class="px-3 py-1.5 text-sm font-medium bg-white text-blue-700 rounded-md shadow-sm">By Class</button>
              <button id="view-by-student-m" class="px-3 py-1.5 text-sm font-medium text-gray-700">By Student</button>
            </div>
            <button id="primary-add-btn-m" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm">Add Class</button>
          </div>
          <div id="col1-title-m" class="text-lg font-semibold mb-2">Classes</div>
          <div id="col1-list-m" class="scrolling-list overflow-y-auto space-y-2"></div>
        </section>

        <!-- Slide 2: Students -->
        <section class="slide bg-white p-4 rounded-lg shadow mx-4">
          <div class="flex justify-between items-center mb-3">
            <div>
              <div id="col2-title-m" class="text-lg font-semibold">Students</div>
              <div id="col2-subtitle-m" class="text-sm text-gray-500">Select a class</div>
            </div>
            <div id="col2-btns-m" class="flex items-center gap-2">
              <button id="add-existing-student-btn-m" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded text-sm" disabled>Add Existing</button>
              <button id="add-new-student-btn-m" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm" disabled>Add New</button>
            </div>
          </div>
          <div id="col2-list-m" class="scrolling-list overflow-y-auto space-y-2"></div>
        </section>

        <!-- Slide 3: Contacts -->
        <section class="slide bg-white p-4 rounded-lg shadow ml-4">
          <div class="flex justify-between items-center mb-3">
            <div>
              <div class="text-lg font-semibold">Parents / Contacts</div>
              <div id="col3-subtitle-m" class="text-sm text-gray-500">Select a student</div>
            </div>
            <button id="add-contact-btn-m" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm" disabled>Add Contact</button>
          </div>
          <div id="col3-list-m" class="scrolling-list overflow-y-auto space-y-2"></div>
        </section>
      </div>
    </div>
  </main>

  <!-- Bottom Mobile 3-tab menu -->
  <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow z-40">
    <div class="max-w-xl mx-auto grid grid-cols-3 text-center">
      <button id="tab-classes" class="py-3 text-sm font-medium tab-active">Classes</button>
      <button id="tab-students" class="py-3 text-sm font-medium">Students</button>
      <button id="tab-contacts" class="py-3 text-sm font-medium">Contacts</button>
    </div>
  </nav>
</div>

<!-- Modals: Add/Edit Class, Add/Edit Student, Add Existing, Add/Edit Contact -->
<div id="add-class-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Add Class</h3>
      <button class="close-modal text-gray-500" data-modal="add-class-modal">&times;</button>
    </div>
    <form id="add-class-form" class="space-y-3">
      <div>
        <label class="block text-sm text-gray-600">Class Name</label>
        <input id="class-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Teacher</label>
        <input id="teacher-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="add-class-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<div id="edit-class-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Edit Class</h3>
      <button class="close-modal text-gray-500" data-modal="edit-class-modal">&times;</button>
    </div>
    <form id="edit-class-form" class="space-y-3">
      <input type="hidden" id="edit-class-id">
      <div>
        <label class="block text-sm text-gray-600">Class Name</label>
        <input id="edit-class-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Teacher</label>
        <input id="edit-teacher-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="edit-class-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Update</button>
      </div>
    </form>
  </div>
</div>

<div id="add-student-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Add New Student</h3>
      <button class="close-modal text-gray-500" data-modal="add-student-modal">&times;</button>
    </div>
    <form id="add-student-form" class="space-y-3">
      <div>
        <label class="block text-sm text-gray-600">Student Name</label>
        <input id="student-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="add-student-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<div id="edit-student-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
   <div class="flex justify-between items-center mb-3">
     <h3 class="text-lg font-semibold">Edit Student</h3>
     <button class="close-modal text-gray-500" data-modal="edit-student-modal">&times;</button>
   </div>
   <form id="edit-student-form" class="space-y-3">
     <input type="hidden" id="edit-student-id">
     <div>
       <label class="block text-sm text-gray-600">Student Name</label>
       <input id="edit-student-name" type="text" class="w-full border rounded p-2" required>
     </div>
     <div class="flex justify-end gap-2">
       <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="edit-student-modal">Cancel</button>
       <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Update</button>
     </div>
   </form>
  </div>
</div>

<div id="add-existing-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Add Existing Student</h3>
      <button class="close-modal text-gray-500" data-modal="add-existing-modal">&times;</button>
    </div>
    <form id="add-existing-form" class="space-y-3">
      <div>
        <label class="block text-sm text-gray-600">Select Student</label>
        <select id="existing-student-select" class="w-full border rounded p-2" required></select>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="add-existing-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Add</button>
      </div>
    </form>
  </div>
</div>

<div id="add-contact-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Add Contact</h3>
      <button class="close-modal text-gray-500" data-modal="add-contact-modal">&times;</button>
    </div>
    <form id="add-contact-form" class="space-y-3">
      <div>
        <label class="block text-sm text-gray-600">Name</label>
        <input id="contact-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Email</label>
        <input id="contact-email" type="email" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Phone</label>
        <input id="contact-phone" type="tel" class="w-full border rounded p-2">
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="add-contact-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<div id="edit-contact-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">Edit Contact</h3>
      <button class="close-modal text-gray-500" data-modal="edit-contact-modal">&times;</button>
    </div>
    <form id="edit-contact-form" class="space-y-3">
      <input type="hidden" id="edit-contact-id">
      <div>
        <label class="block text-sm text-gray-600">Name</label>
        <input id="edit-contact-name" type="text" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Email</label>
        <input id="edit-contact-email" type="email" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Phone</label>
        <input id="edit-contact-phone" type="tel" class="w-full border rounded p-2">
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" class="close-modal border px-3 py-1.5 rounded" data-modal="edit-contact-modal">Cancel</button>
        <button class="bg-blue-600 text-white px-3 py-1.5 rounded">Update</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
/* ------------- Firebase ------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
  initializeAuth, browserLocalPersistence, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc,
  onSnapshot, query, where, writeBatch, arrayUnion, arrayRemove
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ---- YOUR working keys here ---- */
const firebaseConfig = {
  apiKey: "AIzaSyAYDMyMAw7wf3i28C-hQ_iRZRVdMiXmaLk",
  authDomain: "dance-classes-97ad7.firebaseapp.com",
  projectId: "dance-classes-97ad7",
  storageBucket: "dance-classes-97ad7.appspot.com",
  messagingSenderId: "1041555303856",
  appId: "1:1041555303856:web:5b80e0497eacaf161b7a75",
};
const ORG = "State-48-Dance";

/* ------------- Init ------------- */
const app = initializeApp(firebaseConfig);
const auth = initializeAuth(app, { persistence: browserLocalPersistence });
const db = getFirestore(app);

/* ------------- Helpers ------------- */
const $ = (id) => document.getElementById(id);
const openModal = (id) => $(id)?.classList.add("flex");
const closeModal = (id) => $(id)?.classList.remove("flex");
const toast = (msg, type="success", ms=2200) => {
  const t=$("toast"), i=$("toast-icon"), m=$("toast-message");
  i.className='inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg';
  i.classList.add(type==="error"?"text-red-600 bg-red-100":"text-green-600 bg-green-100");
  m.textContent=msg; t.classList.remove("hidden"); t.classList.add("flex");
  setTimeout(()=>{ t.classList.add("hidden"); t.classList.remove("flex"); },ms);
};
const isMobile = () => window.matchMedia("(max-width: 767px)").matches;

/* ------------- Slider / Tabs (mobile) ------------- */
const slides = $("slides");
const tabs = { classes:$("tab-classes"), students:$("tab-students"), contacts:$("tab-contacts") };
function setActiveTab(which){
  Object.values(tabs).forEach(b=>b.classList.remove("tab-active"));
  tabs[which].classList.add("tab-active");
  if (isMobile()){
    const idx = which==="classes"?0:(which==="students"?1:2);
    slides.style.transform = `translateX(-${idx*100}%)`;
  }
}
tabs.classes.addEventListener("click", ()=>setActiveTab("classes"));
tabs.students.addEventListener("click", ()=>setActiveTab("students"));
tabs.contacts.addEventListener("click", ()=>setActiveTab("contacts"));
window.addEventListener("resize", ()=>{
  if (!isMobile()) slides.style.transform = "none";
});

/* ------------- Paths ------------- */
const classesCol = () => collection(db, `organizations/${ORG}/classes`);
const studentsCol = () => collection(db, `organizations/${ORG}/students`);
const parentsCol  = () => collection(db, `organizations/${ORG}/parents`);

/* ------------- State ------------- */
let currentView = "class"; // "class" | "student"
let currentClassId = null;
let currentStudentId = null;
let allClasses = [];
let allStudents = [];
let unsubC = null, unsubS = null;

/* ------------- Auth ------------- */
onAuthStateChanged(auth, (user)=>{
  if (user){
    $("user-email").textContent = user.email || "";
    $("auth").classList.add("hidden");
    $("app").classList.remove("hidden");
    startListeners();
    renderPrimary();
  } else {
    $("app").classList.add("hidden");
    $("auth").classList.remove("hidden");
    stopListeners(); allClasses=[]; allStudents=[]; currentClassId=null; currentStudentId=null;
  }
});
$("login-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const btn=$("login-btn"), err=$("login-error");
  btn.disabled=true; err.textContent="";
  try {
    await signInWithEmailAndPassword(auth, $("email").value, $("password").value);
    if (location.search) history.replaceState({}, "", location.pathname);
    toast("Signed in");
  } catch(ex){ err.textContent = ex.message || "Login failed"; toast("Login failed","error"); }
  finally { btn.disabled=false; }
});
$("logout-btn").addEventListener("click", async()=>{ await signOut(auth); toast("Signed out"); });

/* ------------- Listeners ------------- */
function startListeners(){
  if (!unsubC){
    unsubC = onSnapshot(classesCol(), snap=>{
      allClasses = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderPrimary();
      if (currentClassId) renderStudentsForClass(currentClassId);
      if (currentStudentId) renderContacts(currentStudentId);
    });
  }
  if (!unsubS){
    unsubS = onSnapshot(studentsCol(), snap=>{
      allStudents = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderPrimary();
      if (currentClassId) renderStudentsForClass(currentClassId);
      if (currentStudentId){ renderEnrolledClasses(currentStudentId); renderContacts(currentStudentId); }
    });
  }
}
function stopListeners(){ if (unsubC){unsubC();unsubC=null;} if (unsubS){unsubS();unsubS=null;} }

/* ------------- Rendering (both desktop & mobile) ------------- */
function renderPrimary(){
  // toggle headings/buttons by view (applies to both desktop and mobile titles)
  const classMode = currentView==="class";
  // Titles
  $("col1-title").textContent = classMode? "Classes":"All Students";
  $("col1-title-m").textContent = classMode? "Classes":"All Students";
  $("col2-title").textContent = classMode? "Students":"Enrolled In";
  $("col2-title-m").textContent = classMode? "Students":"Enrolled In";
  $("col2-subtitle").textContent = classMode? "Select a class":"Select a student";
  $("col2-subtitle-m").textContent = classMode? "Select a class":"Select a student";
  // Buttons
  $("col2-btns").classList.toggle("hidden", !classMode);
  $("col2-btns-m").classList.toggle("hidden", !classMode);
  $("primary-add-btn").textContent = classMode? "Add Class":"Add Student";
  $("primary-add-btn-m").textContent = classMode? "Add Class":"Add Student";

  if (classMode){ renderClassLists(); clearStudentsPane(); clearContactsPane(); }
  else { renderStudentLists(); clearEnrolledPane(); clearContactsPane(); }
  // keep mobile tab stable when switching view toggles
  if (isMobile()) setActiveTab("classes");
}

function renderClassLists(){
  const lists = [ $("col1-list"), $("col1-list-m") ];
  lists.forEach(list=>{
    list.innerHTML="";
    if (allClasses.length===0){ list.innerHTML=`<p class="text-gray-500 text-center">No classes yet.</p>`; return; }
    [...allClasses].sort((a,b)=>a.name.localeCompare(b.name)).forEach(c=>{
      const el = document.createElement("div");
      el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentClassId===c.id?"bg-blue-50 border-blue-300":""}`;
      el.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="font-medium text-gray-800">${c.name}</span>
          <div class="flex gap-2">
            <button class="edit-class px-2 py-1 text-sm bg-gray-200 rounded" title="Edit">Edit</button>
            <button class="del-class px-2 py-1 text-sm bg-red-600 text-white rounded" title="Delete">Del</button>
          </div>
        </div>
        <p class="text-sm text-gray-600">${c.teacher||""}</p>`;
      el.addEventListener("click", ()=>selectClass(c.id, c.name));
      el.querySelector(".edit-class").addEventListener("click", e=>{e.stopPropagation(); openEditClass(c.id);});
      el.querySelector(".del-class").addEventListener("click", e=>{e.stopPropagation(); deleteClass(c.id, c.name);});
      list.appendChild(el);
    });
  });
}

function renderStudentLists(){
  const lists = [ $("col1-list"), $("col1-list-m") ];
  lists.forEach(list=>{
    list.innerHTML="";
    if (allStudents.length===0){ list.innerHTML=`<p class="text-gray-500 text-center">No students yet.</p>`; return; }
    [...allStudents].sort((a,b)=>a.name.localeCompare(b.name)).forEach(s=>{
      const el = document.createElement("div");
      el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentStudentId===s.id?"bg-blue-50 border-blue-300":""}`;
      el.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="font-medium text-gray-800">${s.name}</span>
          <div class="flex gap-2">
            <button class="edit-student px-2 py-1 text-sm bg-gray-200 rounded" title="Edit">Edit</button>
            <button class="del-student px-2 py-1 text-sm bg-red-600 text-white rounded" title="Delete">Del</button>
          </div>
        </div>`;
      el.addEventListener("click", ()=>selectStudent(s.id, s.name));
      el.querySelector(".edit-student").addEventListener("click", e=>{e.stopPropagation(); openEditStudent(s.id);});
      el.querySelector(".del-student").addEventListener("click", e=>{e.stopPropagation(); deleteStudent(s.id, s.name);});
      list.appendChild(el);
    });
  });
}

function clearStudentsPane(){
  $("col2-subtitle").textContent = "Select a class";
  $("col2-subtitle-m").textContent = "Select a class";
  $("col2-list").innerHTML = "";
  $("col2-list-m").innerHTML = "";
  $("add-new-student-btn").disabled = true;
  $("add-existing-student-btn").disabled = true;
  $("add-new-student-btn-m").disabled = true;
  $("add-existing-student-btn-m").disabled = true;
}
function clearEnrolledPane(){
  $("col2-subtitle").textContent = "Select a student";
  $("col2-subtitle-m").textContent = "Select a student";
  $("col2-list").innerHTML = "";
  $("col2-list-m").innerHTML = "";
}
function clearContactsPane(){
  $("col3-subtitle").textContent = "Select a student";
  $("col3-subtitle-m").textContent = "Select a student";
  $("col3-list").innerHTML = "";
  $("col3-list-m").innerHTML = "";
  $("add-contact-btn").disabled = true;
  $("add-contact-btn-m").disabled = true;
}

function renderStudentsForClass(classId){
  const renderInto = [$("col2-list"), $("col2-list-m")];
  const c = allClasses.find(x=>x.id===classId);
  renderInto.forEach(list=>{
    list.innerHTML = "";
    if (!c || !c.students || c.students.length===0) { list.innerHTML = `<p class="text-gray-500 text-center">No students in this class.</p>`; return; }
    const students = allStudents.filter(s => c.students.includes(s.id)).sort((a,b)=>a.name.localeCompare(b.name));
    students.forEach(s => {
      const el = document.createElement("div");
      el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentStudentId===s.id?"bg-blue-50 border-blue-300":""}`;
      el.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="font-medium text-gray-800">${s.name}</span>
          <div class="flex gap-2">
            <button class="edit-student px-2 py-1 text-sm bg-gray-200 rounded">Edit</button>
            <button class="remove-student px-2 py-1 text-sm bg-yellow-600 text-white rounded">Remove</button>
          </div>
        </div>`;
      el.addEventListener("click", ()=>selectStudent(s.id, s.name));
      el.querySelector(".edit-student").addEventListener("click",(e)=>{ e.stopPropagation(); openEditStudent(s.id); });
      el.querySelector(".remove-student").addEventListener("click",(e)=>{ e.stopPropagation(); removeStudentFromClass(s.id, s.name); });
      list.appendChild(el);
    });
  });

  // enable add buttons
  ["add-new-student-btn","add-existing-student-btn","add-new-student-btn-m","add-existing-student-btn-m"].forEach(id => $(id).disabled=false);
}

function renderEnrolledClasses(studentId){
  const renderInto = [$("col2-list"), $("col2-list-m")];
  const classes = allClasses.filter(c => (c.students||[]).includes(studentId)).sort((a,b)=>a.name.localeCompare(b.name));
  renderInto.forEach(list=>{
    list.innerHTML = "";
    if (classes.length===0){ list.innerHTML = `<p class="text-gray-500 text-center">Not enrolled in any classes.</p>`; return; }
    classes.forEach(c => {
      const el = document.createElement("div");
      el.className = `p-3 rounded-lg border border-gray-200`;
      el.textContent = `${c.name} â€” ${c.teacher||""}`;
      list.appendChild(el);
    });
  });
}

async function renderContacts(studentId){
  const renderInto = [$("col3-list"), $("col3-list-m")];
  const s = allStudents.find(x=>x.id===studentId);
  $("col3-subtitle").textContent = s ? `For: ${s.name}` : "Select a student";
  $("col3-subtitle-m").textContent = s ? `For: ${s.name}` : "Select a student";
  $("add-contact-btn").disabled = !studentId;
  $("add-contact-btn-m").disabled = !studentId;
  renderInto.forEach(l=>l.innerHTML="");
  if (!s || !s.parents || s.parents.length===0){
    renderInto.forEach(l=>l.innerHTML=`<p class="text-gray-500 text-center">No contacts for this student.</p>`);
    return;
  }
  try {
    let contacts = [];
    for (let i=0;i<s.parents.length;i+=30){
      const chunk = s.parents.slice(i,i+30);
      const qy = query(parentsCol(), where("__name__", "in", chunk));
      const qs = await getDocs(qy);
      qs.forEach(d => contacts.push({ id: d.id, ...d.data() }));
    }
    contacts.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    renderInto.forEach(list=>{
      list.innerHTML = "";
      contacts.forEach(c=>{
        const el = document.createElement("div");
        el.className = "p-3 rounded-lg border border-gray-200";
        el.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="font-medium text-gray-800">${c.name||""}</div>
              <div class="text-sm text-gray-600">${c.email||""}</div>
              <div class="text-sm text-gray-600">${c.phone||""}</div>
            </div>
            <div class="flex gap-2">
              <button class="edit-contact px-2 py-1 text-sm bg-gray-200 rounded">Edit</button>
              <button class="del-contact px-2 py-1 text-sm bg-red-600 text-white rounded">Del</button>
            </div>
          </div>`;
        el.querySelector(".edit-contact").addEventListener("click", ()=>openEditContact(c));
        el.querySelector(".del-contact").addEventListener("click", ()=>deleteContact(c.id));
        list.appendChild(el);
      });
    });
  } catch(err){ console.error(err); toast("Failed to load contacts","error"); }
}

/* ------------- Selections ------------- */
function selectClass(id, name){
  currentClassId = id; currentStudentId = null;
  $("col2-subtitle").textContent = `For: ${name}`;
  $("col2-subtitle-m").textContent = `For: ${name}`;
  renderStudentsForClass(id);
  clearContactsPane();
  if (isMobile()) setActiveTab("students");
}
function selectStudent(id, name){
  currentStudentId = id;
  $("col3-subtitle").textContent = `For: ${name}`;
  $("col3-subtitle-m").textContent = `For: ${name}`;
  if (currentView==="student") renderEnrolledClasses(id);
  renderContacts(id);
  if (isMobile()) setActiveTab("contacts");
}

/* ------------- View toggle (desktop & mobile headers) ------------- */
$("view-by-class").addEventListener("click", ()=>{ currentView="class"; renderPrimary(); });
$("view-by-student").addEventListener("click", ()=>{ currentView="student"; renderPrimary(); });
$("view-by-class-m").addEventListener("click", ()=>{ currentView="class"; renderPrimary(); });
$("view-by-student-m").addEventListener("click", ()=>{ currentView="student"; renderPrimary(); });

/* ------------- Add buttons (desktop & mobile) ------------- */
$("primary-add-btn").addEventListener("click", ()=>{ currentView==="class" ? openModal("add-class-modal") : openModal("add-student-modal"); });
$("primary-add-btn-m").addEventListener("click", ()=>{ currentView==="class" ? openModal("add-class-modal") : openModal("add-student-modal"); });

/* ------------- CRUD: Classes ------------- */
$("add-class-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = $("class-name").value.trim();
  const teacher = $("teacher-name").value.trim();
  try {
    await addDoc(classesCol(), { name, teacher, students: [] });
    closeModal("add-class-modal"); e.target.reset(); toast("Class added");
  } catch(err){ console.error(err); toast("Failed to add class","error"); }
});
function openEditClass(id){
  const c = allClasses.find(x=>x.id===id); if(!c) return;
  $("edit-class-id").value = id;
  $("edit-class-name").value = c.name || "";
  $("edit-teacher-name").value = c.teacher || "";
  openModal("edit-class-modal");
}
$("edit-class-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const id = $("edit-class-id").value;
  const name = $("edit-class-name").value.trim();
  const teacher = $("edit-teacher-name").value.trim();
  try {
    await updateDoc(doc(classesCol(), id), { name, teacher });
    closeModal("edit-class-modal"); toast("Class updated");
  } catch(err){ console.error(err); toast("Failed to update","error"); }
});
async function deleteClass(id, name){
  if (!confirm(`Delete class "${name}"?`)) return;
  try {
    const batch = writeBatch(db);
    // remove class ref from students.classes
    const sDocs = await getDocs(studentsCol());
    sDocs.forEach(d => {
      const data = d.data();
      if ((data.classes||[]).includes(id)) batch.update(d.ref, { classes: arrayRemove(id) });
    });
    batch.delete(doc(classesCol(), id));
    await batch.commit();
    if (currentClassId===id) { currentClassId=null; clearStudentsPane(); }
    toast("Class deleted");
  } catch(err){ console.error(err); toast("Delete failed","error"); }
}

/* ------------- CRUD: Students ------------- */
$("add-student-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = $("student-name").value.trim();
  try {
    const studentRef = await addDoc(studentsCol(), { name, parents: [], classes: [] });
    if (currentView==="class" && currentClassId) {
      const batch = writeBatch(db);
      batch.update(doc(classesCol(), currentClassId), { students: arrayUnion(studentRef.id) });
      batch.update(studentRef, { classes: arrayUnion(currentClassId) });
      await batch.commit();
    }
    closeModal("add-student-modal"); e.target.reset(); toast("Student added");
  } catch(err){ console.error(err); toast("Failed to add student","error"); }
});
function openEditStudent(id){
  const s = allStudents.find(x=>x.id===id); if(!s) return;
  $("edit-student-id").value = id;
  $("edit-student-name").value = s.name || "";
  openModal("edit-student-modal");
}
$("edit-student-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const id = $("edit-student-id").value;
  const name = $("edit-student-name").value.trim();
  try {
    await updateDoc(doc(studentsCol(), id), { name });
    closeModal("edit-student-modal"); toast("Student updated");
  } catch(err){ console.error(err); toast("Failed to update student","error"); }
});
$("add-new-student-btn").addEventListener("click", ()=> openModal("add-student-modal"));
$("add-new-student-btn-m").addEventListener("click", ()=> openModal("add-student-modal"));
$("add-existing-student-btn").addEventListener("click", async ()=>{ if (!currentClassId) return; await populateExistingSelect(); openModal("add-existing-modal"); });
$("add-existing-student-btn-m").addEventListener("click", async ()=>{ if (!currentClassId) return; await populateExistingSelect(); openModal("add-existing-modal"); });

async function populateExistingSelect(){
  const select = $("existing-student-select");
  select.innerHTML = "";
  const c = allClasses.find(x=>x.id===currentClassId);
  const enrolled = new Set(c?.students||[]);
  const options = allStudents.filter(s=>!enrolled.has(s.id)).sort((a,b)=>a.name.localeCompare(b.name));
  if (options.length===0){ select.innerHTML = `<option value="">No available students</option>`; return; }
  options.forEach(s=>{ const opt=document.createElement("option"); opt.value=s.id; opt.textContent=s.name; select.appendChild(opt); });
}
$("add-existing-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const sid = $("existing-student-select").value;
  if (!sid || !currentClassId) return;
  try {
    const batch = writeBatch(db);
    batch.update(doc(classesCol(), currentClassId), { students: arrayUnion(sid) });
    batch.update(doc(studentsCol(), sid), { classes: arrayUnion(currentClassId) });
    await batch.commit();
    closeModal("add-existing-modal");
    toast("Student added to class");
  } catch(err){ console.error(err); toast("Failed to add to class","error"); }
});

async function removeStudentFromClass(studentId, studentName){
  if (!currentClassId) return;
  if (!confirm(`Remove ${studentName} from this class?`)) return;
  try {
    const batch = writeBatch(db);
    batch.update(doc(classesCol(), currentClassId), { students: arrayRemove(studentId) });
    batch.update(doc(studentsCol(), studentId), { classes: arrayRemove(currentClassId) });
    await batch.commit();
    if (currentStudentId===studentId) clearContactsPane();
    toast("Removed from class");
  } catch(err){ console.error(err); toast("Failed to remove","error"); }
}

/* ------------- Contacts ------------- */
$("add-contact-btn").addEventListener("click", ()=>{ if (!currentStudentId) return; openModal("add-contact-modal"); });
$("add-contact-btn-m").addEventListener("click", ()=>{ if (!currentStudentId) return; openModal("add-contact-modal"); });
$("add-contact-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if (!currentStudentId) return;
  const name = $("contact-name").value.trim();
  const email = $("contact-email").value.trim();
  const phone = $("contact-phone").value.trim();
  try {
    const parentRef = await addDoc(parentsCol(), { name, email, phone });
    await updateDoc(doc(studentsCol(), currentStudentId), { parents: arrayUnion(parentRef.id) });
    closeModal("add-contact-modal"); e.target.reset(); toast("Contact added");
  } catch(err){ console.error(err); toast("Failed to add contact","error"); }
});
function openEditContact(contact){
  $("edit-contact-id").value = contact.id;
  $("edit-contact-name").value = contact.name || "";
  $("edit-contact-email").value = contact.email || "";
  $("edit-contact-phone").value = contact.phone || "";
  openModal("edit-contact-modal");
}
$("edit-contact-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const id = $("edit-contact-id").value;
  const name = $("edit-contact-name").value.trim();
  const email = $("edit-contact-email").value.trim();
  const phone = $("edit-contact-phone").value.trim();
  try {
    await updateDoc(doc(parentsCol(), id), { name, email, phone });
    closeModal("edit-contact-modal"); toast("Contact updated");
  } catch(err){ console.error(err); toast("Failed to update contact","error"); }
});
async function deleteContact(id){
  if (!currentStudentId) return;
  if (!confirm("Delete this contact?")) return;
  try {
    const batch = writeBatch(db);
    batch.update(doc(studentsCol(), currentStudentId), { parents: arrayRemove(id) });
    batch.delete(doc(parentsCol(), id));
    await batch.commit();
    toast("Contact deleted");
  } catch(err){ console.error(err); toast("Failed to delete contact","error"); }
}

/* ------------- Desktop/Mobile headers add ------------- */
$("view-by-class").addEventListener("click", ()=>{ currentView="class"; renderPrimary(); });
$("view-by-student").addEventListener("click", ()=>{ currentView="student"; renderPrimary(); });
$("view-by-class-m").addEventListener("click", ()=>{ currentView="class"; renderPrimary(); });
$("view-by-student-m").addEventListener("click", ()=>{ currentView="student"; renderPrimary(); });

/* ------------- Add button mapping ------------- */
$("primary-add-btn").addEventListener("click", ()=>{ currentView==="class" ? openModal("add-class-modal") : openModal("add-student-modal"); });
$("primary-add-btn-m").addEventListener("click", ()=>{ currentView==="class" ? openModal("add-class-modal") : openModal("add-student-modal"); });

/* ------------- Initial ------------- */
setActiveTab("classes");
</script>

</body>
</html>
