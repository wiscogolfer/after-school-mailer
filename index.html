<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Classes • Students • Contacts</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:"#eef6ff",100:"#d9eaff",200:"#b7d5ff",300:"#8dbeff",400:"#5aa1ff",
              500:"#2f84ff",600:"#2068db",700:"#1b53ad",800:"#1b478a",900:"#1b3b6f"
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    .icon-btn{ @apply p-1 rounded hover:bg-gray-100 transition; }
    .pill{ @apply text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600; }
    .sticky-subhead{ @apply sticky top-0 z-10 bg-white/80 backdrop-blur border-b; }
    .error-message{ @apply text-sm text-red-600; }
    .success-message{ @apply text-sm text-green-600; }
    .stripe-id-label{ @apply font-semibold text-gray-700 mr-1; }
    .stripe-id-display{ @apply mt-1 text-xs text-gray-700 space-y-0.5; }
    .manual-map-section{ @apply mt-2; }

    /* Mobile tabbar */
    .tabbar{ @apply fixed bottom-0 left-0 right-0 bg-white border-t shadow-sm grid grid-cols-3 gap-0; }
    .tabbar button{ @apply py-2 text-xs flex flex-col items-center justify-center; }
    .tab-active{ @apply text-brand-600 font-semibold; }

    /* Three-column grid on desktop, single on mobile */
    .app-grid{ @apply grid grid-cols-1 md:grid-cols-3 gap-4 pb-16 md:pb-0; }
    .panel{ @apply bg-white rounded-2xl shadow-sm border; }
    .panel-head{ @apply sticky-subhead px-3 py-2 flex items-center justify-between; }
    .panel-body{ @apply p-3; }
    .list-item{ @apply border-b last:border-b-0 py-2; }
    .input{ @apply border rounded px-2 py-1 text-sm w-full; }
    .btn{ @apply inline-flex items-center justify-center rounded-lg px-3 py-1.5 text-sm border bg-white hover:bg-gray-50 transition; }
    .btn-primary{ @apply bg-brand-600 text-white border-brand-600 hover:bg-brand-700; }
    .btn-ghost{ @apply text-gray-700; }
    .badge{ @apply inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600; }
    .kbd{ @apply text-[10px] border px-1.5 py-0.5 rounded bg-gray-50 text-gray-600; }
    .divider{ @apply h-px bg-gray-200 my-3; }
    .label{ @apply text-xs text-gray-500; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-brand-600 text-white grid place-items-center font-bold">S48</div>
      <div>
        <h1 class="text-lg font-semibold leading-5">Classes • Students • Contacts</h1>
        <p class="text-xs text-gray-500 -mt-0.5">BrightStart Admin</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="open-email" class="btn" title="Email"><i class="fa-regular fa-envelope mr-2"></i>Email</button>
      <button id="manage-users" class="btn" title="User Management"><i class="fa-solid fa-users-gear mr-2"></i>Users</button>
      <div id="auth-area" class="ml-2"></div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4">
    <!-- Desktop grid / Mobile single column -->
    <div class="app-grid">
      <!-- CLASSES -->
      <section id="col-classes" class="panel">
        <div class="panel-head">
          <div class="flex items-center gap-2">
            <h2 class="font-semibold">Classes</h2>
            <span class="pill" id="class-count">0</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="add-class" class="btn-primary btn"><i class="fa-solid fa-plus mr-2"></i>Add</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="mb-2 flex gap-2">
            <input id="class-search" class="input" placeholder="Search classes…"/>
            <button id="class-refresh" class="btn"><i class="fa-solid fa-rotate"></i></button>
          </div>
          <div id="class-list" class="divide-y"></div>
        </div>
      </section>

      <!-- STUDENTS -->
      <section id="col-students" class="panel">
        <div class="panel-head">
          <div class="flex items-center gap-2">
            <h2 class="font-semibold">Students</h2>
            <span class="pill" id="student-count">0</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="add-student" class="btn-primary btn"><i class="fa-solid fa-plus mr-2"></i>Add</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="mb-2 flex gap-2">
            <input id="student-search" class="input" placeholder="Search students…"/>
            <button id="student-refresh" class="btn"><i class="fa-solid fa-rotate"></i></button>
          </div>
          <div id="student-list" class="divide-y"></div>
        </div>
      </section>

      <!-- CONTACTS + STRIPE (panel lives here below contacts) -->
      <section id="col-contacts" class="panel">
        <div class="panel-head">
          <div class="flex items-center gap-2">
            <h2 class="font-semibold">Parents / Contacts</h2>
            <span class="pill" id="contact-count">0</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="add-contact" class="btn-primary btn"><i class="fa-solid fa-plus mr-2"></i>Add</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="mb-2 flex gap-2">
            <input id="contact-search" class="input" placeholder="Search contacts…"/>
            <button id="contact-refresh" class="btn"><i class="fa-solid fa-rotate"></i></button>
          </div>
          <div id="contact-list" class="divide-y"></div>

          <!-- Stripe mapping & invoicing lives UNDER contacts -->
          <div class="divider"></div>
          <div>
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold flex items-center gap-2">
                <i class="fa-brands fa-stripe"></i> Billing (Two accounts)
              </h3>
              <div class="text-xs">
                <span class="badge">Halle Dance: <span id="badge-halle">connected</span></span>
                <span class="badge">State48 Theatre: <span id="badge-state48">connected</span></span>
              </div>
            </div>

            <!-- Account context selector -->
            <div class="grid md:grid-cols-3 gap-3">
              <div class="md:col-span-1">
                <label class="label">Account context</label>
                <select id="account-context-select" class="input">
                  <option value="halle_dance">Halle Dance</option>
                  <option value="state48arts.org">State48 Theatre</option>
                </select>
                <p class="text-[11px] text-gray-500 mt-1">Affects search/list actions below.</p>
              </div>

              <!-- Search Stripe customers by email/name -->
              <div class="md:col-span-2">
                <label class="label">Find Stripe customer (by email or name)</label>
                <div class="flex gap-2">
                  <input id="stripe-search-q" class="input" placeholder="e.g. parent@example.com"/>
                  <button id="stripe-search-btn" class="btn"><i class="fa-solid fa-magnifying-glass mr-2"></i>Search</button>
                </div>
                <div id="stripe-search-results" class="mt-2 text-sm"></div>
              </div>
            </div>

            <div class="divider"></div>

            <!-- Selected Student Billing Summary -->
            <div>
              <div class="flex items-center justify-between">
                <h4 class="font-semibold">Selected student</h4>
                <span id="selected-student-pill" class="pill">None</span>
              </div>
              <div id="student-billing-summary" class="mt-2 text-sm text-gray-700">
                <p>Select a student from Students panel to view or map Stripe customers. Their current IDs per account will appear here.</p>
              </div>
            </div>

            <div class="divider"></div>

            <!-- Invoice quick form -->
            <form id="invoice-form" class="space-y-2">
              <div class="grid md:grid-cols-3 gap-3">
                <div>
                  <label class="label">Student</label>
                  <select id="invoice-student-id" class="input"></select>
                </div>
                <div>
                  <label class="label">Bill to Parent</label>
                  <select id="invoice-parent-select" class="input" disabled></select>
                </div>
                <div>
                  <label class="label">Account</label>
                  <select id="invoice-account-select" class="input">
                    <option value="halle_dance">Halle Dance</option>
                    <option value="state48arts.org">State48 Theatre</option>
                  </select>
                </div>
              </div>
              <div class="grid md:grid-cols-3 gap-3">
                <div>
                  <label class="label">Amount (USD)</label>
                  <input id="invoice-amount" class="input" type="number" step="0.01" placeholder="25.00"/>
                </div>
                <div class="md:col-span-2">
                  <label class="label">Description</label>
                  <input id="invoice-description" class="input" placeholder="Private lesson 10/31"/>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button id="create-invoice-btn" class="btn-primary">Create & Send Invoice</button>
                <span id="invoice-status" class="text-sm"></span>
              </div>
            </form>

            <div class="divider"></div>

            <!-- Lists -->
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <h4 class="font-semibold mb-1">Recent Invoices</h4>
                <div id="invoice-list" class="text-sm space-y-2"></div>
              </div>
              <div>
                <h4 class="font-semibold mb-1">Active Subscriptions</h4>
                <div id="subscription-list" class="text-sm space-y-2"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Mobile Tabbar -->
  <nav class="tabbar md:hidden" role="tablist" aria-label="Main">
    <button id="tab-classes" class="tab-active" aria-controls="col-classes"><i class="fa-solid fa-chalkboard-user mb-0.5"></i><span>Classes</span></button>
    <button id="tab-students" aria-controls="col-students"><i class="fa-solid fa-children mb-0.5"></i><span>Students</span></button>
    <button id="tab-contacts" aria-controls="col-contacts"><i class="fa-regular fa-address-book mb-0.5"></i><span>Contacts</span></button>
  </nav>

  <!-- Email Modal -->
  <dialog id="email-modal" class="rounded-2xl shadow-xl w-[min(680px,92vw)] p-0">
    <form method="dialog" class="p-4 border-b flex items-center justify-between">
      <h3 class="font-semibold">Send Email</h3>
      <button class="icon-btn" onclick="closeModal('email-modal')"><i class="fa-regular fa-circle-xmark"></i></button>
    </form>
    <div class="p-4 space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="label">To (optional)</label>
          <input id="email-to" class="input" placeholder="one recipient"/>
        </div>
        <div>
          <label class="label">BCC (choose)</label>
          <select id="email-bcc-select" class="input">
            <option value="none">None</option>
            <option value="parents-of-selected-class">Parents of selected class</option>
            <option value="all-parents">All parents</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="label">Reply-To Name</label>
          <input id="email-reply-name" class="input" placeholder="Your name"/>
        </div>
        <div>
          <label class="label">Reply-To Email</label>
          <input id="email-reply-email" class="input" placeholder="you@state48theatre.com"/>
        </div>
      </div>
      <div>
        <label class="label">Subject</label>
        <input id="email-subject" class="input" placeholder="Subject"/>
      </div>
      <div>
        <label class="label">Message</label>
        <textarea id="email-body" class="input h-36"></textarea>
      </div>
      <div class="flex items-center gap-2">
        <button id="email-send" class="btn-primary">Send</button>
        <span id="email-status" class="text-sm"></span>
      </div>
    </div>
  </dialog>

  <!-- Firebase + App Scripts -->
  <script type="module">
    // ===== Firebase (Web v10) =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdToken } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
    import { getFirestore, collection, doc, getDocs, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

    // ----- Config (your working config) -----
    const firebaseConfig = {
      apiKey: "AIzaSyAYDMyMAw7wf3i28C-hQ_iRZRVdMiXmaLk",
      authDomain: "dance-classes-97ad7.firebaseapp.com",
      projectId: "dance-classes-97ad7",
      storageBucket: "dance-classes-97ad7.firebasestorage.app",
      messagingSenderId: "1041555303856",
      appId: "1:1041555303856:web:5b80e0497eacaf161b7a75",
      measurementId: "G-8GL7YEGBBQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ----- Hardcoded env-like config (frontend) -----
    const HARDCODED_CONFIG = {
      serverUrl: "https://after-school-mailer.onrender.com"
    };

    // Stripe account identifiers used throughout
    const ACCOUNT_ID_HALLE = "halle_dance";
    const ACCOUNT_ID_STATE48 = "state48arts.org";

    // ===== Simple toast =====
    const toast = (msg, type='info') => {
      const el = document.createElement('div');
      el.className = `fixed left-1/2 -translate-x-1/2 top-4 z-[100] px-3 py-2 rounded-lg shadow text-sm ${type==='error'?'bg-red-600 text-white': type==='success'?'bg-green-600 text-white':'bg-gray-900 text-white'}`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    };

    // ===== Auth UI =====
    const authArea = document.getElementById('auth-area');
    function renderAuthed(user){
      authArea.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600">${user.displayName || user.email}</span>
          <button id="signout" class="btn">Sign out</button>
        </div>`;
      document.getElementById('signout').onclick = () => signOut(auth);
    }
    function renderAnon(){
      authArea.innerHTML = \`
        <form id="login-form" class="flex items-center gap-2">
          <input id="login-email" class="input !w-44" placeholder="email"/>
          <input id="login-pass" type="password" class="input !w-36" placeholder="password"/>
          <button class="btn-primary">Login</button>
        </form>\`;
      document.getElementById('login-form').onsubmit = async (e)=>{
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-pass').value.trim();
        try{
          await signInWithEmailAndPassword(auth, email, pass);
          toast('Logged in','success');
        }catch(err){ toast(err.message, 'error'); }
      };
    }
    let currentUser = null;
    onAuthStateChanged(auth, (u)=>{
      currentUser = u;
      if(u){ renderAuthed(u); initAppAfterAuth(); } else { renderAnon(); }
    });

    // ===== Collections helpers =====
    const colClasses = collection(db, 'classes');
    const colStudents = collection(db, 'students');
    const colParents = collection(db, 'parents');

    function getParentsCol(){ return colParents; }

    // ===== State caches =====
    let allClassCache = [];
    let allStudentsCache = [];
    let allParentsCache = [];
    let currentClassId = null;
    let currentStudentId = null;
    let currentView = 'class';

    // ===== Rendering =====
    const classListEl = document.getElementById('class-list');
    const studentListEl = document.getElementById('student-list');
    const contactListEl = document.getElementById('contact-list');
    const classCount = document.getElementById('class-count');
    const studentCount = document.getElementById('student-count');
    const contactCount = document.getElementById('contact-count');

    async function refreshClasses(){
      const snap = await getDocs(query(colClasses, orderBy('name')));
      allClassCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
      classCount.textContent = allClassCache.length;
      classListEl.innerHTML = '';
      allClassCache.forEach(c => {
        const el = document.createElement('div');
        el.className = 'list-item flex items-center justify-between';
        el.innerHTML = \`
          <div>
            <div class="font-medium">\${c.name}</div>
            <div class="text-xs text-gray-500">Students: \${(c.students||[]).length}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn-ghost icon-btn" title="View Students"><i class="fa-solid fa-list"></i></button>
          </div>\`;
        el.querySelector('button').onclick = () => {
          currentView = 'class';
          currentClassId = c.id;
          renderCol2StudentList(c.id);
          activateTab('tab-students','col-students');
        };
        classListEl.appendChild(el);
      });
    }

    function renderCol1StudentList(){
      studentListEl.innerHTML = '';
      const students = [...allStudentsCache].sort((a,b)=>a.name.localeCompare(b.name));
      students.forEach(s => {
        const el = document.createElement('div');
        el.className = 'list-item';
        // Stripe IDs display + manual map
        let stripeSectionHtml = '';
        const hasHalleId = s.stripeInfo?.[ACCOUNT_ID_HALLE];
        const hasState48Id = s.stripeInfo?.[ACCOUNT_ID_STATE48];
        if (hasHalleId || hasState48Id){
          stripeSectionHtml += '<div class="stripe-id-display">';
          if (hasHalleId) stripeSectionHtml += \`<div><span class="stripe-id-label">Halle:</span> \${hasHalleId}</div>\`;
          if (hasState48Id) stripeSectionHtml += \`<div><span class="stripe-id-label">State48:</span> \${hasState48Id}</div>\`;
          stripeSectionHtml += '</div>';
        }
        if (!hasHalleId || !hasState48Id){
          stripeSectionHtml += \`
            <div class="manual-map-section">
              <label class="text-xs text-gray-500 block mb-1">Add Missing Stripe ID:</label>
              <div class="flex gap-1">
                <input type="text" id="map-\${s.id}" placeholder="cus_..." class="flex-grow input">
                <button class="map-stripe-btn btn" data-student-id="\${s.id}">Save</button>
              </div>
            </div>\`;
        }

        el.innerHTML = \`
          <div class="flex justify-between items-center">
            <span class="font-medium text-gray-800">\${s.name}</span>
            <div class="flex items-center gap-2">
              <button class="icon-btn" title="Edit" data-edit="\${s.id}"><i class="fas fa-pencil-alt fa-xs"></i></button>
              <button class="icon-btn" title="Invoice" data-invoice="\${s.id}" data-name="\${s.name}"><i class="fas fa-file-invoice-dollar fa-xs text-green-600"></i></button>
              <button class="icon-btn" title="Delete" data-del="\${s.id}" data-name="\${s.name}"><i class="fas fa-times fa-sm"></i></button>
            </div>
          </div>
          \${stripeSectionHtml}
        \`;

        el.addEventListener('click', () => selectStudent(s.id, s.name));

        el.querySelector('[data-invoice]').addEventListener('click', (e)=>{
          e.stopPropagation();
          promptInvoiceParentSelection(s.id, s.name);
        });

        const mapBtn = el.querySelector('.map-stripe-btn');
        if(mapBtn){
          mapBtn.addEventListener('click', async (e)=>{
            e.stopPropagation();
            const stripeCustomerIdInput = document.getElementById('map-'+s.id).value.trim();
            await handleMapStripeId(s.id, stripeCustomerIdInput);
          });
        }

        studentListEl.appendChild(el);
      });
    }

    function renderCol2StudentList(classId){
      const classData = allClassCache.find(c => c.id === classId);
      studentListEl.innerHTML = '';
      if(!classData || !classData.students || classData.students.length === 0){
        studentListEl.innerHTML = '<div class="text-sm text-gray-500 py-4 text-center">No students in this class yet.</div>';
        return;
      }
      const studentsInClass = allStudentsCache.filter(s => classData.students.includes(s.id)).sort((a,b)=>a.name.localeCompare(b.name));
      studentsInClass.forEach(s => {
        const el = document.createElement('div');
        el.className = 'list-item';
        let stripeSectionHtml = '';
        const hasHalleId = s.stripeInfo?.[ACCOUNT_ID_HALLE];
        const hasState48Id = s.stripeInfo?.[ACCOUNT_ID_STATE48];
        if (hasHalleId || hasState48Id){
          stripeSectionHtml += '<div class="stripe-id-display">';
          if (hasHalleId) stripeSectionHtml += \`<div><span class="stripe-id-label">Halle:</span> \${hasHalleId}</div>\`;
          if (hasState48Id) stripeSectionHtml += \`<div><span class="stripe-id-label">State48:</span> \${hasState48Id}</div>\`;
          stripeSectionHtml += '</div>';
        }
        if (!hasHalleId || !hasState48Id){
          stripeSectionHtml += \`
            <div class="manual-map-section">
              <label class="text-xs text-gray-500 block mb-1">Add Missing Stripe ID:</label>
              <div class="flex gap-1">
                <input type="text" id="map-\${s.id}" placeholder="cus_..." class="flex-grow input">
                <button class="map-stripe-btn btn" data-student-id="\${s.id}">Save</button>
              </div>
            </div>\`;
        }

        el.innerHTML = \`
          <div class="flex justify-between items-center">
            <span class="font-medium text-gray-800">\${s.name}</span>
            <div class="flex items-center gap-2">
              <button class="icon-btn" title="Edit" data-edit="\${s.id}"><i class="fas fa-pencil-alt fa-xs"></i></button>
              <button class="icon-btn" title="Invoice" data-invoice="\${s.id}" data-name="\${s.name}"><i class="fas fa-file-invoice-dollar fa-xs text-green-600"></i></button>
              <button class="icon-btn" title="Remove from class" data-remove="\${s.id}" data-name="\${s.name}"><i class="fas fa-times fa-sm"></i></button>
            </div>
          </div>
          \${stripeSectionHtml}
        \`;

        el.addEventListener('click', () => selectStudent(s.id, s.name));
        el.querySelector('[data-invoice]').addEventListener('click', (e)=>{
          e.stopPropagation();
          promptInvoiceParentSelection(s.id, s.name);
        });
        const mapBtn = el.querySelector('.map-stripe-btn');
        if(mapBtn){
          mapBtn.addEventListener('click', async (e)=>{
            e.stopPropagation();
            const stripeCustomerIdInput = document.getElementById('map-'+s.id).value.trim();
            await handleMapStripeId(s.id, stripeCustomerIdInput);
          });
        }

        studentListEl.appendChild(el);
      });
    }

    function renderContactList(){
      contactListEl.innerHTML = '';
      const contacts = [...allParentsCache].sort((a,b)=>a.name.localeCompare(b.name));
      contacts.forEach(p => {
        const el = document.createElement('div');
        el.className = 'list-item flex items-center justify-between';
        el.innerHTML = \`
          <div>
            <div class="font-medium">\${p.name}</div>
            <div class="text-xs text-gray-500">\${p.email || '—'}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="icon-btn" title="Email" data-email="\${p.email || ''}"><i class="fa-regular fa-envelope"></i></button>
          </div>\`;
        el.querySelector('[data-email]').onclick = ()=> openEmailModal({to:p.email});
        contactListEl.appendChild(el);
      });
    }

    // ===== Selection & dropdowns shared with billing =====
    function selectStudent(id, name){
      currentStudentId = id;
      document.getElementById('selected-student-pill').textContent = name;
      document.getElementById('invoice-student-id').value = id;
      // update parent dropdown for that student
      populateParentsForStudent(id);
      // render summary
      const s = allStudentsCache.find(x => x.id === id);
      const halle = s?.stripeInfo?.[ACCOUNT_ID_HALLE] || '—';
      const st48 = s?.stripeInfo?.[ACCOUNT_ID_STATE48] || '—';
      document.getElementById('student-billing-summary').innerHTML = \`
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div class="p-2 bg-gray-50 rounded border">
            <div class="text-xs text-gray-500">Halle Dance</div>
            <div class="font-mono">\${halle}</div>
          </div>
          <div class="p-2 bg-gray-50 rounded border">
            <div class="text-xs text-gray-500">State48 Theatre</div>
            <div class="font-mono">\${st48}</div>
          </div>
        </div>\`;
    }

    async function populateParentsForStudent(studentId){
      const parentSelect = document.getElementById('invoice-parent-select');
      parentSelect.innerHTML = '';
      parentSelect.disabled = true;
      document.getElementById('create-invoice-btn').disabled = true;
      const s = allStudentsCache.find(x => x.id === studentId);
      const parentIds = s?.parents || [];
      if(parentIds.length === 0){
        parentSelect.innerHTML = '<option value="">No contacts</option>';
        return;
      }
      const chunk = parentIds.slice(0, 30); // simple
      const qy = query(getParentsCol(), where('__name__','in', chunk));
      const snap = await getDocs(qy);
      const contacts = snap.docs.map(d => ({id:d.id, ...d.data()}));
      contacts.sort((a,b)=>a.name.localeCompare(b.name))
        .forEach(contact => {
          const option = document.createElement('option');
          option.value = contact.id;
          option.textContent = \`\${contact.name} (\${contact.email})\`;
          parentSelect.appendChild(option);
        });
      parentSelect.disabled = false;
      document.getElementById('create-invoice-btn').disabled = false;
    }

    // ===== Email modal =====
    const emailModal = document.getElementById('email-modal');
    function openModal(id){ document.getElementById(id).showModal(); }
    function closeModal(id){ document.getElementById(id).close(); }
    window.closeModal = closeModal;

    document.getElementById('open-email').onclick = ()=> openEmailModal();
    function openEmailModal(preset={}){
      document.getElementById('email-to').value = preset.to || '';
      document.getElementById('email-bcc-select').value = 'none';
      document.getElementById('email-reply-name').value = currentUser?.displayName || '';
      document.getElementById('email-reply-email').value = currentUser?.email || '';
      document.getElementById('email-subject').value = '';
      document.getElementById('email-body').value = '';
      document.getElementById('email-status').textContent = '';
      openModal('email-modal');
    }

    document.getElementById('email-send').onclick = async (e)=>{
      e.preventDefault();
      const status = document.getElementById('email-status');
      const btn = e.currentTarget;
      btn.disabled = true;
      status.textContent = 'Sending…';

      try{
        const to = document.getElementById('email-to').value.trim() || null;
        const bccChoice = document.getElementById('email-bcc-select').value;
        const replyToName = document.getElementById('email-reply-name').value.trim();
        const replyToEmail = document.getElementById('email-reply-email').value.trim();

        let bccList = [];
        if(bccChoice === 'parents-of-selected-class' && currentClassId){
          const c = allClassCache.find(x => x.id === currentClassId);
          const studentIds = c?.students || [];
          const parentIdSet = new Set();
          studentIds.forEach(sid => {
            const s = allStudentsCache.find(x => x.id === sid);
            (s?.parents||[]).forEach(pid => parentIdSet.add(pid));
          });
          const ids = Array.from(parentIdSet).slice(0, 30);
          const qy = query(getParentsCol(), where('__name__','in', ids));
          const snap = await getDocs(qy);
          bccList = snap.docs.map(d => d.data().email).filter(Boolean);
        } else if (bccChoice === 'all-parents'){
          const snap = await getDocs(colParents);
          const contacts = snap.docs.map(d => d.data());
          bccList = contacts.map(c => c.email).filter(Boolean);
        }

        const payload = {
          to, bcc: bccList,
          replyTo: { email: replyToEmail, name: replyToName },
          subject: document.getElementById('email-subject').value,
          text: document.getElementById('email-body').value
        };

        const response = await fetch(\`\${HARDCODED_CONFIG.serverUrl}/send-email\`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': \`Bearer \${await getIdToken(currentUser)}\`
          },
          body: JSON.stringify(payload)
        });
        const res = await response.json();
        if(!response.ok){ throw new Error(res.error || 'Send failed'); }
        toast('Email sent!', 'success');
        status.textContent = 'Sent!';
        setTimeout(()=> closeModal('email-modal'), 900);
      }catch(err){
        status.textContent = 'Error: ' + err.message;
      }finally{
        btn.disabled = false;
      }
    };

    // ===== Stripe helpers (frontend) =====
    function determineAccountContext(){
      const sel = document.getElementById('account-context-select');
      return sel.value;
    }
    function determineAccountContextForInvoice(){
      const sel = document.getElementById('invoice-account-select');
      return sel.value || null;
    }

    async function handleMapStripeId(studentId, stripeCustomerIdInput){
      if(!studentId || !stripeCustomerIdInput || !stripeCustomerIdInput.startsWith('cus_')){
        toast('Enter a valid Stripe ID (cus_*)','error'); return;
      }
      if(!currentUser){ toast('Not authenticated','error'); return; }
      const accountIdentifier = prompt(`Which account?\n- ${ACCOUNT_ID_HALLE}\n- ${ACCOUNT_ID_STATE48}`);
      if(accountIdentifier !== ACCOUNT_ID_HALLE && accountIdentifier !== ACCOUNT_ID_STATE48){
        toast('Invalid account. Cancelled.','error'); return;
      }
      const mapButton = document.querySelector(\`.map-stripe-btn[data-student-id="\${studentId}"]\`);
      if(mapButton) mapButton.textContent = 'Saving…';
      try{
        const idToken = await getIdToken(currentUser);
        const r = await fetch(\`\${HARDCODED_CONFIG.serverUrl}/map-stripe-customer\`, {
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':\`Bearer \${idToken}\`},
          body: JSON.stringify({ studentId, stripeCustomerId: stripeCustomerIdInput, accountIdentifier })
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.error || 'Map failed');
        toast(j.message || 'Mapped','success');
        const idx = allStudentsCache.findIndex(s=>s.id===studentId);
        if(idx!==-1){
          allStudentsCache[idx].stripeInfo = allStudentsCache[idx].stripeInfo || {};
          allStudentsCache[idx].stripeInfo[accountIdentifier] = stripeCustomerIdInput;
        }
        if(currentStudentId === studentId) selectStudent(studentId, allStudentsCache[idx]?.name || 'Selected');
      }catch(e){
        console.error(e); toast(e.message, 'error');
      }finally{
        if(mapButton) mapButton.textContent = 'Save';
      }
    }

    async function stripeSearchCustomers(){
      const qEl = document.getElementById('stripe-search-q');
      const resultsEl = document.getElementById('stripe-search-results');
      const org = determineAccountContext();
      const qv = qEl.value.trim();
      if(!qv){ resultsEl.textContent = 'Enter a query.'; return; }
      try{
        const idToken = await getIdToken(currentUser);
        resultsEl.innerHTML = '<div class="text-xs text-gray-500">Searching…</div>';
        const url = new URL(\`\${HARDCODED_CONFIG.serverUrl}/stripe/search-customers\`);
        url.searchParams.set('orgId', org==='halle_dance'?'State-48-Dance':'State-48-Theatre');
        url.searchParams.set('q', qv);
        const r = await fetch(url, { headers: { 'Authorization': \`Bearer \${idToken}\` } });
        const j = await r.json();
        if(!r.ok) throw new Error(j.error || 'Search failed');
        if(!j.data || j.data.length===0){ resultsEl.textContent = 'No results.'; return; }
        resultsEl.innerHTML = j.data.map(c => \`
          <div class="flex items-center justify-between border rounded p-2">
            <div>
              <div class="font-medium">\${c.name || '—'}</div>
              <div class="text-xs text-gray-500">\${c.email || '—'}</div>
              <div class="text-[11px] font-mono text-gray-500">\${c.id}</div>
            </div>
            <button class="btn" data-map="\${c.id}">Map to selected student</button>
          </div>\`).join('');
        // attach map handlers
        resultsEl.querySelectorAll('[data-map]').forEach(btn => {
          btn.addEventListener('click', async ()=>{
            if(!currentStudentId){ toast('Select a student first','error'); return; }
            await handleMapStripeId(currentStudentId, btn.dataset.map);
          });
        });
      }catch(e){
        resultsEl.innerHTML = '<div class="error-message">'+e.message+'</div>';
      }
    }

    document.getElementById('stripe-search-btn').onclick = stripeSearchCustomers;

    // ----- Invoice create (quick form) -----
    document.getElementById('create-invoice-btn').onclick = async (e)=>{
      e.preventDefault();
      const btn = e.currentTarget;
      const statusEl = document.getElementById('invoice-status');
      btn.disabled = true;
      statusEl.textContent = 'Creating…';
      statusEl.classList.remove('text-red-600','text-green-600');

      const parentId = document.getElementById('invoice-parent-select').value;
      const amount = document.getElementById('invoice-amount').value;
      const description = document.getElementById('invoice-description').value;
      const studentId = document.getElementById('invoice-student-id').value;
      const studentName = allStudentsCache.find(s => s.id === studentId)?.name || null;
      const accountIdentifier = determineAccountContextForInvoice();

      if(!parentId || !studentId || !amount || !description || !accountIdentifier){
        statusEl.textContent = 'Please select parent, account & fill all fields.';
        statusEl.classList.add('text-red-600');
        btn.disabled = false; return;
      }

      try{
        const idToken = await getIdToken(currentUser);
        const r = await fetch(\`\${HARDCODED_CONFIG.serverUrl}/create-invoice\`, {
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':\`Bearer \${idToken}\`},
          body: JSON.stringify({ parentId, studentId, studentName, amount, description, accountIdentifier })
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.error || 'Server error');
        toast('Invoice created!','success');
        statusEl.textContent = \`Invoice \${j.invoiceId} created (\${j.invoiceStatus}). \` + (j.invoiceUrl? \`View link opened.\` : '');
        statusEl.classList.add('text-green-600');
        if(j.invoiceUrl) window.open(j.invoiceUrl, '_blank');
        document.getElementById('invoice-amount').value = '';
        document.getElementById('invoice-description').value = '';
      }catch(e){
        statusEl.textContent = 'Error: ' + e.message;
        statusEl.classList.add('text-red-600');
      }finally{
        btn.disabled = false;
      }
    };

    // ===== Mobile tabs =====
    function activateTab(tabId, panelId){
      document.querySelectorAll('nav.tabbar button').forEach(b => b.classList.remove('tab-active'));
      document.getElementById(tabId).classList.add('tab-active');
      // scroll panel into view
      document.getElementById(panelId).scrollIntoView({behavior:'smooth', block:'start'});
    }
    document.getElementById('tab-classes').onclick = ()=> activateTab('tab-classes','col-classes');
    document.getElementById('tab-students').onclick = ()=> activateTab('tab-students','col-students');
    document.getElementById('tab-contacts').onclick = ()=> activateTab('tab-contacts','col-contacts');

    // ===== Init after auth =====
    async function initAppAfterAuth(){
      const [cSnap, sSnap, pSnap] = await Promise.all([
        getDocs(query(colClasses, orderBy('name'))),
        getDocs(query(colStudents, orderBy('name'))),
        getDocs(query(colParents, orderBy('name')))
      ]);
      allClassCache = cSnap.docs.map(d=>({id:d.id, ...d.data()}));
      allStudentsCache = sSnap.docs.map(d=>({id:d.id, ...d.data()}));
      allParentsCache = pSnap.docs.map(d=>({id:d.id, ...d.data()}));

      classCount.textContent = allClassCache.length;
      studentCount.textContent = allStudentsCache.length;
      contactCount.textContent = allParentsCache.length;

      // populate invoice student dropdown
      const studentSel = document.getElementById('invoice-student-id');
      studentSel.innerHTML = '<option value="">Select student…</option>';
      [...allStudentsCache].sort((a,b)=>a.name.localeCompare(b.name)).forEach(s=>{
        const o = document.createElement('option');
        o.value = s.id; o.textContent = s.name;
        studentSel.appendChild(o);
      });

      refreshClasses();
      renderCol1StudentList();
      renderContactList();
    }
  </script>
</body>
</html>
