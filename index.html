<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After-School Program Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        html { scroll-behavior: smooth; } /* Added for smoother scrollIntoView */
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.flex { display: flex; }
        /* Scrollbar styles */
        .scrolling-list::-webkit-scrollbar { width: 6px; }
        .scrolling-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .scrolling-list::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 10px; }
        .scrolling-list::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        /* Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #app-shell { display: none; } /* Hide app until logged in */
        /* Icon button styling */
        .icon-btn { background: none; border: none; padding: 0.25rem; cursor: pointer; color: #9ca3af; /* gray-400 */ }
        .icon-btn:hover { color: #dc2626; /* red-600 for delete */ }
        .icon-btn.edit:hover { color: #2563eb; /* blue-600 for edit */ }
        /* Add hover color for invoice icon */
        .icon-btn .fa-file-invoice-dollar:hover { color: #16a34a; /* green-600 */ }

        /* --- BILLING ITEM STYLES --- */
        .billing-item {
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
        .item-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        .item-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            text-transform: uppercase;
        }
        .invoice-status-paid, .subscription-status-active {
            color: #057a55;
            background-color: #def7ec;
        }
        .invoice-status-open, .subscription-status-past_due {
            color: #c2410c;
            background-color: #fffbeb;
        }
        .invoice-status-void, .subscription-status-canceled {
            color: #4b5563;
            background-color: #f3f4f6;
        }
        .stripe-link {
            font-size: 0.875rem;
            font-weight: 500;
            color: #2563eb;
            text-decoration: none;
            margin-top: 0.5rem;
            display: inline-block;
        }
        .stripe-link:hover {
            text-decoration: underline;
        }
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            text-align: center;
            padding: 0.5rem;
            background-color: #fee2e2;
            border-radius: 0.375rem;
        }
        /* --- MANUAL MAP STYLES --- */
        .manual-map-section {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb; /* gray-200 */
        }
        /* Style for displaying existing Stripe IDs */
        .stripe-id-display {
             font-size: 0.75rem;
             color: #6b7280; /* gray-500 */
             margin-top: 0.5rem;
             padding-top: 0.5rem;
             border-top: 1px solid #e5e7eb; /* gray-200 */
             word-break: break-all; /* Prevent long IDs from overflowing */
        }
        .stripe-id-label {
             font-weight: 500;
             color: #374151; /* gray-700 */
        }
    </style>
</head>

<body class="h-full flex flex-col pb-16 md:pb-0">

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md p-8 bg-white rounded-lg shadow-xl">
             <form id="login-form">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Sign In</h2>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email address</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>
                <div class="mt-6">
                    <button id="login-btn" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                        Sign In
                    </button>
                </div>
                <p id="login-error" class="text-xs text-red-600 mt-2 text-center h-4"></p>
            </form>
        </div>
    </div>

    <div id="app-shell" class="h-full flex flex-col">
        <div id="toast" class="fixed top-5 right-5 z-70 hidden items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow" role="alert">
            <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg">
                </div>
            <div id="toast-message" class="ml-3 text-sm font-normal">Item moved successfully.</div>
        </div>
        
        <div class="bg-gray-800 p-2 text-white">
            <div class="container mx-auto flex flex-col sm:flex-row sm:items-center gap-4 justify-between">
                <div class="flex items-center space-x-3">
                    <img src="https://state48arts.org/wp-content/uploads/2025/05/cropped-8459414c-5a7e-4a6b-b582-2f92ab56bc79-2-1-279x300.png" alt="Logo" class="h-10 w-10 rounded-full flex-shrink-0">
                    <h1 class="text-lg font-semibold whitespace-nowrap">State 48 After School Class Management</h1>
                </div>
                
                <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 self-end sm:self-center">
                    <div class="text-right sm:text-left">
                        <span class="text-sm font-medium block sm:inline">Signed in as:</span>
                        <span id="user-email-display" class="text-sm text-gray-300 block sm:inline"></span>
                        <span id="user-admin-status" class="text-xs text-yellow-400 ml-1 font-medium hidden">(Admin)</span>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button id="manage-users-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1.5 rounded-md text-sm hidden">
                            Manage Users
                        </button>
                        <button id="sign-out-btn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-md text-sm">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 container mx-auto p-4 h-full"> 
            <div class="mb-4 flex justify-between items-center">
                <div class="flex p-1 bg-gray-200 rounded-lg">
                    <button id="view-by-class" class="px-4 py-2 text-sm font-medium bg-white text-blue-700 rounded-md shadow-sm">View By Class</button>
                    <button id="view-by-student" class="px-4 py-2 text-sm font-medium text-gray-700">View By Student</button>
                </div>
                 <div class="flex items-center gap-2">
                     <label for="account-context-select" class="text-sm font-medium text-gray-700">View For:</label>
                     <select id="account-context-select" class="border border-gray-300 rounded-md shadow-sm p-1.5 text-sm">
                         <option value="halle_dance" selected>Halle Dance</option>
                         <option value="state48arts.org">State48Arts.org</option>
                     </select>
                </div>
                 <button id="email-class-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition hidden">
                    Email Class
                </button>
            </div>
            
             <div id="main-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                 <section id="col-1-section" class="bg-white p-4 rounded-lg shadow-lg flex flex-col h-full md:flex">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2 id="col-1-title" class="text-2xl font-bold text-gray-800">Classes</h2>
                        <button id="col-1-add-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                            Add Class
                        </button>
                    </div>
                    <div id="col-1-list" class="scrolling-list flex-1 overflow-y-auto space-y-2 min-h-0 pb-16 md:pb-0">
                        </div>
                </section>
    
                <section id="col-2-section" class="bg-white p-4 rounded-lg shadow-lg flex-col h-full hidden md:flex">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <div>
                            <h2 id="col-2-title" class="text-2xl font-bold text-gray-800">Students</h2>
                            <p id="col-2-subtitle" class="text-sm text-gray-500">Select a class</p>
                        </div>
                        <div id="col-2-btn-group" class="flex gap-2">
                            <button id="add-existing-student-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg font-medium hover:bg-gray-300 transition text-sm" disabled>
                                Add Existing
                            </button>
                            <button id="add-new-student-btn" class="bg-blue-600 text-white px-3 py-2 rounded-lg font-medium hover:bg-blue-700 transition text-sm" disabled>
                                Add New
                            </button>
                        </div>
                    </div>
                    <div id="col-2-list" class="scrolling-list flex-1 overflow-y-auto space-y-2 min-h-0 pb-16 md:pb-0">
                        </div>
                </section>
    
                <section id="col-3-section" class="bg-white p-4 rounded-lg shadow-lg flex flex-col h-full hidden md:flex">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Parents/Contacts</h2>
                            <p id="contact-student-subtitle" class="text-sm text-gray-500">Select a student</p>
                        </div>
                        <button id="add-contact-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition" disabled>
                            Add Contact
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto scrolling-list min-h-0 pb-16 md:pb-0 space-y-2">
                        
                        <div id="contact-list" class="space-y-2">
                            </div>
        
                        <hr class="my-4 border-gray-200">
        
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold text-gray-800">Invoices</h3>
                            <span id="invoice-account-label" class="text-xs font-medium text-gray-500"></span> 
                        </div>
                        <div id="invoice-list-container" class="space-y-2">
                            <p id="invoices-loading-message" class="text-gray-500 text-center">Select a student</p>
                        </div>
        
                        <div class="flex justify-between items-center mt-4 mb-2">
                            <h3 class="text-lg font-bold text-gray-800">Subscriptions</h3>
                            <span id="subscription-account-label" class="text-xs font-medium text-gray-500"></span> 
                        </div>
                        <div id="subscription-list-container" class="space-y-2">
                            <p id="subscriptions-loading-message" class="text-gray-500 text-center">Select a student</p>
                        </div>
                    
                    </div> </section>
            </div>
        </div>
    
        <nav class="md:hidden fixed bottom-0 left-0 right-0 z-40 bg-white shadow-inner p-2 border-t border-gray-200">
             <div class="flex justify-around">
                <button id="nav-col-1" class="flex flex-col items-center p-2 text-blue-600" data-col="col-1-section">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    <span id="nav-col-1-title" class="text-xs">Classes</span>
                </button>
                <button id="nav-col-2" class="flex flex-col items-center p-2 text-gray-500" data-col="col-2-section">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0115 11h2a1 1 0 01.998 1.084A6.958 6.958 0 0118 16a1 1 0 01-1 1h-4.07zM6 11a5 5 0 015 5v1a1 1 0 01-1 1H1a1 1 0 01-1-1v-1a5 5 0 015-5z"></path></svg>
                    <span id="nav-col-2-title" class="text-xs">Students</span>
                </button>
                <button id="nav-contacts" class="flex flex-col items-center p-2 text-gray-500" data-col="col-3-section">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C6.477 18 2 13.523 2 8V3z"></path></svg>
                    <span class="text-xs">Contacts</span>
                </button>
            </div>
        </nav>
    </div>
    
    <div id="add-class-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Add New Class</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="add-class-modal">&times;</button>
            </div>
            <form id="add-class-form">
                <div class="space-y-4">
                    <div>
                        <label for="class-name" class="block text-sm font-medium text-gray-700">Class Name</label>
                        <input type="text" id="class-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="teacher-name" class="block text-sm font-medium text-gray-700">Teacher Name</label>
                        <input type="text" id="teacher-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-white border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition" data-modal="add-class-modal">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">Save Class</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-class-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Edit Class</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="edit-class-modal">&times;</button>
            </div>
            <form id="edit-class-form">
                <input type="hidden" id="edit-class-id"> 
                <div class="space-y-4">
                    <div>
                        <label for="edit-class-name" class="block text-sm font-medium text-gray-700">Class Name</label>
                        <input type="text" id="edit-class-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="edit-teacher-name" class="block text-sm font-medium text-gray-700">Teacher Name</label>
                        <input type="text" id="edit-teacher-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-white border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition" data-modal="edit-class-modal">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">Update Class</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-new-student-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Add New Student</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="add-new-student-modal">&times;</button>
            </div>
            <form id="add-new-student-form">
                <div>
                    <label for="new-student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                    <input type="text" id="new-student-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-white border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition" data-modal="add-new-student-modal">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">Save Student</button>
                </div>
            </form>
        </div>
    </div>

     <div id="edit-student-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Edit Student</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="edit-student-modal">&times;</button>
            </div>
            <form id="edit-student-form">
                <input type="hidden" id="edit-student-id"> 
                <div>
                    <label for="edit-student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                    <input type="text" id="edit-student-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-white border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition" data-modal="edit-student-modal">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">Update Student</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-existing-student-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Add Existing Student</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="add-existing-student-modal">&times;</button>
            </div>
            <p id="add-existing-student-subtitle" class="text-sm text-gray-600 mb-4">Adding to class: <span class="font-medium"></span></p>
            <form id="add-existing-student-form">
                <div>
                    <label for="existing-student-select" class="block text-sm font-medium text-gray-700">Select Student</label>
                    <select id="existing-student-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        <option value="">Loading students...</option>
                    </select>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-white border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition" data-modal="add-existing-student-modal">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">Add to Class</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-contact-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Add New Contact</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="add-contact-modal">&times;</button>
            </div>
            <p id="add-contact-subtitle" class="text-sm text-gray-600 mb-4">Adding contact for: <span class="font-medium"></span></p>
            <form id="add-contact-form">
                <div class="space-y-4">
                    <div>
                        <label for="contact-name" class="block text-sm font-medium text-gray-700">Contact Name</label>
                        <input type="text" id="contact-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="contact-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="contact-email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="contact-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="tel" id="contact-phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-white border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition" data-modal="add-contact-modal">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">Save Contact</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-contact-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Edit Contact</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="edit-contact-modal">&times;</button>
            </div>
            <form id="edit-contact-form">
                 <input type="hidden" id="edit-contact-id"> 
                 <div class="space-y-4">
                    <div>
                        <label for="edit-contact-name" class="block text-sm font-medium text-gray-700">Contact Name</label>
                        <input type="text" id="edit-contact-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="edit-contact-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="edit-contact-email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="edit-contact-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="tel" id="edit-contact-phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-white border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition" data-modal="edit-contact-modal">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">Update Contact</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="email-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Compose Email</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="email-modal">&times;</button>
            </div>
            <form id="email-form">
                 <p class="text-xs text-gray-500 mb-3">Replies will go to: <span id="reply-to-email"></span></p>
                <div class="space-y-4">
                    <div id="email-to-wrapper">
                        <label for="email-to" class="block text-sm font-medium text-gray-700">To:</label>
                        <input type="email" id="email-to" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly>
                    </div>
                    <div id="email-bcc-wrapper">
                        <label for="email-bcc" class="block text-sm font-medium text-gray-700">BCC:</label>
                        <input type="text" id="email-bcc" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="email-subject" class="block text-sm font-medium text-gray-700">Subject:</label>
                        <input type="text" id="email-subject" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="email-body" class="block text-sm font-medium text-gray-700">Message:</label>
                        <textarea id="email-body" rows="8" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-between items-center gap-3">
                    <span id="email-status" class="text-sm text-gray-500"></span>
                    <div class="flex gap-3">
                        <button type="button" class="close-modal-btn bg-white border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition" data-modal="email-modal">Cancel</button>
                        <button type="submit" id="send-email-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">Send Email</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="user-management-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-medium leading-6 text-gray-900">Manage Users</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="user-management-modal">&times;</button>
            </div>
    
            <form id="add-user-form" class="mb-6 pb-6 border-b border-gray-200">
                 <h4 class="text-lg font-medium text-gray-800 mb-3">Add New User</h4>
                 <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                     <div>
                         <label for="new-user-name" class="block text-sm font-medium text-gray-700">Name</label>
                         <input type="text" id="new-user-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                     </div>
                     <div>
                         <label for="new-user-email" class="block text-sm font-medium text-gray-700">Email</label>
                         <input type="email" id="new-user-email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                     </div>
                     <div>
                         <label for="new-user-password" class="block text-sm font-medium text-gray-700">Password</label>
                         <input type="password" id="new-user-password" minlength="6" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                     </div>
                     <button type="submit" id="add-user-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition sm:w-auto">Add User</button>
                 </div>
                 <p id="add-user-status" class="text-xs mt-2 h-4"></p>
            </form>
    
            <div>
                 <h4 class="text-lg font-medium text-gray-800 mb-3">Existing Users</h4>
                 <div id="user-list" class="scrolling-list max-h-60 overflow-y-auto space-y-2 pr-2">
                     <p class="text-gray-500">Loading users...</p>
                     </div>
            </div>
    
             <div class="mt-6 flex justify-end">
                 <button type="button" class="close-modal-btn bg-white border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition" data-modal="user-management-modal">Close</button>
             </div>
        </div>
    </div>

    <div id="invoice-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Create Invoice</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="invoice-modal">&times;</button>
            </div>
            <p id="invoice-subtitle" class="text-sm text-gray-600 mb-4">Creating invoice for student: <span class="font-medium"></span></p>
            <form id="create-invoice-form">
                <input type="hidden" id="invoice-student-id"> 
                <div class="space-y-4">
                    <div>
                         <label for="invoice-parent-select" class="block text-sm font-medium text-gray-700">Invoice To (Parent/Contact):</label>
                         <select id="invoice-parent-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                             <option value="">Loading contacts...</option>
                         </select>
                    </div>
                     <div>
                         <label for="invoice-account-select" class="block text-sm font-medium text-gray-700">Invoice For Account:</label>
                         <select id="invoice-account-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                             <option value="">-- Select Account --</option>
                             <option value="halle_dance">Halle Dance</option>
                             <option value="state48arts.org">State48Arts.org</option>
                         </select>
                     </div>
                     <div>
                        <label for="invoice-amount" class="block text-sm font-medium text-gray-700">Amount (e.g., 25.00)</label>
                        <input type="number" id="invoice-amount" step="0.01" min="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="invoice-description" class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" id="invoice-description" placeholder="e.g., October Class Fee - [Student Name]" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                 <p id="invoice-status" class="text-xs mt-4 h-4"></p>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-white border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition" data-modal="invoice-modal">Cancel</button>
                    <button type="submit" id="create-invoice-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition">Create Invoice</button>
                </div>
            </form>
        </div>
    </div>
    
    
    <script type="module">
        
        // --- HARDCODED CONFIGURATION ---
        const HARDCODED_CONFIG = {
            serverUrl: "https://after-school-mailer.onrender.com", 
            organizationId: "State-48-Dance", 
            firebase: {
                apiKey: "AIzaSyAYDMyMAw7wf3i28C-hQ_iRZRVdMiXmaLk",         
                authDomain: "dance-classes-97ad7.firebaseapp.com", 
                projectId: "dance-classes-97ad7",    
                appId: "1:1041555303856:web:5b80e0497eacaf161b7a75"             
            }
        };
        // -------------------------------------------------

        // --- NEW: Stripe Account Identifiers ---
        const ACCOUNT_ID_HALLE = 'halle_dance';
        const ACCOUNT_ID_STATE48 = 'state48arts.org';
        // ------------------------------------

        // --- Import Firebase modules ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, onAuthStateChanged, initializeAuth, browserLocalPersistence,
            signInWithEmailAndPassword, signOut, getIdToken, getIdTokenResult
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot,
            collection, query, where, getDocs, arrayUnion, arrayRemove, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase services ---
        let db;
        let auth; 
        let userId = null;
        let currentUser = null;
        let isAdmin = false; 
        let currentClassId = null;
        let currentStudentId = null;
        let allStudentsCache = []; // Holds { id, name, ..., stripeInfo: { halle_dance: 'cus_..', state48arts.org: 'cus_..' } }
        let allClassCache = [];
        let contactCache = new Map(); 
        let unsubscribeClasses = null;
        let unsubscribeAllStudents = null;
        let unsubscribeContacts = null; 
        
        const organizationId = HARDCODED_CONFIG.organizationId; 
        let currentView = 'class'; 

        // --- Collections ---
        const getClassesCol = () => collection(db, `organizations/${organizationId}/classes`);
        const getStudentsCol = () => collection(db, `organizations/${organizationId}/students`);
        const getParentsCol = () => collection(db, `organizations/${organizationId}/parents`);

        // --- Toast Notification ---
        const toast = (message, type = 'success', duration = 3000) => { /* ... unchanged ... */ }

        // --- Modal Controls ---
        const openModal = (modalId) => document.getElementById(modalId)?.classList.add('flex');
        const closeModal = (modalId) => document.getElementById(modalId)?.classList.remove('flex');

        // --- Render Functions ---
        const renderViewByClass = () => { currentView = 'class'; document.getElementById('col-1-title').textContent = 'Classes'; document.getElementById('col-1-add-btn').textContent = 'Add Class'; document.getElementById('col-2-title').textContent = 'Students'; document.getElementById('col-2-btn-group').classList.remove('hidden'); document.getElementById('email-class-btn').classList.remove('hidden'); document.getElementById('nav-col-1-title').textContent = 'Classes'; document.getElementById('nav-col-2-title').textContent = 'Students'; document.getElementById('view-by-class').classList.add('bg-white', 'text-blue-700', 'shadow-sm'); document.getElementById('view-by-student').classList.remove('bg-white', 'text-blue-700', 'shadow-sm'); currentClassId = null; currentStudentId = null; resetCol2(); resetCol3(); renderCol1ClassList(); }
        const renderViewByStudent = () => { currentView = 'student'; document.getElementById('col-1-title').textContent = 'All Students'; document.getElementById('col-1-add-btn').textContent = 'Add Student'; document.getElementById('col-2-title').textContent = 'Enrolled In'; document.getElementById('col-2-btn-group').classList.add('hidden'); document.getElementById('email-class-btn').classList.add('hidden'); document.getElementById('nav-col-1-title').textContent = 'Students'; document.getElementById('nav-col-2-title').textContent = 'Classes'; document.getElementById('view-by-student').classList.add('bg-white', 'text-blue-700', 'shadow-sm'); document.getElementById('view-by-class').classList.remove('bg-white', 'text-blue-700', 'shadow-sm'); currentClassId = null; currentStudentId = null; resetCol2(); resetCol3(); renderCol1StudentList(); }
        
        const renderCol1ClassList = () => {
             const listEl = document.getElementById('col-1-list'); listEl.innerHTML = '';
             if (allClassCache.length === 0) { listEl.innerHTML = '<p class="text-gray-500 text-center">No classes found. Add one!</p>'; return; }
             const sortedClasses = [...allClassCache].sort((a, b) => a.name.localeCompare(b.name));
             sortedClasses.forEach(c => {
                 const el = document.createElement('div'); el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentClassId === c.id ? 'bg-blue-50 border-blue-300' : ''}`; el.dataset.id = c.id;
                 el.innerHTML = `
                     <div class="flex justify-between items-center">
                         <span class="font-medium text-gray-800">${c.name}</span>
                         <div class="flex items-center space-x-2">
                             <button class="edit-class-btn icon-btn edit" data-id="${c.id}" title="Edit Class"><i class="fas fa-pencil-alt fa-xs"></i></button>
                             <button class="delete-class-btn icon-btn" data-id="${c.id}" title="Delete Class"><i class="fas fa-times fa-sm"></i></button>
                         </div>
                     </div>
                     <p class="text-sm text-gray-600">${c.teacher}</p>`;
                 el.addEventListener('click', () => selectClass(c.id, c.name));
                 el.querySelector('.edit-class-btn').addEventListener('click', (e) => { e.stopPropagation(); openEditClassModal(c.id); });
                 el.querySelector('.delete-class-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteClass(c.id, c.name); });
                 listEl.appendChild(el);
             });
        }

        // --- UPDATED: Render Col 1 (Students) - Check stripeInfo map ---
        const renderCol1StudentList = () => {
           const listEl = document.getElementById('col-1-list'); listEl.innerHTML = '';
           if (allStudentsCache.length === 0) { /* ... no students message ... */ return; }
           const sortedStudents = [...allStudentsCache].sort((a, b) => a.name.localeCompare(b.name));
            
           sortedStudents.forEach(s => {
               const el = document.createElement('div'); 
               el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentStudentId === s.id ? 'bg-blue-50 border-blue-300' : ''}`; 
               el.dataset.id = s.id;

               // --- UPDATED: Manual Map & Display Existing IDs ---
               let stripeSectionHtml = '';
               const hasHalleId = s.stripeInfo?.[ACCOUNT_ID_HALLE];
               const hasState48Id = s.stripeInfo?.[ACCOUNT_ID_STATE48];

               // Display existing IDs
                if (hasHalleId || hasState48Id) {
                    stripeSectionHtml += '<div class="stripe-id-display">';
                    if (hasHalleId) stripeSectionHtml += `<div><span class="stripe-id-label">Halle:</span> ${hasHalleId}</div>`;
                    if (hasState48Id) stripeSectionHtml += `<div><span class="stripe-id-label">State48:</span> ${hasState48Id}</div>`;
                    stripeSectionHtml += '</div>';
                }
               
               // Show manual map input if EITHER ID is missing (adjust condition if needed)
               if (!hasHalleId || !hasState48Id) {
                   stripeSectionHtml += `
                       <div class="manual-map-section">
                           <label for="map-${s.id}" class="text-xs text-gray-500 block mb-1">Add Missing Stripe ID:</label>
                           <div class="flex gap-1">
                               <input type="text" id="map-${s.id}" placeholder="cus_..." class="flex-grow border border-gray-300 rounded px-1 py-0.5 text-xs">
                               <button class="map-stripe-btn bg-gray-200 hover:bg-gray-300 px-2 rounded text-xs" data-student-id="${s.id}">Save</button>
                           </div>
                       </div>`;
               }
               
               el.innerHTML = `
                   <div class="flex justify-between items-center">
                       <span class="font-medium text-gray-800">${s.name}</span>
                       <div class="flex items-center space-x-2">
                            <button class="edit-student-btn icon-btn edit" data-id="${s.id}" title="Edit Student"><i class="fas fa-pencil-alt fa-xs"></i></button>
                            <button class="invoice-student-btn icon-btn" data-student-id="${s.id}" data-student-name="${s.name}" title="Invoice Student"><i class="fas fa-file-invoice-dollar fa-xs text-green-600"></i></button> 
                           <button class="delete-student-btn icon-btn" data-id="${s.id}" data-name="${s.name}" title="Delete Student"><i class="fas fa-times fa-sm"></i></button>
                       </div>
                   </div>
                   ${stripeSectionHtml}`; // Add the Stripe section
                
               el.addEventListener('click', () => selectStudent(s.id, s.name));
               el.querySelector('.edit-student-btn').addEventListener('click', (e) => { e.stopPropagation(); openEditStudentModal(s.id); });
               el.querySelector('.delete-student-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteStudent(s.id, s.name); });
               el.querySelector('.invoice-student-btn').addEventListener('click', (e) => { e.stopPropagation(); promptInvoiceParentSelection(s.id, s.name); });
               
               listEl.appendChild(el);
           });
        }

        // --- UPDATED: Render Col 2 (Students in a Class) - Check stripeInfo map ---
        const renderCol2StudentList = (classId) => {
            const listEl = document.getElementById('col-2-list'); const classData = allClassCache.find(c => c.id === classId);
            if (!classData || !classData.students || classData.students.length === 0) { /* ... no students message ... */ return; }
            const studentIds = classData.students; const studentsInClass = allStudentsCache.filter(s => studentIds.includes(s.id)).sort((a, b) => a.name.localeCompare(b.name));
            listEl.innerHTML = '';

            studentsInClass.forEach(s => {
                const el = document.createElement('div'); 
                el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentStudentId === s.id ? 'bg-blue-50 border-blue-300' : ''}`; 
                el.dataset.id = s.id;

                // --- UPDATED: Manual Map & Display Existing IDs ---
                let stripeSectionHtml = '';
                const hasHalleId = s.stripeInfo?.[ACCOUNT_ID_HALLE];
                const hasState48Id = s.stripeInfo?.[ACCOUNT_ID_STATE48];

                if (hasHalleId || hasState48Id) {
                    stripeSectionHtml += '<div class="stripe-id-display">';
                    if (hasHalleId) stripeSectionHtml += `<div><span class="stripe-id-label">Halle:</span> ${hasHalleId}</div>`;
                    if (hasState48Id) stripeSectionHtml += `<div><span class="stripe-id-label">State48:</span> ${hasState48Id}</div>`;
                    stripeSectionHtml += '</div>';
                }
               
                if (!hasHalleId || !hasState48Id) {
                    stripeSectionHtml += `
                       <div class="manual-map-section">
                           <label for="map-${s.id}" class="text-xs text-gray-500 block mb-1">Add Missing Stripe ID:</label>
                           <div class="flex gap-1">
                               <input type="text" id="map-${s.id}" placeholder="cus_..." class="flex-grow border border-gray-300 rounded px-1 py-0.5 text-xs">
                               <button class="map-stripe-btn bg-gray-200 hover:bg-gray-300 px-2 rounded text-xs" data-student-id="${s.id}">Save</button>
                           </div>
                       </div>`;
                }
                
                el.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-800">${s.name}</span>
                        <div class="flex items-center space-x-2">
                             <button class="edit-student-btn icon-btn edit" data-id="${s.id}" title="Edit Student"><i class="fas fa-pencil-alt fa-xs"></i></button>
                             <button class="invoice-student-btn icon-btn" data-student-id="${s.id}" data-student-name="${s.name}" title="Invoice Student"><i class="fas fa-file-invoice-dollar fa-xs text-green-600"></i></button> 
                            <button class="remove-student-btn icon-btn" data-id="${s.id}" data-name="${s.name}" title="Remove from class"><i class="fas fa-times fa-sm"></i></button>
                        </div>
                    </div>
                    ${stripeSectionHtml}`; // Add the Stripe section

                el.addEventListener('click', () => selectStudent(s.id, s.name));
                 el.querySelector('.edit-student-btn').addEventListener('click', (e) => { e.stopPropagation(); openEditStudentModal(s.id); });
                 el.querySelector('.remove-student-btn').addEventListener('click', (e) => { e.stopPropagation(); handleRemoveStudent(s.id, s.name); });
                 el.querySelector('.invoice-student-btn').addEventListener('click', (e) => { e.stopPropagation(); promptInvoiceParentSelection(s.id, s.name); });
                 
                listEl.appendChild(el);
            });
        }
        
        const renderCol2ClassList = (studentId) => { /* ... unchanged ... */ }
        const renderStudentDropdown = () => { /* ... unchanged ... */ }
        const renderContactList = (contacts) => { /* ... unchanged ... */ }
        const renderUserList = (users) => { /* ... unchanged ... */ }
        const resetCol2 = () => { /* ... unchanged ... */ }
        const resetCol3 = () => { /* ... unchanged ... */ }
        
        // --- Data Listeners ---
        const listenForClasses = () => { /* ... unchanged ... */ }
        const listenForAllStudents = () => { /* ... unchanged ... */ }
        const listenForContacts = (studentId) => { /* ... unchanged ... */ }

        // --- UI Selectors ---
        const selectClass = (classId, className) => { /* ... unchanged ... */ }
        const selectStudent = (studentId, studentName) => { 
            console.log("Selected student:", studentId, studentName); 
            currentStudentId = studentId; 
            document.querySelectorAll('#col-1-list > div, #col-2-list > div').forEach(el => { el.classList.toggle('bg-blue-50', el.dataset.id === studentId); el.classList.toggle('border-blue-300', el.dataset.id === studentId); }); 
            document.getElementById('contact-student-subtitle').textContent = `For: ${studentName}`; 
            document.getElementById('add-contact-btn').disabled = false; 
            listenForContacts(studentId); 
            loadStudentBillingData(studentId); // Now fetches based on account selector
            if (currentView === 'student') { 
                document.getElementById('col-2-subtitle').textContent = `For: ${studentName}`; 
                renderCol2ClassList(studentId); 
            } 
            showCol('col-3-section'); 
            setActiveNav('nav-contacts'); 
            const listEl = document.getElementById('contact-list'); 
            if (listEl) listEl.scrollIntoView({ behavior: 'smooth', block: 'start' }); 
        }

        // --- Open Edit Modals ---
        const openEditClassModal = (classId) => { /* ... unchanged ... */ };
        const openEditStudentModal = (studentId) => { /* ... unchanged ... */ };
        const openEditContactModal = (contactId) => { /* ... unchanged ... */ };

        // --- Data Handlers (Add, Delete, Update) ---
        const handleAddClass = async (e) => { /* ... unchanged ... */ }
        const handleUpdateClass = async (e) => { /* ... unchanged ... */ };
        const handleDeleteClass = async (classId, className) => { /* ... unchanged ... */ }
        // --- UPDATED: Add empty stripeInfo on new student ---
        const handleAddNewStudent = async (e) => { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; const name = document.getElementById('new-student-name').value; if (!name) { btn.disabled = false; return; } try { const studentRef = await addDoc(getStudentsCol(), { name, parents: [], classes: [], stripeInfo: {} }); // Add empty map if (currentView === 'class' && currentClassId) { const batch = writeBatch(db); batch.update(doc(getClassesCol(), currentClassId), { students: arrayUnion(studentRef.id) }); batch.update(studentRef, { classes: arrayUnion(currentClassId) }); await batch.commit(); } closeModal('add-new-student-modal'); e.target.reset(); toast('Student added!', 'success'); } catch (error) { console.error("Add Student Error:", error); toast('Failed to add student.', 'error'); } finally { btn.disabled = false; } }
        const handleUpdateStudent = async (e) => { /* ... unchanged ... */ };
        const handleAddExistingStudent = async (e) => { /* ... unchanged ... */ }
        const handleRemoveStudent = async (studentId, studentName) => { /* ... unchanged ... */ }
        const handleDeleteStudent = async (studentId, studentName) => { /* ... unchanged ... */ }
        const handleAddContact = async (e) => { /* ... unchanged ... */ }
        const handleUpdateContact = async (e) => { /* ... unchanged ... */ };
        const handleDeleteContact = async (contactId, contactName) => { /* ... unchanged ... */ }

        // --- Email Sending ---
        const openEmailModal = ({ to, bcc }) => { /* ... unchanged ... */ }
        const handleEmailClass = async () => { /* ... unchanged ... */ }
        const handleSendEmail = async (e) => { 
            e.preventDefault(); 
            const btn = document.getElementById('send-email-btn'); 
            const status = document.getElementById('email-status'); 
            btn.disabled = true; 
            status.textContent = 'Sending...'; 
            const serverUrl = HARDCODED_CONFIG.serverUrl; 
            const to = document.getElementById('email-to').value; 
            const bccVal = document.getElementById('email-bcc').value; 
            const replyToEmail = currentUser?.email || null; 
            let replyToName = currentUser?.displayName || replyToEmail; 
            let bccList = null; // --- ADDED let ---
            if (bccVal) { 
                try { 
                    const classData = allClassCache.find(c => c.id === currentClassId); 
                    const studentIds = classData.students; 
                    const parentIds = allStudentsCache.filter(s => studentIds.includes(s.id)).flatMap(s => s.parents || []); 
                    const uniqueParentIds = [...new Set(parentIds)]; 
                    const contacts = []; 
                    for (let i = 0; i < uniqueParentIds.length; i += 30) { 
                        const chunk = uniqueParentIds.slice(i, i + 30); 
                        if(chunk.length === 0) continue; 
                        const q = query(getParentsCol(), where('__name__', 'in', chunk)); 
                        const querySnapshot = await getDocs(q); 
                        querySnapshot.docs.forEach(doc => contacts.push(doc.data())); 
                    } 
                    bccList = contacts.map(c => c.email).filter(Boolean); 
                } catch(err) { /* ... handle BCC error ... */ return; } 
            } 
            const payload = { 
                to: to || null, bcc: bccList, 
                replyTo: { email: replyToEmail, name: replyToName }, 
                subject: document.getElementById('email-subject').value, 
                text: document.getElementById('email-body').value 
            }; 
            try { 
                const response = await fetch(`${serverUrl}/send-email`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${await getIdToken(currentUser)}` }, 
                    body: JSON.stringify(payload) 
                }); 
                if (!response.ok) { const res = await response.json(); throw new Error(res.error || `Server ${response.status}`); } 
                toast('Email sent!', 'success'); status.textContent = 'Sent!'; 
                setTimeout(() => closeModal('email-modal'), 1000); 
            } catch (error) { /* ... handle send error ... */ } 
            finally { btn.disabled = false; } 
        }
        
        // --- Mobile Navigation ---
        const showCol = (colId) => { /* ... unchanged ... */ }
        const setActiveNav = (navId) => { /* ... unchanged ... */ }
        
        // --- Authentication ---
        const handleLogin = (e) => { /* ... unchanged ... */ };
        const handleSignOut = () => { /* ... unchanged ... */ };

        // --- User Management ---
        const openUserManagementModal = async () => { /* ... unchanged ... */ };
        const fetchUsers = async () => { /* ... unchanged ... */ };
        const handleCreateUser = async (e) => { /* ... unchanged ... */ };
        const handleDeleteUser = async (uidToDelete, emailToDelete) => { /* ... unchanged ... */ };
        const handleMakeAdmin = async (uidToMakeAdmin, emailToMakeAdmin) => { /* ... unchanged ... */ };
        const handleUpdateUserName = async (uidToUpdate, currentName) => { /* ... unchanged ... */ };

        // --- === UPDATED BILLING FUNCTIONS (Multi-Account) START === ---

         /**
          * Gets the currently selected Stripe account identifier from the UI.
          * @returns {string} 'halle_dance' or 'state48arts.org'
          */
        function determineAccountContext() {
            const selector = document.getElementById('account-context-select');
            // !! Add error handling if selector not found !!
            return selector.value; 
        }

        /**
         * Gets the selected Stripe account identifier from the Invoice Modal.
         * @returns {string|null} 'halle_dance', 'state48arts.org', or null if not selected
         */
        function determineAccountContextForInvoice() {
            const selector = document.getElementById('invoice-account-select');
            return selector.value || null; // Return null if no value selected
        }

        /**
         * Fetches and displays billing data for the selected student AND selected account context.
         * @param {string} studentId - The Firestore ID of the student.
         */
        async function loadStudentBillingData(studentId) {
            if (!currentUser) { console.error("Not authenticated."); return; }
            const authToken = await getIdToken(currentUser);
            const invoiceList = document.getElementById('invoice-list-container');
            const subList = document.getElementById('subscription-list-container');
            const invoiceLabel = document.getElementById('invoice-account-label');
            const subLabel = document.getElementById('subscription-account-label');

            // --- Get Selected Account Context ---
            const accountIdentifier = determineAccountContext(); 
            const accountName = accountIdentifier === ACCOUNT_ID_HALLE ? "Halle Dance" : "State48Arts.org";
            invoiceLabel.textContent = `For: ${accountName}`;
            subLabel.textContent = `For: ${accountName}`;
            // ------------------------------------

            invoiceList.innerHTML = '<p id="invoices-loading-message" class="text-gray-500 text-center">Loading invoices...</p>';
            subList.innerHTML = '<p id="subscriptions-loading-message" class="text-gray-500 text-center">Loading subscriptions...</p>';
            
            const headers = new Headers({'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json'});
            const API_BASE_URL = HARDCODED_CONFIG.serverUrl;

            try { // Fetch Invoices
                // --- Pass accountIdentifier in URL ---
                const response = await fetch(`${API_BASE_URL}/get-student-invoices/${studentId}/${accountIdentifier}`, { headers });
                if (!response.ok) { const res = await response.json(); throw new Error(res.error || `Failed: ${response.statusText}`); }
                const { invoices } = await response.json(); invoiceList.innerHTML = '';
                if (invoices.length === 0) { invoiceList.innerHTML = `<p class="text-gray-500 text-center">No invoices found for ${accountName}.</p>`; } 
                else { invoices.forEach(invoice => { invoiceList.appendChild(createInvoiceElement(invoice)); }); }
            } catch (error) { invoiceList.innerHTML = `<p class="error-message">Could not load invoices. ${error.message}</p>`; }

            try { // Fetch Subscriptions
                // --- Pass accountIdentifier in URL ---
                const response = await fetch(`${API_BASE_URL}/get-student-subscriptions/${studentId}/${accountIdentifier}`, { headers });
                if (!response.ok) { const res = await response.json(); throw new Error(res.error || `Failed: ${response.statusText}`); }
                const { subscriptions } = await response.json(); subList.innerHTML = '';
                if (subscriptions.length === 0) { subList.innerHTML = `<p class="text-gray-500 text-center">No subscriptions found for ${accountName}.</p>`; } 
                else { subscriptions.forEach(sub => { subList.appendChild(createSubscriptionElement(sub)); }); }
            } catch (error) { subList.innerHTML = `<p class="error-message">Could not load subscriptions. ${error.message}</p>`; }
        }

        function createInvoiceElement(invoice) { /* ... unchanged ... */ }
        function createSubscriptionElement(subscription) { /* ... unchanged ... */ }
        
        // --- UPDATED MANUAL MAP FUNCTION (Asks for Account) ---
        const handleMapStripeId = async (studentId, stripeCustomerIdInput) => {
            if (!studentId || !stripeCustomerIdInput || !stripeCustomerIdInput.startsWith('cus_')) {
                toast('Please enter a valid Stripe Customer ID (starts with cus_).', 'error');
                return;
            }
            if (!currentUser) { toast('Not authenticated.', 'error'); return; }

            // --- Ask user which account this ID is for ---
            const accountIdentifier = prompt(`Which account does this ID belong to? Enter '${ACCOUNT_ID_HALLE}' or '${ACCOUNT_ID_STATE48}':`);
            if (accountIdentifier !== ACCOUNT_ID_HALLE && accountIdentifier !== ACCOUNT_ID_STATE48) {
                toast('Invalid account identifier entered. Mapping cancelled.', 'error');
                return;
            }
            // ------------------------------------------

            console.log(`Attempting manual map: Student ${studentId} -> Stripe ${stripeCustomerIdInput} on account ${accountIdentifier}`);
            const mapButton = document.querySelector(`.map-stripe-btn[data-student-id="${studentId}"]`);
            if (mapButton) mapButton.textContent = 'Saving...'; // Basic loading state

            try {
                const idToken = await getIdToken(currentUser);
                const serverUrl = HARDCODED_CONFIG.serverUrl;

                const response = await fetch(`${serverUrl}/map-stripe-customer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` }
                    // --- Send accountIdentifier in body ---
                    body: JSON.stringify({ studentId, stripeCustomerId: stripeCustomerIdInput, accountIdentifier }) 
                });

                const result = await response.json();
                if (!response.ok) { throw new Error(result.error || `Server error: ${response.status}`); }

                toast(result.message, 'success');
                
                // Update local cache
                const studentIndex = allStudentsCache.findIndex(s => s.id === studentId);
                if (studentIndex !== -1) {
                    // Ensure stripeInfo exists
                    if (!allStudentsCache[studentIndex].stripeInfo) {
                         allStudentsCache[studentIndex].stripeInfo = {};
                    }
                    allStudentsCache[studentIndex].stripeInfo[accountIdentifier] = stripeCustomerIdInput;
                }
                
                // Re-render relevant list
                if (currentView === 'student') renderCol1StudentList(); 
                else if (currentView === 'class' && currentClassId) renderCol2StudentList(currentClassId); 
                
                if (currentStudentId === studentId) loadStudentBillingData(studentId);

            } catch (error) {
                console.error("Manual Map Error:", error);
                toast(`Mapping failed: ${error.message}`, 'error');
            } finally {
                 if (mapButton) mapButton.textContent = 'Save'; // Reset button text
            }
        };
        // --- END MANUAL MAP FUNCTION ---

        const promptInvoiceParentSelection = async (studentId, studentName) => {
             document.getElementById('invoice-student-id').value = studentId; 
             document.querySelector('#invoice-subtitle span').textContent = studentName; 
             document.getElementById('invoice-description').value = `Class Fee - ${studentName}`; 
             // Reset account selector in invoice modal
             document.getElementById('invoice-account-select').value = ''; 
             
             const parentSelect = document.getElementById('invoice-parent-select'); 
             parentSelect.innerHTML = '<option value="">Loading contacts...</option>'; 
             parentSelect.disabled = true; 
             document.getElementById('create-invoice-btn').disabled = true; 
             document.getElementById('invoice-amount').value = ''; 
             document.getElementById('invoice-status').textContent = '';
             openModal('invoice-modal'); 
             try {
                 const studentRef = doc(getStudentsCol(), studentId); 
                 const studentSnap = await getDoc(studentRef); 
                 if (!studentSnap.exists()) { throw new Error("Student not found"); } 
                 const parentIds = studentSnap.data().parents || [];
                 if (parentIds.length === 0) { /* ... handle no contacts ... */ return; }
                 const contacts = []; 
                 for (let i = 0; i < parentIds.length; i += 30) { /* ... fetch contacts ... */ }
                 if (contacts.length === 0) { /* ... handle fetch failed ... */ return; }
                 parentSelect.innerHTML = '<option value="">-- Select Contact --</option>'; 
                 contacts.sort((a,b) => a.name.localeCompare(b.name)).forEach(contact => { const option = document.createElement('option'); option.value = contact.id; option.textContent = `${contact.name} (${contact.email})`; parentSelect.appendChild(option); }); 
                 parentSelect.disabled = false; 
                 document.getElementById('create-invoice-btn').disabled = false; 
             } catch (error) { /* ... handle error loading contacts ... */ }
         };

        // --- UPDATED: Handle Create Invoice (Sends Account Identifier) ---
        const handleCreateInvoice = async (e) => {
            e.preventDefault(); 
            const btn = document.getElementById('create-invoice-btn'); 
            const statusEl = document.getElementById('invoice-status'); 
            btn.disabled = true; statusEl.textContent = 'Creating...'; 
            statusEl.classList.remove('text-red-600', 'text-green-600');
            
            const parentId = document.getElementById('invoice-parent-select').value; 
            const amount = document.getElementById('invoice-amount').value; 
            const description = document.getElementById('invoice-description').value; 
            const studentId = document.getElementById('invoice-student-id').value; 
            const studentName = allStudentsCache.find(s => s.id === studentId)?.name || null; 
            // --- Get Selected Account ---
            const accountIdentifier = determineAccountContextForInvoice(); 
            
            if (!parentId || !studentId || !amount || !description || !accountIdentifier) { 
                statusEl.textContent = 'Please select parent, account & fill all fields.'; 
                statusEl.classList.add('text-red-600'); 
                btn.disabled = false; return; 
            }
            if (!currentUser) { /* ... handle not authenticated ... */ return; }
            
            try {
                const idToken = await getIdToken(currentUser); 
                const serverUrl = HARDCODED_CONFIG.serverUrl;
                const response = await fetch(`${serverUrl}/create-invoice`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}`}, 
                    // --- Send accountIdentifier ---
                    body: JSON.stringify({ parentId, studentId, studentName, amount, description, accountIdentifier }) 
                });
                if (!response.ok) { const res = await response.json(); throw new Error(res.error || `Server ${response.status}`); }
                const result = await response.json(); 
                toast('Invoice created!', 'success'); 
                statusEl.textContent = `Invoice ${result.invoiceId} created (${result.invoiceStatus}).`; 
                statusEl.classList.add('text-green-600');
                if (result.invoiceUrl) { statusEl.innerHTML += ` <a href="${result.invoiceUrl}" target="_blank" class="text-blue-600 hover:underline">View</a>`; }
                document.getElementById('invoice-amount').value = ''; 
                document.getElementById('invoice-description').value = '';
                // No need to reset account selector here
                setTimeout(() => closeModal('invoice-modal'), 4000); 
            } catch (error) { 
                statusEl.textContent = `Error: ${error.message}`; 
                statusEl.classList.add('text-red-600'); 
                toast('Failed create invoice.', 'error'); 
                btn.disabled = false; 
            } 
        }

        // --- App Start ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Starting app...");
            if (!HARDCODED_CONFIG.firebase.apiKey || /* ... other checks ... */ ) { /* ... handle config error ... */ return; }
            try {
                const app = initializeApp(HARDCODED_CONFIG.firebase); db = getFirestore(app); auth = initializeAuth(app, { persistence: browserLocalPersistence });
                onAuthStateChanged(auth, async (user) => {
                    currentUser = user;
                    if (user) { /* ... handle logged in ... */ listenForClasses(); listenForAllStudents(); renderViewByClass(); } 
                    else { /* ... handle logged out ... */ }
                });
            } catch (error) { /* ... handle init error ... */ return; }

            // --- Setup Event Listeners ---
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('sign-out-btn').addEventListener('click', handleSignOut);
            document.getElementById('manage-users-btn').addEventListener('click', openUserManagementModal);
            document.getElementById('add-user-form')?.addEventListener('submit', handleCreateUser);
            document.getElementById('view-by-class').addEventListener('click', renderViewByClass);
            document.getElementById('view-by-student').addEventListener('click', renderViewByStudent);
            document.getElementById('email-class-btn').addEventListener('click', handleEmailClass);
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.dataset.modal)));
            document.getElementById('add-class-form').addEventListener('submit', handleAddClass);
            document.getElementById('add-new-student-form').addEventListener('submit', handleAddNewStudent);
            document.getElementById('add-existing-student-form').addEventListener('submit', handleAddExistingStudent);
            document.getElementById('add-contact-form').addEventListener('submit', handleAddContact);
            document.getElementById('email-form').addEventListener('submit', handleSendEmail);
            document.getElementById('edit-class-form').addEventListener('submit', handleUpdateClass);
            document.getElementById('edit-student-form').addEventListener('submit', handleUpdateStudent);
            document.getElementById('edit-contact-form').addEventListener('submit', handleUpdateContact);
            document.getElementById('create-invoice-form').addEventListener('submit', handleCreateInvoice);
            document.getElementById('col-1-add-btn').addEventListener('click', () => openModal(currentView === 'class' ? 'add-class-modal' : 'add-new-student-modal'));
            document.getElementById('add-new-student-btn').addEventListener('click', () => openModal('add-new-student-modal'));
            document.getElementById('add-existing-student-btn').addEventListener('click', () => { /* ... */ });
            document.getElementById('add-contact-btn').addEventListener('click', () => { /* ... */ });
            document.getElementById('nav-col-1').addEventListener('click', () => { showCol('col-1-section'); setActiveNav('nav-col-1'); });
            document.getElementById('nav-col-2').addEventListener('click', () => { showCol('col-2-section'); setActiveNav('nav-col-2'); });
            document.getElementById('nav-contacts').addEventListener('click', () => { showCol('col-3-section'); setActiveNav('nav-contacts'); });

            // --- Listener for Manual Mapping ---
            document.getElementById('col-1-list').addEventListener('click', (e) => { if (e.target.classList.contains('map-stripe-btn')) { const studentId = e.target.dataset.studentId; const inputElement = document.getElementById(`map-${studentId}`); if (studentId && inputElement) { handleMapStripeId(studentId, inputElement.value); } } });
            document.getElementById('col-2-list').addEventListener('click', (e) => { if (e.target.classList.contains('map-stripe-btn')) { const studentId = e.target.dataset.studentId; const inputElement = document.getElementById(`map-${studentId}`); if (studentId && inputElement) { handleMapStripeId(studentId, inputElement.value); } } });
            
            // --- NEW: Listener for Account Context Selector ---
            document.getElementById('account-context-select').addEventListener('change', () => {
                if (currentStudentId) {
                     loadStudentBillingData(currentStudentId); // Reload billing data when context changes
                }
            });
            // ---------------------------------------------

            window.auth = auth; window.handleMakeAdmin = handleMakeAdmin; console.log("App setup complete.");
        });
    </script>

</body>
</html>