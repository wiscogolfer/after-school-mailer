<script type="module">
// ====== MAP STRIPE CUSTOMER — UI + HANDLERS ======

// Elements
const mapBtn            = document.getElementById('map-customer-btn');
const mapModal          = document.getElementById('map-customer-modal');
const mapOrgSelect      = document.getElementById('map-org');
const mapSearchInput    = document.getElementById('map-search');
const mapSearchBtn      = document.getElementById('map-search-btn');
const mapResults        = document.getElementById('map-results');

// Guard toast helper (already defined in your file): toast(message, type='success')

// Open modal
function openMapCustomerModal() {
  if (!currentStudentId) { toast('Select a student first.', 'error'); return; }
  mapSearchInput.value = '';
  mapResults.innerHTML = '';
  openModal('map-customer-modal');
}

// Render results list
function renderMapResults(items, orgId) {
  mapResults.innerHTML = '';
  if (!items?.length) {
    mapResults.innerHTML = `<div class="text-gray-500">No matches.</div>`;
    return;
  }
  items.forEach(c => {
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between border rounded px-2 py-1';
    row.innerHTML = `
      <div>
        <div class="font-medium">${c.name || '(no name)'}</div>
        <div class="text-xs text-gray-600">${c.email || '(no email)'} — ${c.id}</div>
      </div>
      <button class="bg-blue-600 text-white text-xs px-2 py-1 rounded map-choose" data-id="${c.id}" data-org="${orgId}">
        Map
      </button>
    `;
    mapResults.appendChild(row);
  });

  // Map click handlers
  mapResults.querySelectorAll('.map-choose').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const customerId = e.currentTarget.dataset.id;
      const orgIdSel   = e.currentTarget.dataset.org;

      if (!currentStudentId) { toast('No student selected.', 'error'); return; }

      try {
        const idToken = await getIdTokenSafe();
        const resp = await fetch(`${HARDCODED_CONFIG.serverUrl}/stripe/map-customer`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${idToken}`
          },
          body: JSON.stringify({
            orgId: orgIdSel,
            studentId: currentStudentId,
            customerId
          })
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data?.error || `Server ${resp.status}`);

        // Optimistically update local cache so the UI reflects immediately
        const stu = allStudentsCache.find(s => s.id === currentStudentId);
        if (stu) {
          if (!stu.stripe) stu.stripe = {};
          if (!stu.stripe.customers) stu.stripe.customers = {};
          stu.stripe.customers[orgIdSel] = customerId;
        }

        toast('Mapped successfully!');
        closeModal('map-customer-modal');
        refreshBillingUI();
      } catch (err) {
        console.error(err);
        toast(`Map failed: ${err.message}`, 'error');
      }
    });
  });
}

// Search handler
async function searchStripeCustomers() {
  const q = (mapSearchInput.value || '').trim();
  const orgId = mapOrgSelect.value;
  if (!q) { toast('Enter a search term.', 'error'); return; }

  try {
    const idToken = await getIdTokenSafe();
    const url = `${HARDCODED_CONFIG.serverUrl}/stripe/search-customers?orgId=${encodeURIComponent(orgId)}&q=${encodeURIComponent(q)}`;
    const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${idToken}` }});
    const data = await resp.json();
    if (!resp.ok) throw new Error(data?.error || `Server ${resp.status}`);
    renderMapResults(data.data || [], orgId);
  } catch (err) {
    console.error(err);
    toast(`Search failed: ${err.message}`, 'error');
  }
}

// Wire up
if (mapBtn) mapBtn.addEventListener('click', openMapCustomerModal);
if (mapSearchBtn) mapSearchBtn.addEventListener('click', (e) => { e.preventDefault(); searchStripeCustomers(); });

// Also refresh billing UI when org selector changes (if present)
const invoiceOrgSel = document.getElementById('invoice-org');
if (invoiceOrgSel) {
  invoiceOrgSel.addEventListener('change', () => {
    // Keep the visible label in sync if you use one
    const orgLabel = document.getElementById('billing-org-label');
    if (orgLabel) orgLabel.textContent = invoiceOrgSel.value;
    refreshBillingUI();
  });
}
</script>
