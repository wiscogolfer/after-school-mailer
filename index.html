<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>After-School Program Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
  <style>
    html{scroll-behavior:smooth}
    body{font-family:'Inter',sans-serif}
    .modal{display:none}
    .modal.flex{display:flex}
    .scrolling-list::-webkit-scrollbar{width:6px}
    .scrolling-list::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
    .scrolling-list::-webkit-scrollbar-thumb{background:#c5c5c5;border-radius:10px}
    .scrolling-list::-webkit-scrollbar-thumb:hover{background:#a8a8a8}
    #app-shell{display:none}
    .icon-btn{background:none;border:none;padding:.25rem;cursor:pointer;color:#9ca3af}
    .icon-btn:hover{color:#dc2626}
    .icon-btn.edit:hover{color:#2563eb}
    /* Bottom tab bar hides on md+ */
    @media (min-width: 768px){nav.mobile-tabs{display:none}}
    @media (max-width: 767px){
      #main-grid{grid-template-columns: 1fr !important}
      .column-section{display:none}
      .column-section.active{display:flex}
    }
  </style>
</head>

<body class="h-full flex flex-col pb-16 md:pb-0">
  <!-- Auth -->
  <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 p-4">
    <div class="w-full max-w-md p-8 bg-white rounded-lg shadow-xl">
      <form id="login-form">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Sign In</h2>
        <div class="space-y-4">
          <div>
            <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="login-email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"/>
          </div>
          <div>
            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="login-password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"/>
          </div>
        </div>
        <div class="mt-6">
          <button id="login-btn" type="submit" class="w-full flex justify-center py-2 px-4 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Sign In</button>
        </div>
        <p id="login-error" class="text-xs text-red-600 mt-2 text-center h-4"></p>
      </form>
    </div>
  </div>

  <!-- App Shell -->
  <div id="app-shell" class="h-full flex flex-col">
    <!-- Toast -->
    <div id="toast" class="fixed top-5 right-5 z-70 hidden items-center w-full max-w-xs p-4 text-gray-700 bg-white rounded-lg shadow">
      <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-600 bg-green-100 rounded-lg"></div>
      <div id="toast-message" class="ml-3 text-sm font-normal">Done.</div>
    </div>

    <!-- Header -->
    <div class="bg-gray-800 p-2 text-white">
      <div class="container mx-auto flex flex-col sm:flex-row sm:items-center gap-4 justify-between">
        <div class="flex items-center space-x-3">
          <img src="https://state48arts.org/wp-content/uploads/2025/05/cropped-8459414c-5a7e-4a6b-b582-2f92ab56bc79-2-1-279x300.png" alt="Logo" class="h-10 w-10 rounded-full flex-shrink-0"/>
          <h1 class="text-lg font-semibold whitespace-nowrap">State 48 After School Class Management</h1>
        </div>
        <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 self-end sm:self-center">
          <div class="text-right sm:text-left">
            <span class="text-sm font-medium block sm:inline">Signed in as:</span>
            <span id="user-email-display" class="text-sm text-gray-300 block sm:inline"></span>
            <span id="user-admin-status" class="text-xs text-yellow-400 ml-1 font-medium hidden">(Admin)</span>
          </div>
          <div class="flex gap-2 justify-end">
            <button id="manage-users-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1.5 rounded-md text-sm hidden">Manage Users</button>
            <button id="sign-out-btn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-md text-sm">Sign Out</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="flex-1 container mx-auto p-4 h-full">
      <div class="mb-4 flex justify-between items-center">
        <div class="flex p-1 bg-gray-200 rounded-lg">
          <button id="view-by-class" class="px-4 py-2 text-sm font-medium bg-white text-blue-700 rounded-md shadow-sm">View By Class</button>
          <button id="view-by-student" class="px-4 py-2 text-sm font-medium text-gray-700">View By Student</button>
        </div>
        <button id="email-class-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition hidden">Email Class</button>
      </div>

      <div id="main-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
        <!-- Col 1 -->
        <section id="col-1-section" class="column-section active md:flex bg-white p-4 rounded-lg shadow-lg flex flex-col h-full">
          <div class="flex justify-between items-center mb-4 gap-2">
            <h2 id="col-1-title" class="text-2xl font-bold text-gray-800">Classes</h2>
            <button id="col-1-add-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">Add Class</button>
          </div>
          <div id="col-1-list" class="scrolling-list flex-1 overflow-y-auto space-y-2 min-h-0 pb-16 md:pb-0"></div>
        </section>

        <!-- Col 2 -->
        <section id="col-2-section" class="column-section md:flex bg-white p-4 rounded-lg shadow-lg flex-col h-full hidden md:flex">
          <div class="flex justify-between items-center mb-4 gap-2">
            <div>
              <h2 id="col-2-title" class="text-2xl font-bold text-gray-800">Students</h2>
              <p id="col-2-subtitle" class="text-sm text-gray-500">Select a class</p>
            </div>
            <div id="col-2-btn-group" class="flex gap-2">
              <button id="add-existing-student-btn" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg font-medium hover:bg-gray-300 transition text-sm" disabled>Add Existing</button>
              <button id="add-new-student-btn" class="bg-blue-600 text-white px-3 py-2 rounded-lg font-medium hover:bg-blue-700 transition text-sm" disabled>Add New</button>
            </div>
          </div>
          <div id="col-2-list" class="scrolling-list flex-1 overflow-y-auto space-y-2 min-h-0 pb-16 md:pb-0"></div>

          <!-- Stripe: Mapping & Billing (multi-org) -->
          <div id="stripe-billing-card" class="mt-6 p-4 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold text-gray-800">Stripe: Mapping & Billing</h3>
            </div>

            <label class="block text-sm font-medium mb-1">Select Organization:</label>
            <select id="stripe-org-select" class="border rounded-md p-2 w-full mb-3">
              <option value="State-48-Dance">State-48 Dance</option>
              <option value="State-48-Theatre">State-48 Theatre</option>
            </select>

            <div id="stripe-org-map-status" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700 mb-3">No student selected</div>

            <div id="stripe-mapped-actions" class="hidden mb-4 space-x-2">
              <button id="stripe-list-invoices-btn" type="button" class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200 text-sm">List Invoices</button>
              <button id="stripe-list-subs-btn" type="button" class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200 text-sm">List Subscriptions</button>
            </div>

            <form id="stripe-search-form" class="flex items-stretch gap-2">
              <input id="stripe-search-q" type="text" class="flex-1 border rounded-md p-2" placeholder="Search Stripe customersâ€¦"/>
              <button type="submit" class="px-3 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Search</button>
            </form>

            <div id="stripe-search-results" class="mt-3 space-y-2"></div>

            <div id="stripe-invoices" class="mt-4 hidden">
              <h4 class="font-medium text-gray-800 mb-2">Invoices</h4>
              <div id="stripe-invoices-body" class="space-y-2"></div>
            </div>

            <div id="stripe-subs" class="mt-4 hidden">
              <h4 class="font-medium text-gray-800 mb-2">Subscriptions</h4>
              <div id="stripe-subs-body" class="space-y-2"></div>
            </div>

            <p id="stripe-status" class="text-xs text-gray-500 mt-3 h-4"></p>
          </div>
        </section>

        <!-- Col 3 -->
        <section id="col-3-section" class="column-section md:flex bg-white p-4 rounded-lg shadow-lg flex-col h-full hidden md:flex">
          <div class="flex justify-between items-center mb-4 gap-2">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Parents/Contacts</h2>
              <p id="contact-student-subtitle" class="text-sm text-gray-500">Select a student</p>
            </div>
            <button id="add-contact-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition" disabled>Add Contact</button>
          </div>
          <div id="contact-list" class="scrolling-list flex-1 overflow-y-auto space-y-2 min-h-0 pb-16 md:pb-0"></div>

          <!-- Email compose quick button for selected contact list (hidden on load, opened via row button) -->
        </section>
      </div>
    </div>

    <!-- Bottom Tabs (mobile) -->
    <nav class="mobile-tabs fixed bottom-0 left-0 right-0 z-40 bg-white shadow-inner p-2 border-t border-gray-200 md:hidden">
      <div class="flex justify-around">
        <button id="nav-col-1" class="flex flex-col items-center p-2 text-blue-600" data-col="col-1-section">
          <i class="fa-solid fa-chalkboard-user text-lg"></i>
          <span id="nav-col-1-title" class="text-xs">Classes</span>
        </button>
        <button id="nav-col-2" class="flex flex-col items-center p-2 text-gray-500" data-col="col-2-section">
          <i class="fa-solid fa-user-graduate text-lg"></i>
          <span id="nav-col-2-title" class="text-xs">Students</span>
        </button>
        <button id="nav-contacts" class="flex flex-col items-center p-2 text-gray-500" data-col="col-3-section">
          <i class="fa-solid fa-address-book text-lg"></i>
          <span class="text-xs">Contacts</span>
        </button>
      </div>
    </nav>
  </div>

  <!-- Modals -->
  <!-- Add Class -->
  <div id="add-class-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Add New Class</h3>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="add-class-modal">&times;</button>
      </div>
      <form id="add-class-form">
        <div class="space-y-4">
          <div>
            <label for="class-name" class="block text-sm font-medium text-gray-700">Class Name</label>
            <input type="text" id="class-name" class="mt-1 block w-full border rounded-md p-2" required/>
          </div>
          <div>
            <label for="teacher-name" class="block text-sm font-medium text-gray-700">Teacher Name</label>
            <input type="text" id="teacher-name" class="mt-1 block w-full border rounded-md p-2" required/>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="close-modal-btn bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 transition" data-modal="add-class-modal">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Save Class</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Class -->
  <div id="edit-class-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Edit Class</h3>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="edit-class-modal">&times;</button>
      </div>
      <form id="edit-class-form">
        <input type="hidden" id="edit-class-id"/>
        <div class="space-y-4">
          <div>
            <label for="edit-class-name" class="block text-sm font-medium text-gray-700">Class Name</label>
            <input type="text" id="edit-class-name" class="mt-1 block w-full border rounded-md p-2" required/>
          </div>
          <div>
            <label for="edit-teacher-name" class="block text-sm font-medium text-gray-700">Teacher Name</label>
            <input type="text" id="edit-teacher-name" class="mt-1 block w-full border rounded-md p-2" required/>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="close-modal-btn bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 transition" data-modal="edit-class-modal">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Update Class</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add New Student -->
  <div id="add-new-student-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Add New Student</h3>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="add-new-student-modal">&times;</button>
      </div>
      <form id="add-new-student-form">
        <div>
          <label for="new-student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
          <input type="text" id="new-student-name" class="mt-1 block w-full border rounded-md p-2" required/>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="close-modal-btn bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 transition" data-modal="add-new-student-modal">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Save Student</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Student -->
  <div id="edit-student-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
    <div class="relative top-20 mx-auto p-5 border w/full max-w-md shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Edit Student</h3>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="edit-student-modal">&times;</button>
      </div>
      <form id="edit-student-form">
        <input type="hidden" id="edit-student-id"/>
        <div>
          <label for="edit-student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
          <input type="text" id="edit-student-name" class="mt-1 block w-full border rounded-md p-2" required/>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="close-modal-btn bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 transition" data-modal="edit-student-modal">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Update Student</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Existing Student -->
  <div id="add-existing-student-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Add Existing Student</h3>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="add-existing-student-modal">&times;</button>
      </div>
      <p id="add-existing-student-subtitle" class="text-sm text-gray-600 mb-4">Adding to class: <span class="font-medium"></span></p>
      <form id="add-existing-student-form">
        <div>
          <label for="existing-student-select" class="block text-sm font-medium text-gray-700">Select Student</label>
          <select id="existing-student-select" class="mt-1 block w-full border rounded-md p-2" required>
            <option value="">Loading students...</option>
          </select>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="close-modal-btn bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 transition" data-modal="add-existing-student-modal">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Add to Class</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Contact -->
  <div id="add-contact-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
    <div class="relative top-20 mx-auto p-5 border w/full max-w-md shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Add New Contact</h3>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="add-contact-modal">&times;</button>
      </div>
      <p id="add-contact-subtitle" class="text-sm text-gray-600 mb-4">Adding contact for: <span class="font-medium"></span></p>
      <form id="add-contact-form">
        <div class="space-y-4">
          <div>
            <label for="contact-name" class="block text-sm font-medium text-gray-700">Contact Name</label>
            <input type="text" id="contact-name" class="mt-1 block w-full border rounded-md p-2" required/>
          </div>
          <div>
            <label for="contact-email" class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="contact-email" class="mt-1 block w/full border rounded-md p-2" required/>
          </div>
          <div>
            <label for="contact-phone" class="block text-sm font-medium text-gray-700">Phone</label>
            <input type="tel" id="contact-phone" class="mt-1 block w/full border rounded-md p-2"/>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="close-modal-btn bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 transition" data-modal="add-contact-modal">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Save Contact</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Contact -->
  <div id="edit-contact-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w/full z-60">
    <div class="relative top-20 mx-auto p-5 border w/full max-w-md shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Edit Contact</h3>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="edit-contact-modal">&times;</button>
      </div>
      <form id="edit-contact-form">
        <input type="hidden" id="edit-contact-id"/>
        <div class="space-y-4">
          <div>
            <label for="edit-contact-name" class="block text-sm font-medium text-gray-700">Contact Name</label>
            <input type="text" id="edit-contact-name" class="mt-1 block w/full border rounded-md p-2" required/>
          </div>
          <div>
            <label for="edit-contact-email" class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="edit-contact-email" class="mt-1 block w/full border rounded-md p-2" required/>
          </div>
          <div>
            <label for="edit-contact-phone" class="block text-sm font-medium text-gray-700">Phone</label>
            <input type="tel" id="edit-contact-phone" class="mt-1 block w/full border rounded-md p-2"/>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="close-modal-btn bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 transition" data-modal="edit-contact-modal">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Update Contact</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Email Modal -->
  <div id="email-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
    <div class="relative top-10 mx-auto p-5 border w/full max-w-2xl shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Compose Email</h3>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="email-modal">&times;</button>
      </div>
      <form id="email-form">
        <p class="text-xs text-gray-500 mb-3">Replies will go to: <span id="reply-to-email"></span></p>
        <div class="space-y-4">
          <div id="email-to-wrapper">
            <label for="email-to" class="block text-sm font-medium text-gray-700">To:</label>
            <input type="email" id="email-to" class="mt-1 block w/full border rounded-md p-2 bg-gray-100" readonly/>
          </div>
          <div id="email-bcc-wrapper">
            <label for="email-bcc" class="block text-sm font-medium text-gray-700">BCC:</label>
            <input type="text" id="email-bcc" class="mt-1 block w/full border rounded-md p-2 bg-gray-100" readonly/>
          </div>
          <div>
            <label for="email-subject" class="block text-sm font-medium text-gray-700">Subject:</label>
            <input type="text" id="email-subject" class="mt-1 block w/full border rounded-md p-2" required/>
          </div>
          <div>
            <label for="email-body" class="block text-sm font-medium text-gray-700">Message:</label>
            <textarea id="email-body" rows="8" class="mt-1 block w/full border rounded-md p-2" required></textarea>
          </div>
        </div>
        <div class="mt-6 flex justify-between items-center gap-3">
          <span id="email-status" class="text-sm text-gray-500"></span>
          <div class="flex gap-3">
            <button type="button" class="close-modal-btn bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 transition" data-modal="email-modal">Cancel</button>
            <button type="submit" id="send-email-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Send Email</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div id="invoice-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w/full z-60">
    <div class="relative top-20 mx-auto p-5 border w/full max-w-md shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Create Invoice</h3>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="invoice-modal">&times;</button>
      </div>
      <p id="invoice-subtitle" class="text-sm text-gray-600 mb-4">Creating invoice for: <span class="font-medium"></span></p>
      <form id="create-invoice-form">
        <input type="hidden" id="invoice-parent-id"/>
        <div class="space-y-4">
          <div>
            <label for="invoice-amount" class="block text-sm font-medium text-gray-700">Amount (e.g., 25.00)</label>
            <input type="number" id="invoice-amount" step="0.01" min="0.01" class="mt-1 block w/full border rounded-md p-2" required/>
          </div>
          <div>
            <label for="invoice-description" class="block text-sm font-medium text-gray-700">Description</label>
            <input type="text" id="invoice-description" placeholder="e.g., October Class Fee" class="mt-1 block w/full border rounded-md p-2" required/>
          </div>
        </div>
        <p id="invoice-status" class="text-xs mt-4 h-4"></p>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="close-modal-btn bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 transition" data-modal="invoice-modal">Cancel</button>
          <button type="submit" id="create-invoice-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Create Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <!-- User Management -->
  <div id="user-management-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w/full z-60">
    <div class="relative top-10 mx-auto p-5 border w/full max-w-xl shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-medium leading-6 text-gray-900">Manage Users</h3>
        <button class="close-modal-btn text-gray-400 hover:text-gray-600" data-modal="user-management-modal">&times;</button>
      </div>

      <form id="add-user-form" class="mb-6 pb-6 border-b border-gray-200">
        <h4 class="text-lg font-medium text-gray-800 mb-3">Add New User</h4>
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
          <div>
            <label for="new-user-name" class="block text-sm font-medium text-gray-700">Name</label>
            <input type="text" id="new-user-name" required class="mt-1 block w/full border rounded-md p-2"/>
          </div>
          <div>
            <label for="new-user-email" class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="new-user-email" required class="mt-1 block w/full border rounded-md p-2"/>
          </div>
          <div>
            <label for="new-user-password" class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="new-user-password" minlength="6" required class="mt-1 block w/full border rounded-md p-2"/>
          </div>
          <button type="submit" id="add-user-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition sm:w-auto">Add User</button>
        </div>
        <p id="add-user-status" class="text-xs mt-2 h-4"></p>
      </form>

      <div>
        <h4 class="text-lg font-medium text-gray-800 mb-3">Existing Users</h4>
        <div id="user-list" class="scrolling-list max-h-60 overflow-y-auto space-y-2 pr-2">
          <p class="text-gray-500">Loading users...</p>
        </div>
      </div>

      <div class="mt-6 flex justify-end">
        <button type="button" class="close-modal-btn bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 transition" data-modal="user-management-modal">Close</button>
      </div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    // ------- CONFIG -------
    const HARDCODED_CONFIG = {
      serverUrl: "https://after-school-mailer.onrender.com",
      // Firestore org where your app data (classes/students/parents) lives
      organizationId: "State-48-Dance",
      firebase: {
        apiKey: "AIzaSyAYDMyMAw7wf3i28C-hQ_iRZRVdMiXmaLk",
        authDomain: "dance-classes-97ad7.firebaseapp.com",
        projectId: "dance-classes-97ad7",
        appId: "1:1041555303856:web:5b80e0497eacaf161b7a75"
      }
    };

    // ------- Imports -------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      initializeAuth,
      browserLocalPersistence,
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
      getIdToken,
      getIdTokenResult
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      setDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      onSnapshot,
      query,
      where,
      arrayUnion,
      arrayRemove,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ------- Globals -------
    let db, auth;
    let currentUser = null;
    let userId = null;
    let isAdmin = false;

    const organizationId = HARDCODED_CONFIG.organizationId;

    let allClassCache = [];
    let allStudentsCache = [];
    let contactCache = new Map();
    let unsubscribeClasses = null;
    let unsubscribeAllStudents = null;
    let unsubscribeContacts = null;

    let currentView = "class";        // 'class' | 'student'
    let currentClassId = null;
    let currentStudentId = null;

    // ------- UI helpers -------
    const toast = (msg, type='success', ms=2000) => {
      const el = document.getElementById("toast");
      const icon = document.getElementById("toast-icon");
      const txt = document.getElementById("toast-message");
      if (!el) return;
      txt.textContent = msg;
      icon.className = "inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg " +
                       (type==='success' ? "text-green-600 bg-green-100" : "text-red-600 bg-red-100");
      el.classList.remove("hidden");
      setTimeout(()=>el.classList.add("hidden"), ms);
    };
    const openModal = id => document.getElementById(id)?.classList.add("flex");
    const closeModal = id => document.getElementById(id)?.classList.remove("flex");

    // ------- Collections -------
    const getClassesCol  = () => collection(db, `organizations/${organizationId}/classes`);
    const getStudentsCol = () => collection(db, `organizations/${organizationId}/students`);
    const getParentsCol  = () => collection(db, `organizations/${organizationId}/parents`);

    // ------- Rendering -------
    const renderViewByClass = () => {
      currentView = "class";
      document.getElementById("col-1-title").textContent = "Classes";
      document.getElementById("col-1-add-btn").textContent = "Add Class";
      document.getElementById("col-2-title").textContent = "Students";
      document.getElementById("col-2-btn-group").classList.remove("hidden");
      document.getElementById("email-class-btn").classList.remove("hidden");
      document.getElementById("nav-col-1-title").textContent = "Classes";
      document.getElementById("nav-col-2-title").textContent = "Students";
      currentClassId = null; currentStudentId = null;
      resetCol2(); resetCol3(); renderCol1ClassList();
      setActiveTab("col-1-section");
    };

    const renderViewByStudent = () => {
      currentView = "student";
      document.getElementById("col-1-title").textContent = "All Students";
      document.getElementById("col-1-add-btn").textContent = "Add Student";
      document.getElementById("col-2-title").textContent = "Enrolled In";
      document.getElementById("col-2-btn-group").classList.add("hidden");
      document.getElementById("email-class-btn").classList.add("hidden");
      document.getElementById("nav-col-1-title").textContent = "Students";
      document.getElementById("nav-col-2-title").textContent = "Classes";
      currentClassId = null; currentStudentId = null;
      resetCol2(); resetCol3(); renderCol1StudentList();
      setActiveTab("col-1-section");
    };

    const renderCol1ClassList = () => {
      const list = document.getElementById("col-1-list");
      list.innerHTML = "";
      if (allClassCache.length===0){ list.innerHTML = '<p class="text-gray-500 text-center">No classes found. Add one!</p>'; return;}
      const sorted = [...allClassCache].sort((a,b)=>a.name.localeCompare(b.name));
      sorted.forEach(c=>{
        const el = document.createElement("div");
        el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentClassId===c.id?'bg-blue-50 border-blue-300':''}`;
        el.dataset.id = c.id;
        el.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="font-medium text-gray-800">${c.name}</span>
            <div class="flex items-center space-x-2">
              <button class="edit-class-btn icon-btn edit" title="Edit Class"><i class="fas fa-pencil-alt fa-xs"></i></button>
              <button class="delete-class-btn icon-btn" title="Delete Class"><i class="fas fa-times fa-sm"></i></button>
            </div>
          </div>
          <p class="text-sm text-gray-600">${c.teacher}</p>`;
        el.addEventListener("click", ()=>selectClass(c.id, c.name));
        el.querySelector(".edit-class-btn").addEventListener("click", (e)=>{e.stopPropagation(); openEditClassModal(c.id);});
        el.querySelector(".delete-class-btn").addEventListener("click", (e)=>{e.stopPropagation(); handleDeleteClass(c.id, c.name);});
        list.appendChild(el);
      });
    };

    const renderCol1StudentList = () => {
      const list = document.getElementById("col-1-list");
      list.innerHTML = "";
      if (allStudentsCache.length===0){ list.innerHTML = '<p class="text-gray-500 text-center">No students found. Add one!</p>'; return;}
      const sorted = [...allStudentsCache].sort((a,b)=>a.name.localeCompare(b.name));
      sorted.forEach(s=>{
        const el = document.createElement("div");
        el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentStudentId===s.id?'bg-blue-50 border-blue-300':''}`;
        el.dataset.id = s.id;
        el.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="font-medium text-gray-800">${s.name}</span>
            <div class="flex items-center space-x-2">
              <button class="edit-student-btn icon-btn edit" title="Edit Student"><i class="fas fa-pencil-alt fa-xs"></i></button>
              <button class="delete-student-btn icon-btn" title="Delete Student"><i class="fas fa-times fa-sm"></i></button>
            </div>
          </div>`;
        el.addEventListener("click", ()=>selectStudent(s.id, s.name));
        el.querySelector(".edit-student-btn").addEventListener("click", (e)=>{e.stopPropagation(); openEditStudentModal(s.id);});
        el.querySelector(".delete-student-btn").addEventListener("click", (e)=>{e.stopPropagation(); handleDeleteStudent(s.id, s.name);});
        list.appendChild(el);
      });
    };

    const renderCol2StudentList = (classId) => {
      const list = document.getElementById("col-2-list");
      const c = allClassCache.find(x=>x.id===classId);
      if (!c || !c.students || c.students.length===0){ list.innerHTML='<p class="text-gray-500 text-center">No students in this class.</p>'; return; }
      const students = allStudentsCache.filter(s=>c.students.includes(s.id)).sort((a,b)=>a.name.localeCompare(b.name));
      list.innerHTML = "";
      students.forEach(s=>{
        const el = document.createElement("div");
        el.className = `p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 ${currentStudentId===s.id?'bg-blue-50 border-blue-300':''}`;
        el.dataset.id = s.id;
        el.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="font-medium text-gray-800">${s.name}</span>
            <div class="flex items-center space-x-2">
              <button class="edit-student-btn icon-btn edit" title="Edit Student"><i class="fas fa-pencil-alt fa-xs"></i></button>
              <button class="remove-student-btn icon-btn" title="Remove from class"><i class="fas fa-times fa-sm"></i></button>
            </div>
          </div>`;
        el.addEventListener("click", ()=>selectStudent(s.id, s.name));
        el.querySelector(".edit-student-btn").addEventListener("click", (e)=>{e.stopPropagation(); openEditStudentModal(s.id);});
        el.querySelector(".remove-student-btn").addEventListener("click", (e)=>{e.stopPropagation(); handleRemoveStudent(s.id, s.name);});
        list.appendChild(el);
      });
    };

    const renderCol2ClassList = (studentId) => {
      const list = document.getElementById("col-2-list");
      const classes = allClassCache.filter(c=>c.students && c.students.includes(studentId)).sort((a,b)=>a.name.localeCompare(b.name));
      if (classes.length===0){ list.innerHTML='<p class="text-gray-500 text-center">Not enrolled in any classes.</p>'; return; }
      list.innerHTML = "";
      classes.forEach(c=>{
        const el = document.createElement("div");
        el.className = "p-3 rounded-lg border border-gray-200";
        el.dataset.id = c.id;
        el.innerHTML = `<span class="font-medium text-gray-800">${c.name}</span><p class="text-sm text-gray-600">${c.teacher}</p>`;
        list.appendChild(el);
      });
    };

    const renderStudentDropdown = () => {
      const select = document.getElementById("existing-student-select");
      if (!select) return;
      select.innerHTML = '<option value="">Select a student...</option>';
      if (!currentClassId) return;
      const c = allClassCache.find(x=>x.id===currentClassId); if (!c) return;
      const inClass = c.students || [];
      const available = allStudentsCache.filter(s=>!inClass.includes(s.id)).sort((a,b)=>a.name.localeCompare(b.name));
      if (available.length===0){ select.innerHTML='<option value="">No other students available</option>'; return; }
      available.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s.id; opt.textContent = s.name;
        select.appendChild(opt);
      });
    };

    const renderContactList = (contacts) => {
      const list = document.getElementById("contact-list");
      list.innerHTML = "";
      const sorted = [...contacts].sort((a,b)=>a.name.localeCompare(b.name));
      if (sorted.length===0){ list.innerHTML='<p class="text-gray-500 text-center">No contacts for this student.</p>'; return; }
      sorted.forEach(c=>{
        const el = document.createElement("div");
        el.className = "p-3 rounded-lg border border-gray-200";
        el.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <span class="font-medium text-gray-800">${c.name}</span>
              <p class="text-sm text-gray-600">${c.email}</p>
              <p class="text-sm text-gray-600">${c.phone || ''}</p>
              <div class="mt-2 space-x-3">
                <button class="email-contact-btn text-sm text-blue-600 hover:underline" data-email="${c.email}" data-name="${c.name}">Email</button>
                <button class="invoice-contact-btn text-sm text-green-600 hover:underline" data-parent-id="${c.id}" data-parent-name="${c.name}">Invoice</button>
              </div>
            </div>
            <div class="flex items-center space-x-2 flex-shrink-0">
              <button class="edit-contact-btn icon-btn edit" title="Edit Contact"><i class="fas fa-pencil-alt fa-xs"></i></button>
              <button class="delete-contact-btn icon-btn" title="Delete Contact"><i class="fas fa-times fa-sm"></i></button>
            </div>
          </div>`;
        el.querySelector(".edit-contact-btn").addEventListener("click", (e)=>{e.stopPropagation(); openEditContactModal(c.id);});
        el.querySelector(".delete-contact-btn").addEventListener("click", (e)=>{e.stopPropagation(); handleDeleteContact(c.id, c.name);});
        el.querySelector(".email-contact-btn").addEventListener("click", (e)=>{e.stopPropagation(); openEmailModal({ to: c.email });});
        el.querySelector(".invoice-contact-btn").addEventListener("click", (e)=>{e.stopPropagation(); openInvoiceModal(c.id, c.name);});
        list.appendChild(el);
      });
    };

    const resetCol2 = () => {
      document.getElementById("col-2-subtitle").textContent = currentView==="class" ? "Select a class" : "Select a student";
      document.getElementById("col-2-list").innerHTML = "";
      if (currentView==="class"){
        document.getElementById("add-new-student-btn").disabled = true;
        document.getElementById("add-existing-student-btn").disabled = true;
      }
    };
    const resetCol3 = () => {
      document.getElementById("contact-student-subtitle").textContent = "Select a student";
      document.getElementById("contact-list").innerHTML = "";
      document.getElementById("add-contact-btn").disabled = true;
    };

    // ------- Data listeners -------
    const listenForClasses = () => {
      if (unsubscribeClasses) unsubscribeClasses();
      unsubscribeClasses = onSnapshot(getClassesCol(), snap=>{
        allClassCache = [];
        snap.forEach(d=>allClassCache.push({id:d.id, ...d.data()}));
        if (currentView==="class") renderCol1ClassList();
        if (currentView==="student" && currentStudentId) renderCol2ClassList(currentStudentId);
      }, err=>{ console.error(err); toast("Failed to load classes","error"); });
    };

    const listenForAllStudents = () => {
      if (unsubscribeAllStudents) unsubscribeAllStudents();
      unsubscribeAllStudents = onSnapshot(getStudentsCol(), snap=>{
        allStudentsCache = [];
        snap.forEach(d=>allStudentsCache.push({id:d.id, ...d.data()}));
        if (currentView==="student") renderCol1StudentList();
        if (currentView==="class" && currentClassId){
          renderCol2StudentList(currentClassId);
          renderStudentDropdown();
        }
        if (currentStudentId) listenForContacts(currentStudentId);
      }, err=>{ console.error(err); toast("Failed to load students","error"); });
    };

    const listenForContacts = (studentId) => {
      if (unsubscribeContacts) unsubscribeContacts();
      contactCache.clear();
      if (!studentId){ renderContactList([]); return; }
      const studentRef = doc(getStudentsCol(), studentId);
      unsubscribeContacts = onSnapshot(studentRef, async d=>{
        if (!d.exists()){ renderContactList([]); return; }
        const data = d.data();
        const parentIds = data.parents || [];
        if (parentIds.length===0){ renderContactList([]); return; }
        try{
          const contacts = [];
          for (let i=0;i<parentIds.length;i+=30){
            const chunk = parentIds.slice(i,i+30);
            if (chunk.length===0) continue;
            const qy = query(getParentsCol(), where("__name__","in",chunk));
            const qs = await getDocs(qy);
            qs.docs.forEach(x=>{
              const c = {id:x.id, ...x.data()};
              contacts.push(c); contactCache.set(x.id, c);
            });
          }
          renderContactList(contacts);
        }catch(e){ console.error(e); toast("Failed to load contacts","error"); renderContactList([]); }
      }, err=>{ console.error(err); toast("Failed to load contacts","error"); renderContactList([]); });
    };

    // ------- Selectors -------
    const setActiveTab = (id) => {
      // mobile show only one column
      ["col-1-section","col-2-section","col-3-section"].forEach(cid=>{
        const el = document.getElementById(cid);
        if (!el) return;
        if (cid===id) el.classList.add("active");
        else el.classList.remove("active");
      });
    };

    const showCol = (id) => {
      document.getElementById("col-1-section").classList.add("hidden");
      document.getElementById("col-2-section").classList.add("hidden");
      document.getElementById("col-3-section").classList.add("hidden");
      document.getElementById(id).classList.remove("hidden");
    };

    const setActiveNav = (id) => {
      ["nav-col-1","nav-col-2","nav-contacts"].forEach(n=>{
        const el = document.getElementById(n);
        el.classList.replace("text-blue-600","text-gray-500");
      });
      document.getElementById(id).classList.replace("text-gray-500","text-blue-600");
    };

    const selectClass = (classId, className) => {
      currentClassId = classId; currentStudentId = null;
      document.querySelectorAll("#col-1-list > div").forEach(el=>{
        el.classList.toggle("bg-blue-50", el.dataset.id===classId);
        el.classList.toggle("border-blue-300", el.dataset.id===classId);
      });
      document.getElementById("col-2-subtitle").textContent = `For: ${className}`;
      document.getElementById("add-new-student-btn").disabled = false;
      document.getElementById("add-existing-student-btn").disabled = false;
      renderStudentDropdown();
      renderCol2StudentList(classId);
      resetCol3();
      showCol("col-2-section"); setActiveNav("nav-col-2");
    };

    const selectStudent = (studentId, studentName) => {
      currentStudentId = studentId;
      document.querySelectorAll("#col-1-list > div, #col-2-list > div").forEach(el=>{
        el.classList.toggle("bg-blue-50", el.dataset.id===studentId);
        el.classList.toggle("border-blue-300", el.dataset.id===studentId);
      });
      document.getElementById("contact-student-subtitle").textContent = `For: ${studentName}`;
      document.getElementById("add-contact-btn").disabled = false;
      listenForContacts(studentId);
      if (currentView==="student"){
        document.getElementById("col-2-subtitle").textContent = `For: ${studentName}`;
        renderCol2ClassList(studentId);
      }
      showCol("col-3-section"); setActiveNav("nav-contacts");
      const list = document.getElementById("contact-list");
      if (list) list.scrollIntoView({behavior:"smooth", block:"start"});
      // keep Stripe panel in sync
      refreshStripePanel();
    };

    // ------- CRUD handlers -------
    const handleAddClass = async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
      const name = document.getElementById("class-name").value;
      const teacher = document.getElementById("teacher-name").value;
      try{
        await addDoc(getClassesCol(), {name, teacher, students: []});
        closeModal("add-class-modal"); e.target.reset(); toast("Class added!");
      }catch(err){ console.error(err); toast("Failed: "+err.message,"error"); }
      finally{ btn.disabled=false; }
    };

    const handleUpdateClass = async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
      const id = document.getElementById("edit-class-id").value;
      const name = document.getElementById("edit-class-name").value;
      const teacher = document.getElementById("edit-teacher-name").value;
      if (!id || !name || !teacher){ btn.disabled=false; toast("Missing fields","error"); return;}
      try{
        await updateDoc(doc(getClassesCol(), id), {name, teacher});
        closeModal("edit-class-modal"); toast("Class updated!");
      }catch(err){ console.error(err); toast("Update failed: "+err.message,"error"); }
      finally{ btn.disabled=false; }
    };

    const handleDeleteClass = async (classId, className) => {
      if (!confirm(`Delete class "${className}"?`)) return;
      try{
        const batch = writeBatch(db);
        const c = allClassCache.find(x=>x.id===classId);
        if (c?.students){
          const refs = c.students.map(id=>doc(getStudentsCol(), id));
          const snaps = await Promise.all(refs.map(getDoc));
          snaps.forEach(snap=>{
            if (snap.exists()) batch.update(snap.ref, {classes: arrayRemove(classId)});
          });
        }
        batch.delete(doc(getClassesCol(), classId));
        await batch.commit(); toast("Class deleted.");
        if (currentClassId===classId){ resetCol2(); resetCol3(); }
      }catch(err){ console.error(err); toast("Failed to delete class","error"); }
    };

    const handleAddNewStudent = async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
      const name = document.getElementById("new-student-name").value;
      try{
        const sRef = await addDoc(getStudentsCol(), {name, parents:[], classes:[]});
        if (currentView==="class" && currentClassId){
          const batch = writeBatch(db);
          batch.update(doc(getClassesCol(), currentClassId), {students: arrayUnion(sRef.id)});
          batch.update(sRef, {classes: arrayUnion(currentClassId)});
          await batch.commit();
        }
        closeModal("add-new-student-modal"); e.target.reset(); toast("Student added!");
      }catch(err){ console.error(err); toast("Failed to add student","error"); }
      finally{ btn.disabled=false; }
    };

    const handleUpdateStudent = async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
      const id = document.getElementById("edit-student-id").value;
      const name = document.getElementById("edit-student-name").value;
      if (!id || !name){ btn.disabled=false; toast("Missing name","error"); return; }
      try{
        await updateDoc(doc(getStudentsCol(), id), {name});
        closeModal("edit-student-modal"); toast("Student updated!");
      }catch(err){ console.error(err); toast("Update failed: "+err.message,"error"); }
      finally{ btn.disabled=false; }
    };

    const handleAddExistingStudent = async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
      const studentId = document.getElementById("existing-student-select").value;
      if (!studentId || !currentClassId){ btn.disabled=false; return; }
      try{
        const batch = writeBatch(db);
        batch.update(doc(getClassesCol(), currentClassId), {students: arrayUnion(studentId)});
        batch.update(doc(getStudentsCol(), studentId), {classes: arrayUnion(currentClassId)});
        await batch.commit();
        closeModal("add-existing-student-modal"); e.target.reset(); toast("Student added to class!");
      }catch(err){ console.error(err); toast("Failed to add student","error"); }
      finally{ btn.disabled=false; }
    };

    const handleRemoveStudent = async (studentId, studentName) => {
      if (!currentClassId || !confirm(`Remove ${studentName} from this class?`)) return;
      try{
        const batch = writeBatch(db);
        batch.update(doc(getClassesCol(), currentClassId), {students: arrayRemove(studentId)});
        batch.update(doc(getStudentsCol(), studentId), {classes: arrayRemove(currentClassId)});
        await batch.commit(); toast("Student removed.");
        if (currentStudentId===studentId) resetCol3();
      }catch(err){ console.error(err); toast("Failed to remove student","error"); }
    };

    const handleDeleteStudent = async (studentId, studentName) => {
      if (!confirm(`PERMANENTLY DELETE ${studentName}? This will remove them from all classes and delete all their contacts.`)) return;
      try{
        const batch = writeBatch(db);
        const sRef = doc(getStudentsCol(), studentId);
        const sSnap = await getDoc(sRef);
        if (sSnap.exists()){
          const data = sSnap.data();
          if (data.parents) data.parents.forEach(pid=>batch.delete(doc(getParentsCol(), pid)));
          if (data.classes) data.classes.forEach(cid=>batch.update(doc(getClassesCol(), cid), {students: arrayRemove(studentId)}));
        }
        batch.delete(sRef);
        await batch.commit(); toast("Student deleted.");
        if (currentStudentId===studentId){ resetCol2(); resetCol3(); }
      }catch(err){ console.error(err); toast("Failed to delete student","error"); }
    };

    const handleAddContact = async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
      const name = document.getElementById("contact-name").value;
      const email = document.getElementById("contact-email").value;
      const phone = document.getElementById("contact-phone").value;
      if (!name || !email || !currentStudentId){ btn.disabled=false; return; }
      try{
        const pRef = await addDoc(getParentsCol(), {name,email,phone});
        await updateDoc(doc(getStudentsCol(), currentStudentId), {parents: arrayUnion(pRef.id)});
        closeModal("add-contact-modal"); e.target.reset(); toast("Contact added!");
      }catch(err){ console.error(err); toast("Failed to add contact","error"); }
      finally{ btn.disabled=false; }
    };

    const handleUpdateContact = async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
      const id = document.getElementById("edit-contact-id").value;
      const name = document.getElementById("edit-contact-name").value;
      const email = document.getElementById("edit-contact-email").value;
      const phone = document.getElementById("edit-contact-phone").value;
      if (!id || !name || !email){ btn.disabled=false; toast("Missing name or email","error"); return; }
      try{
        await updateDoc(doc(getParentsCol(), id), {name,email,phone});
        closeModal("edit-contact-modal"); toast("Contact updated!");
      }catch(err){ console.error(err); toast("Update failed: "+err.message,"error"); }
      finally{ btn.disabled=false; }
    };

    const handleDeleteContact = async (contactId, contactName) => {
      if (!currentStudentId || !confirm(`Delete contact ${contactName}?`)) return;
      try{
        const batch = writeBatch(db);
        batch.update(doc(getStudentsCol(), currentStudentId), {parents: arrayRemove(contactId)});
        batch.delete(doc(getParentsCol(), contactId));
        await batch.commit(); toast("Contact deleted.");
      }catch(err){ console.error(err); toast("Failed to delete contact","error"); }
    };

    // ------- Emailing -------
    const openEmailModal = ({to, bcc}) => {
      const toEl = document.getElementById("email-to");
      const bccEl = document.getElementById("email-bcc");
      const replyToEl = document.getElementById("reply-to-email");
      replyToEl.textContent = currentUser?.displayName || currentUser?.email || "Unknown";

      if (to){
        toEl.value = to;
        document.getElementById("email-to-wrapper").classList.remove("hidden");
        bccEl.value = ""; document.getElementById("email-bcc-wrapper").classList.add("hidden");
      } else if (bcc){
        toEl.value = "";
        document.getElementById("email-to-wrapper").classList.add("hidden");
        bccEl.value = `BCC: ${bcc.length} recipient(s)`;
        document.getElementById("email-bcc-wrapper").classList.remove("hidden");
      }

      document.getElementById("email-subject").value = "";
      document.getElementById("email-body").value = "";
      document.getElementById("email-status").textContent = "";
      document.getElementById("send-email-btn").disabled = false;
      openModal("email-modal");
    };

    const handleEmailClass = async () => {
      if (!currentClassId) return;
      const c = allClassCache.find(x=>x.id===currentClassId);
      if (!c?.students?.length){ toast("No students in class","error"); return; }
      const studentIds = c.students;
      const parentIds = allStudentsCache.filter(s=>studentIds.includes(s.id)).flatMap(s=>s.parents||[]);
      if (parentIds.length===0){ toast("No parent contacts found","error"); return; }
      const unique = [...new Set(parentIds)];
      try{
        const contacts = [];
        for (let i=0;i<unique.length;i+=30){
          const chunk = unique.slice(i,i+30); if (!chunk.length) continue;
          const qy = query(getParentsCol(), where("__name__","in",chunk));
          const qs = await getDocs(qy); qs.docs.forEach(d=>contacts.push(d.data()));
        }
        const bccEmails = contacts.map(c=>c.email).filter(Boolean);
        if (!bccEmails.length){ toast("No valid emails found","error"); return; }
        openEmailModal({ bcc:bccEmails });
      }catch(err){ console.error(err); toast("Failed to build BCC","error"); }
    };

    const handleSendEmail = async (e) => {
      e.preventDefault();
      const btn = document.getElementById("send-email-btn");
      const status = document.getElementById("email-status");
      btn.disabled = true; status.textContent = "Sendingâ€¦";

      const to = document.getElementById("email-to").value;
      const isBccMode = document.getElementById("email-bcc-wrapper").classList.contains("hidden")===false;
      const subject = document.getElementById("email-subject").value;
      const text = document.getElementById("email-body").value;

      const replyToEmail = currentUser?.email || null;
      const replyToName  = currentUser?.displayName || replyToEmail;

      let bccList = null;
      if (isBccMode){
        try{
          const c = allClassCache.find(x=>x.id===currentClassId);
          const studentIds = c.students;
          const parentIds = allStudentsCache.filter(s=>studentIds.includes(s.id)).flatMap(s=>s.parents||[]);
          const unique = [...new Set(parentIds)];
          const contacts = [];
          for (let i=0;i<unique.length;i+=30){
            const chunk = unique.slice(i,i+30); if (!chunk.length) continue;
            const qy = query(getParentsCol(), where("__name__","in",chunk));
            const qs = await getDocs(qy); qs.docs.forEach(d=>contacts.push(d.data()));
          }
          bccList = contacts.map(c=>c.email).filter(Boolean);
        }catch(err){ console.error(err); toast("Failed build BCC list","error"); status.textContent="Failed."; btn.disabled=false; return;}
      }

      const payload = {
        to: to || null,
        bcc: bccList,
        replyTo: { email: replyToEmail, name: replyToName },
        subject,
        text
      };

      try{
        const res = await fetch(`${HARDCODED_CONFIG.serverUrl}/send-email`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const out = await res.json().catch(()=> ({}));
        if (!res.ok){ throw new Error(out?.error || `Server ${res.status}`); }
        toast("Email sent!");
        status.textContent = "Sent!";
        setTimeout(()=> closeModal("email-modal"), 900);
      }catch(err){ console.error(err); toast(`Failed: ${err.message}`,"error"); status.textContent = "Failed."; }
      finally{ btn.disabled=false; }
    };

    // ------- User admin (minimal glue that calls server endpoints you already have) -------
    const openUserManagementModal = async () => { openModal("user-management-modal"); await fetchUsers(); };
    const fetchUsers = async () => {
      const list = document.getElementById("user-list");
      list.innerHTML = '<p class="text-gray-500">Loading users...</p>';
      if (!currentUser){ list.innerHTML='<p class="text-red-500">Not authenticated.</p>'; return; }
      try{
        const idToken = await getIdToken(currentUser);
        const res = await fetch(`${HARDCODED_CONFIG.serverUrl}/list-users`,{
          headers: { Authorization: `Bearer ${idToken}` }
        });
        const { users=[] } = await res.json();
        renderUserList(users);
      }catch(e){ list.innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; }
    };
    const renderUserList = (users=[]) => {
      const list = document.getElementById("user-list");
      list.innerHTML = "";
      if (!users.length){ list.innerHTML = '<p class="text-gray-500 text-center">No other users found.</p>'; return;}
      const sorted = [...users].sort((a,b)=>{
        if (a.uid===userId) return -1;
        if (b.uid===userId) return 1;
        return (a.email||"").localeCompare(b.email||"");
      });
      sorted.forEach(u=>{
        const el = document.createElement("div");
        el.className = "p-3 rounded-lg border border-gray-200 flex justify-between items-center gap-4";
        const adminBadge = u.isAdmin ? '<span class="text-xs font-medium text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded-full">Admin</span>' : '';
        el.innerHTML = `
          <div class="flex-1 min-w-0">
            <span class="font-medium text-gray-800 block truncate">${u.displayName || u.email || 'No Email'}</span>
            ${u.displayName ? `<span class="text-xs text-gray-500 block truncate">${u.email||''}</span>` : ''}
            <span class="text-xs text-gray-500 block truncate">(UID: ${u.uid})</span>
          </div>
          <div class="flex items-center gap-2 flex-shrink-0">
            ${adminBadge}
          </div>`;
        list.appendChild(el);
      });
    };

    // ------- Stripe Multi-Org (front-end) -------
    const stripeOrgSelect = document.getElementById("stripe-org-select");

    async function getSelectedOrg(){ return stripeOrgSelect.value; }

    async function getMappedCustomerId(studentId, orgId){
      // read mapping from the student's doc in THIS app org collection
      const sRef = doc(getStudentsCol(), studentId);
      const snap = await getDoc(sRef);
      if (!snap.exists()) return null;
      return snap.data()?.stripe?.customers?.[orgId] || null;
    }

    async function refreshStripePanel(){
      const statusEl = document.getElementById("stripe-org-map-status");
      const actions  = document.getElementById("stripe-mapped-actions");
      if (!currentStudentId){ statusEl.textContent="No student selected"; actions.classList.add("hidden"); return; }
      statusEl.textContent="Checkingâ€¦";
      const orgId = await getSelectedOrg();
      const customerId = await getMappedCustomerId(currentStudentId, orgId);
      if (customerId){ statusEl.textContent = `${orgId}: ${customerId}`; actions.classList.remove("hidden"); }
      else { statusEl.textContent = `${orgId}: Not mapped`; actions.classList.add("hidden"); }
    }
    window.refreshStripePanel = refreshStripePanel;

    async function stripeSearch(q, orgId){
      const token = await getIdToken(currentUser);
      const url = `${HARDCODED_CONFIG.serverUrl}/stripe/search-customers?orgId=${encodeURIComponent(orgId)}&q=${encodeURIComponent(q)}`;
      const res = await fetch(url,{ headers:{ Authorization:`Bearer ${token}` }});
      return res.json();
    }
    async function stripeMap(customerId, orgId){
      const token = await getIdToken(currentUser);
      const res = await fetch(`${HARDCODED_CONFIG.serverUrl}/stripe/map-customer`,{
        method:"POST",
        headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` },
        body: JSON.stringify({ orgId, studentId: currentStudentId, customerId })
      });
      return res.json();
    }

    document.getElementById("stripe-search-form").addEventListener("submit", async e=>{
      e.preventDefault();
      const q = document.getElementById("stripe-search-q").value.trim();
      const orgId = await getSelectedOrg();
      const wrap = document.getElementById("stripe-search-results");
      wrap.innerHTML = "Searchingâ€¦";
      try{
        const { data=[] } = await stripeSearch(q, orgId);
        wrap.innerHTML = "";
        data.forEach(c=>{
          const row = document.createElement("div");
          row.className = "p-2 border rounded-md flex justify-between items-center";
          row.innerHTML = `
            <div>
              <div class="font-medium">${c.name || "(no name)"}</div>
              <div class="text-sm">${c.email || ""}</div>
              <div class="text-xs text-gray-500">${c.id}</div>
            </div>
            <button class="bg-green-600 text-white px-2 py-1 rounded map-btn">Map</button>`;
          row.querySelector(".map-btn").addEventListener("click", async ()=>{
            const out = await stripeMap(c.id, orgId);
            if (out?.error){ toast(out.error,"error"); return; }
            toast("Mapped successfully!");
            refreshStripePanel();
          });
          wrap.appendChild(row);
        });
      }catch(err){ console.error(err); wrap.innerHTML = `<p class="text-red-600 text-sm">Error: ${err.message}</p>`; }
    });

    document.getElementById("stripe-list-invoices-btn").addEventListener("click", async ()=>{
      const orgId = await getSelectedOrg();
      const cid = await getMappedCustomerId(currentStudentId, orgId);
      if (!cid) return toast("Not mapped to this org");
      const token = await getIdToken(currentUser);
      const url = `${HARDCODED_CONFIG.serverUrl}/stripe/list-invoices?orgId=${encodeURIComponent(orgId)}&customerId=${encodeURIComponent(cid)}`;
      const res = await fetch(url,{ headers:{ Authorization:`Bearer ${token}` }});
      const { data=[] } = await res.json();
      const wrap = document.getElementById("stripe-invoices");
      const body = document.getElementById("stripe-invoices-body");
      body.innerHTML=""; wrap.classList.remove("hidden");
      data.forEach(i=>{
        const row = document.createElement("div");
        row.className = "p-2 border rounded";
        row.innerHTML = `
          <div class="font-medium">${i.number || i.id}</div>
          <div class="text-xs">${i.status}</div>
          ${i.hostedInvoiceUrl ? `<a href="${i.hostedInvoiceUrl}" target="_blank" class="text-blue-600">View</a>` : ""}
        `;
        body.appendChild(row);
      });
    });

    document.getElementById("stripe-list-subs-btn").addEventListener("click", async ()=>{
      const orgId = await getSelectedOrg();
      const cid = await getMappedCustomerId(currentStudentId, orgId);
      if (!cid) return toast("Not mapped to this org");
      const token = await getIdToken(currentUser);
      const url = `${HARDCODED_CONFIG.serverUrl}/stripe/list-subscriptions?orgId=${encodeURIComponent(orgId)}&customerId=${encodeURIComponent(cid)}`;
      const res = await fetch(url,{ headers:{ Authorization:`Bearer ${token}` }});
      const { data=[] } = await res.json();
      const wrap = document.getElementById("stripe-subs");
      const body = document.getElementById("stripe-subs-body");
      body.innerHTML=""; wrap.classList.remove("hidden");
      data.forEach(s=>{
        const row = document.createElement("div");
        row.className = "p-2 border rounded";
        row.innerHTML = `
          <div class="font-medium">${s.id}</div>
          <div class="text-xs">${s.status}</div>`;
        body.appendChild(row);
      });
    });

    stripeOrgSelect.addEventListener("change", refreshStripePanel);

    // ------- Invoice modal helpers (Stripe create-invoice is on server already) -------
    const openInvoiceModal = (parentId, parentName) => {
      document.getElementById("invoice-parent-id").value = parentId;
      document.querySelector("#invoice-subtitle span").textContent = parentName;
      document.getElementById("invoice-amount").value = "";
      document.getElementById("invoice-description").value = "";
      document.getElementById("invoice-status").textContent = "";
      document.getElementById("create-invoice-btn").disabled = false;
      openModal("invoice-modal");
    };

    const handleCreateInvoice = async (e) => {
      e.preventDefault();
      const btn = document.getElementById("create-invoice-btn");
      const statusEl = document.getElementById("invoice-status");
      btn.disabled = true; statusEl.textContent = "Creating invoiceâ€¦";
      const amount = document.getElementById("invoice-amount").value;
      const description = document.getElementById("invoice-description").value;

      if (!currentStudentId){ statusEl.textContent="Select a student first."; statusEl.classList.add("text-red-600"); btn.disabled=false; return; }

      // Which org to bill? Use the current dropdown selection.
      const orgId = await getSelectedOrg();

      try{
        const idToken = await getIdToken(currentUser);
        const res = await fetch(`${HARDCODED_CONFIG.serverUrl}/stripe/create-invoice`,{
          method:"POST",
          headers:{ "Content-Type":"application/json", Authorization:`Bearer ${idToken}` },
          body: JSON.stringify({ orgId, studentId: currentStudentId, amount, description })
        });
        const out = await res.json();
        if (!res.ok) throw new Error(out.error || `Server ${res.status}`);
        toast("Invoice created!");
        statusEl.textContent = `Created ${out.invoiceId} (${out.status}).`;
        statusEl.classList.add("text-green-600");
        if (out.hostedInvoiceUrl){
          const a = document.createElement("a"); a.href=out.hostedInvoiceUrl; a.target="_blank"; a.className="text-blue-600 ml-1";
          a.textContent = "View Invoice";
          statusEl.appendChild(a);
        }
        setTimeout(()=>closeModal("invoice-modal"), 2500);
      }catch(err){
        console.error(err);
        statusEl.textContent = `Error: ${err.message}`; statusEl.classList.add("text-red-600");
        toast("Failed to create invoice","error");
      }
    };

    // ------- Auth init -------
    document.addEventListener("DOMContentLoaded", () => {
      // sanity-check config
      const f = HARDCODED_CONFIG.firebase;
      if (!f.apiKey || !f.appId || !HARDCODED_CONFIG.serverUrl || !HARDCODED_CONFIG.organizationId || !f.projectId || !f.authDomain){
        document.body.innerHTML = `<div class="p-8 text-center text-red-600">
          <h1 class="text-2xl font-bold">Config Error</h1>
          <p class="mt-4">Please fill in all values in <strong>HARDCODED_CONFIG</strong>.</p></div>`;
        return;
      }

      // Firebase init
      const app = initializeApp(f);
      db = getFirestore(app);
      auth = initializeAuth(app, { persistence: browserLocalPersistence });

      onAuthStateChanged(auth, async (user)=>{
        currentUser = user;
        if (user){
          userId = user.uid;
          document.getElementById("user-email-display").textContent = user.displayName || user.email;
          try{
            const res = await getIdTokenResult(user, true);
            isAdmin = res.claims.admin === true;
            document.getElementById("manage-users-btn").classList.toggle("hidden", !isAdmin);
            document.getElementById("user-admin-status").classList.toggle("hidden", !isAdmin);
          }catch(e){ console.error(e); isAdmin=false; }

          document.getElementById("app-shell").style.display = "flex";
          document.getElementById("auth-screen").style.display = "none";
          listenForClasses(); listenForAllStudents(); renderViewByClass();
        }else{
          userId = null; isAdmin=false; currentUser=null;
          document.getElementById("app-shell").style.display = "none";
          document.getElementById("auth-screen").style.display = "flex";
          if (unsubscribeClasses) unsubscribeClasses();
          if (unsubscribeAllStudents) unsubscribeAllStudents();
          if (unsubscribeContacts) unsubscribeContacts();
          allClassCache=[]; allStudentsCache=[]; contactCache.clear();
          document.getElementById("manage-users-btn").classList.add("hidden");
          document.getElementById("user-admin-status").classList.add("hidden");
        }
      });

      // Events
      document.getElementById("login-form").addEventListener("submit", (e)=>{
        e.preventDefault();
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        const errEl = document.getElementById("login-error");
        const btn = document.getElementById("login-btn");
        btn.disabled = true; errEl.textContent = "";
        signInWithEmailAndPassword(auth, email, password)
          .catch(err=>{ errEl.textContent = (err.message||"").replace('Firebase: ',''); })
          .finally(()=>{ btn.disabled=false; });
      });
      document.getElementById("sign-out-btn").addEventListener("click", ()=>{
        if (unsubscribeClasses) unsubscribeClasses();
        if (unsubscribeAllStudents) unsubscribeAllStudents();
        if (unsubscribeContacts) unsubscribeContacts();
        signOut(auth).catch(err=>{ console.error(err); toast("Sign out failed","error"); });
      });
      document.getElementById("manage-users-btn").addEventListener("click", openUserManagementModal);

      document.getElementById("view-by-class").addEventListener("click", renderViewByClass);
      document.getElementById("view-by-student").addEventListener("click", renderViewByStudent);
      document.getElementById("email-class-btn").addEventListener("click", handleEmailClass);
      document.querySelectorAll(".close-modal-btn").forEach(btn=>btn.addEventListener("click", ()=>closeModal(btn.dataset.modal)));

      document.getElementById("add-user-form").addEventListener("submit", (e)=>e.preventDefault()); // display only

      document.getElementById("add-class-form").addEventListener("submit", handleAddClass);
      document.getElementById("edit-class-form").addEventListener("submit", handleUpdateClass);

      document.getElementById("add-new-student-form").addEventListener("submit", handleAddNewStudent);
      document.getElementById("edit-student-form").addEventListener("submit", handleUpdateStudent);
      document.getElementById("add-existing-student-form").addEventListener("submit", handleAddExistingStudent);

      document.getElementById("add-contact-form").addEventListener("submit", handleAddContact);
      document.getElementById("edit-contact-form").addEventListener("submit", handleUpdateContact);

      document.getElementById("create-invoice-form").addEventListener("submit", handleCreateInvoice);

      document.getElementById("col-1-add-btn").addEventListener("click", ()=> openModal(currentView==="class" ? "add-class-modal" : "add-new-student-modal"));
      document.getElementById("add-new-student-btn").addEventListener("click", ()=> openModal("add-new-student-modal"));
      document.getElementById("add-existing-student-btn").addEventListener("click", ()=>{
        document.querySelector("#add-existing-student-subtitle span").textContent = allClassCache.find(c=>c.id===currentClassId)?.name || "";
        renderStudentDropdown(); openModal("add-existing-student-modal");
      });
      document.getElementById("add-contact-btn").addEventListener("click", ()=>{
        document.querySelector("#add-contact-subtitle span").textContent = allStudentsCache.find(s=>s.id===currentStudentId)?.name || "";
        openModal("add-contact-modal");
      });

      // Mobile tabs
      document.getElementById("nav-col-1").addEventListener("click", ()=>{ setActiveTab("col-1-section"); setActiveNav("nav-col-1"); });
      document.getElementById("nav-col-2").addEventListener("click", ()=>{ setActiveTab("col-2-section"); setActiveNav("nav-col-2"); });
      document.getElementById("nav-contacts").addEventListener("click", ()=>{ setActiveTab("col-3-section"); setActiveNav("nav-contacts"); });

      // Expose for console
      window.auth = auth;
    });
  </script>
</body>
</html>